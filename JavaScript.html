<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<!-- DataTables Select JS -->
<script src="https://cdn.datatables.net/select/1.7.0/js/dataTables.select.min.js"></script>
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- SheetJS for Excel file reading -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
// =================================================================
// GLOBAL VARIABLES & INITIALIZATION
// =================================================================
let userSession = { isLoggedIn: false, role: null, contractor: null, token: null };
let inactivityTimer;
let registeredVehicleTable, totalListTable, usersTable;
let loginHistoryTable, vehicleHistoryTable;
let wrResultTable, wrUnknownTable;
let previewDataTable, totalListPreviewTable;
let previewTableData = [], totalListPreviewData = [];
let allowedCompanies = [];
let registrationTimerInterval = null;
let registrationStatusFetchInFlight = false;
let lastRegistrationStatusFetch = 0;
const REGISTRATION_STATUS_REFRESH_MS = 5000;
let registrationCountdownTargets = { close: null, open: null };
let currentLang = 'en'; // Ngôn ngữ mặc định
let $loaderWrapper = null;
let $appContainer = null;
let loginTemplateHTML = '';
let loginFallbackTimer = null;
let sessionCheckCompleted = false;
let sessionRestoreInProgress = false;
let lastXpplDateString = '';

const PAGE_CACHE_TTL_MS = 5 * 60 * 1000; // 5 phút cho mỗi trang
const pageCache = new Map();
const PAGE_INITIALIZERS = {
    'Page_Guide': initGuidePage,
    'Page_Register': initRegisterPage,
    'Page_View': initViewPage,
    'Page_TotalList': initTotalListPage,
    'Page_Account': initAccountPage,
    'Page_Contract': initContractPage,
    'XPPL-WeighingStation': initXPPLWeighingStationPage,
    'Page_WeighResult': initWeighResultPage,
    'Page_XuLyXPPL': initXuLyXPPLPage,
    'Page_LoginHistory': initLoginHistoryPage,
    'Page_VehicleHistory': initVehicleHistoryPage
};

const SESSION_FLAG_KEY = 'psvn_isLoggedIn';
const SESSION_STORAGE_KEY = 'psvn_userSession';
const DEFAULT_RETRY_ATTEMPTS = 3;
const DEFAULT_RETRY_DELAY = 700;
const MAX_RETRY_DELAY = 5000;
const VIETNAM_TIMEZONE = 'Asia/Ho_Chi_Minh';

let wrReloadTimer = null;

let serverBusyToastEl = null;
let serverBusyToastTimer = null;

let vietnamTimeState = null;
let vietnamTimePromise = null;

if (typeof window !== 'undefined' && typeof window.addEventListener === 'function') {
    window.addEventListener('storage', handleStorageEvent);
}

function parseStoredSession(raw) {
    if (!raw) return null;
    try {
        const parsed = JSON.parse(raw);
        if (parsed && parsed.isLoggedIn && parsed.token) {
            return parsed;
        }
    } catch (err) {
        // ignore and fall through to clear
    }
    return null;
}

function getStoredSession() {
    try {
        const raw = sessionStorage.getItem(SESSION_STORAGE_KEY);
        const parsed = parseStoredSession(raw);
        if (parsed) {
            return parsed;
        }        
    } catch (err) {
        clearStoredSession();
    }

    try {
        const raw = localStorage.getItem(SESSION_STORAGE_KEY);
        const parsed = parseStoredSession(raw);
        if (parsed) {
            persistUserSession(parsed, { persistLocal: false });
            return parsed;
        }
    } catch (err) {
        clearStoredSession({ persistLocal: true });
    }

    return null;
}

function persistUserSession(session, options = {}) {
    const persistLocal = options.persistLocal !== false;
    if (session && session.isLoggedIn && session.token) {
        const serialized = JSON.stringify(session);      
        try {
            sessionStorage.setItem(SESSION_STORAGE_KEY, serialized);
        } catch (err) {
            // Ignore storage errors (e.g., private mode)
        }
        if (persistLocal) {
            try {
                localStorage.setItem(SESSION_STORAGE_KEY, serialized);
            } catch (err) {
                // Ignore storage errors
            }
        }        
    } else {
        clearStoredSession({ persistLocal });
    }
}

function clearStoredSession(options = {}) {
    const persistLocal = options.persistLocal !== false;
    try {
        sessionStorage.removeItem(SESSION_STORAGE_KEY);
    } catch (err) { /* ignore */ }
    if (persistLocal) {
        try {
            localStorage.removeItem(SESSION_STORAGE_KEY);
        } catch (err) { /* ignore */ }
    }
}

function setSessionFlag(options = {}) {
    const persistLocal = options.persistLocal !== false;
    try {
        sessionStorage.setItem(SESSION_FLAG_KEY, '1');
    } catch (err) { /* ignore */ }
    if (persistLocal) {
        try {
            localStorage.setItem(SESSION_FLAG_KEY, '1');
        } catch (err) { /* ignore */ }
    }
}

function clearSessionFlag(options = {}) {
    const persistLocal = options.persistLocal !== false;
    try {
        sessionStorage.removeItem(SESSION_FLAG_KEY);
    } catch (err) { /* ignore */ }
    if (persistLocal) {
        try {
            localStorage.removeItem(SESSION_FLAG_KEY);
        } catch (err) { /* ignore */ }
    }
}

function hasStoredSessionFlag() {
    try {
        if (sessionStorage.getItem(SESSION_FLAG_KEY)) {
            return true;
        }
    } catch (err) { /* ignore */ }
    try {
        return !!localStorage.getItem(SESSION_FLAG_KEY);
    } catch (err) {
        return false;
    }
}

function handleStorageEvent(event) {
    if (!event) return;

    if (event.key === SESSION_STORAGE_KEY) {
        const newValue = event.newValue;
        if (!newValue) {
            clearStoredSession({ persistLocal: false });
            clearSessionFlag({ persistLocal: false });
            if (userSession && userSession.isLoggedIn) {
                userSession = { isLoggedIn: false, role: null, contractor: null, token: null };
                if (typeof loadLoginPage === 'function') {
                    showLoader();
                    loadLoginPage();
                } else {
                    window.location.reload();
                }
            }
            return;
        }

        const parsed = parseStoredSession(newValue);
        if (!parsed) return;

        persistUserSession(parsed, { persistLocal: false });
        setSessionFlag({ persistLocal: false });
        const wasLoggedIn = userSession && userSession.isLoggedIn;
        userSession = parsed;
        if (!wasLoggedIn && typeof initializeApp === 'function') {
            initializeApp(parsed.token);
        }
        return;
    }

    if (event.key === SESSION_FLAG_KEY && !event.newValue) {
        clearSessionFlag({ persistLocal: false });
    }    
}

function ensureToastContainer() {
    let container = document.getElementById('app-toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'app-toast-container';
        container.setAttribute('role', 'status');
        container.setAttribute('aria-live', 'polite');
        const parent = document.body || document.documentElement;
        if (!parent) return null;
        parent.appendChild(container);
    }
    return container;
}

function closeServerBusyToast(immediate = false) {
    if (!serverBusyToastEl) return;
    const toast = serverBusyToastEl;
    if (serverBusyToastTimer) {
        clearTimeout(serverBusyToastTimer);
        serverBusyToastTimer = null;
    }

    const remove = () => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
        if (serverBusyToastEl === toast) {
            serverBusyToastEl = null;
        }
    };

    toast.classList.remove('show');
    toast.classList.add('closing');

    if (immediate) {
        remove();
        return;
    }

    const handleTransitionEnd = function (evt) {
        if (evt.target !== toast) return;
        toast.removeEventListener('transitionend', handleTransitionEnd);
        remove();
    };

    toast.addEventListener('transitionend', handleTransitionEnd);
    setTimeout(remove, 240);
}

function showServerBusyToast(options = {}) {
    const t = translations[currentLang] || translations.vi || {};
    const container = ensureToastContainer();
    if (!container) return;

    const title = options.title || t.server_busy_title || 'Máy chủ bận';
    let message = options.message || t.server_busy_message || 'Hệ thống đang xử lý quá nhiều yêu cầu. Vui lòng thử lại sau ít phút.';

    if (typeof options.retryIn === 'number' && options.retryIn > 0) {
        const seconds = Math.max(1, Math.round(options.retryIn / 1000));
        const template = t.server_busy_retrying || 'Hệ thống sẽ thử lại sau {seconds} giây...';
        const retryText = template.replace('{seconds}', seconds);
        message = `${message} ${retryText}`.trim();
    }

    if (!serverBusyToastEl || !serverBusyToastEl.isConnected) {
        serverBusyToastEl = document.createElement('div');
        serverBusyToastEl.className = 'app-toast info server-busy-toast';
        serverBusyToastEl.innerHTML = `
      <div class="toast-icon"><i class="fas fa-circle-notch fa-spin"></i></div>
      <div class="toast-content">
        <div class="toast-title"></div>
        <div class="toast-message"></div>
      </div>
      <button type="button" class="toast-close" aria-label="${esc(t.close_button || 'Đóng')}">&times;</button>
    `;
        container.appendChild(serverBusyToastEl);

        requestAnimationFrame(() => {
            if (serverBusyToastEl) {
                serverBusyToastEl.classList.add('show');
            }
        });

        const closeBtn = serverBusyToastEl.querySelector('.toast-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => closeServerBusyToast(true));
        }

        serverBusyToastEl.addEventListener('mouseenter', () => {
            if (serverBusyToastTimer) {
                clearTimeout(serverBusyToastTimer);
                serverBusyToastTimer = null;
            }
        });

        serverBusyToastEl.addEventListener('mouseleave', () => {
            if (!serverBusyToastEl || serverBusyToastEl.dataset.sticky === '1') return;
            if (!serverBusyToastTimer) {
                serverBusyToastTimer = setTimeout(() => closeServerBusyToast(), 2000);
            }
        });
    } else {
        serverBusyToastEl.classList.remove('closing');
        requestAnimationFrame(() => {
            if (serverBusyToastEl) {
                serverBusyToastEl.classList.add('show');
            }
        });
    }

    const titleNode = serverBusyToastEl.querySelector('.toast-title');
    if (titleNode) titleNode.textContent = title;

    const messageNode = serverBusyToastEl.querySelector('.toast-message');
    if (messageNode) messageNode.textContent = message;

    const iconNode = serverBusyToastEl.querySelector('.toast-icon i');
    if (iconNode) {
        iconNode.className = options.sticky ? 'fas fa-server' : 'fas fa-circle-notch fa-spin';
    }

    if (serverBusyToastTimer) {
        clearTimeout(serverBusyToastTimer);
        serverBusyToastTimer = null;
    }

    if (options.sticky) {
        serverBusyToastEl.dataset.sticky = '1';
    } else {
        serverBusyToastEl.dataset.sticky = '0';
        const duration = typeof options.duration === 'number' ? options.duration : 5000;
        if (duration > 0) {
            serverBusyToastTimer = setTimeout(() => closeServerBusyToast(), duration);
        }
    }
}

function getRawErrorMessage(error) {
    if (error == null) return '';
    if (typeof error === 'string') return error;
    if (typeof error.message === 'string') return error.message;
    if (typeof error.details === 'string') return error.details;
    try { return String(error); } catch (_) { return ''; }
}

function getCleanErrorMessage(error) {
    const raw = getRawErrorMessage(error);
    return raw ? raw.replace(/^Error:\s*/i, '').trim() : '';
}

function isTransientError(error) {
    const raw = getRawErrorMessage(error);
    if (!raw) return false;
    return /(http\s*503|service unavailable|networkerror|connection failure|server error)/i.test(raw);
}

function callServerWithRetry(methodName, args = [], options = {}) {
    if (!methodName || typeof google === 'undefined' || !google.script || !google.script.run) {
        return;
    }

    const {
        onSuccess,
        onFailure,
        attempts = DEFAULT_RETRY_ATTEMPTS,
        initialDelay = DEFAULT_RETRY_DELAY,
        backoff = 2,
        maxDelay = MAX_RETRY_DELAY,
        onRetry
    } = options || {};

    const callArgs = Array.isArray(args) ? args.slice() : [args];
    const totalAttempts = Math.max(1, attempts);
    let retryCount = 0;

    const execute = () => {
        let runner = google.script.run;

        runner = runner.withSuccessHandler(result => {
            closeServerBusyToast();
            if (typeof onSuccess === 'function') {
                onSuccess(result);
            }
        });

        runner = runner.withFailureHandler(err => {
            const shouldRetry = isTransientError(err) && retryCount < totalAttempts - 1;
            if (shouldRetry) {
                const wait = Math.min(maxDelay, Math.round(initialDelay * Math.pow(backoff, retryCount)));
                retryCount += 1;
                const displayDuration = Math.min(10000, Math.max(3500, wait + 1500));
                showServerBusyToast({ retryIn: wait, duration: displayDuration });                
                if (typeof onRetry === 'function') {
                    try { onRetry(retryCount, wait, err); } catch (retryErr) { console.error(retryErr); }
                } else {
                    const info = getCleanErrorMessage(err) || getRawErrorMessage(err) || 'Transient error';
                    console.warn(`Retrying ${methodName} due to transient error (attempt ${retryCount + 1}/${totalAttempts}) in ${wait}ms: ${info}`);
                }
                setTimeout(execute, wait);
            } else {
                if (!isTransientError(err)) {
                    closeServerBusyToast();
                }              
                if (typeof onFailure === 'function') {
                    onFailure(err);
                } else {
                    showError(err);
                }
            }
        });

        if (typeof runner[methodName] === 'function') {
            runner[methodName].apply(runner, callArgs);
        } else {
            const err = new Error(`google.script.run.${methodName} is not available`);
            if (typeof onFailure === 'function') {
                onFailure(err);
            } else {
                showError(err);
            }
        }
    };

    execute();
}

function normalizeRole(role) {
    return typeof role === 'string' ? role.trim().toLowerCase() : '';
}

function getUserRole() {
    return normalizeRole(userSession && userSession.role);
}

function getRoleDisplay() {
    if (!userSession) return '';
    return userSession.roleDisplay || userSession.role || '';
}

function isRole(role) {
    return getUserRole() === normalizeRole(role);
}

function hasAnyRole(roles) {
    const current = getUserRole();
    const list = Array.isArray(roles) ? roles : [roles];
    return list.some(r => normalizeRole(r) === current);
}

const SUPERVISION_ALLOWED_PAGES = new Set(['Page_View', 'Page_WeighResult', 'Page_Account']);

function getLoaderWrapper() {
    if (!$loaderWrapper || !$loaderWrapper.length) {
        $loaderWrapper = $('#loader-wrapper');
    }
    return $loaderWrapper;
}

function getAppContainer() {
    if (!$appContainer || !$appContainer.length) {
        $appContainer = $('#app-container');
    }
    return $appContainer;
}

function preloadLoginTemplate() {
    if (loginTemplateHTML) return;
    const template = document.getElementById('login-template');
    if (template) {
        loginTemplateHTML = template.innerHTML;
    }
}

function getCachedPage(pageName) {
    if (!pageName || !pageCache.has(pageName)) return null;
    const cached = pageCache.get(pageName);
    if (!cached || Date.now() - cached.timestamp > PAGE_CACHE_TTL_MS) {
        pageCache.delete(pageName);
        return null;
    }
    return cached.html;
}

function cachePageHtml(pageName, html) {
    if (!pageName || typeof html !== 'string') return;
    pageCache.set(pageName, { html, timestamp: Date.now() });
}

function invalidatePageCache(pageName) {
    if (!pageName) return;
    pageCache.delete(pageName);
}

function invalidateAllPageCache() {
    pageCache.clear();
}

function clearLoginFallbackTimer() {
    if (loginFallbackTimer) {
        clearTimeout(loginFallbackTimer);
        loginFallbackTimer = null;
    }
}

function scheduleLoginFallback(delay = 450) {
    clearLoginFallbackTimer();
    if (typeof delay !== 'number' || delay <= 0) {
        delay = 450;
    }
    loginFallbackTimer = setTimeout(() => {
        loginFallbackTimer = null;
        if (sessionCheckCompleted) {
            return;
        }
        if (sessionRestoreInProgress) {
            showLoader();
            return;
        }
        const hasLoginView = document.body && document.body.classList && document.body.classList.contains('login-view-active') && $('#loginForm').length;
        if (hasLoginView) {
            showApp();
            return;
        }
        if (!renderLoginTemplate()) {
            loadLoginPage();
        }
    }, delay);
}

// =================================================================
// **MỚI:** HỆ THỐNG DỊCH
// =================================================================
const translations = {
  vi: {
    // General
    "hello_user": "Xin chào, {username} ({role})",
    "logout_button": "Đăng xuất",
    "server_busy_title": "Máy chủ bận",
    "server_busy_message": "Hệ thống đang xử lý quá nhiều yêu cầu. Vui lòng thử lại sau ít phút.",
    "server_busy_retrying": "Hệ thống sẽ thử lại sau {seconds} giây...",
    "server_busy_final_message": "Máy chủ vẫn đang bận. Vui lòng thử lại thao tác sau ít phút.",
    "close_button": "Đóng",
    "save_changes_button": "Lưu thay đổi",
    "add_button": "Thêm",
    "edit_button": "Sửa",
    "delete_button": "Xóa",
    "reload_button": "Tải lại",
    "action_column": "Hành động",
    "file_choose_button": "Chọn tệp",
    "file_no_file_selected": "Không có tệp nào được chọn",
    "select_all_checkbox": "Chọn tất cả",    
    "show_label": "Hiển thị",
    "entries_label": "dòng",
    "sidebar_contracts": "Hợp đồng vận chuyển",
    "sidebar_vehicle": "Đăng Ký Xe",
    "sidebar_approval": "Phê Duyệt",
    "sidebar_weighing": "Trạm Cân",
    "sidebar_weighing_result": "Kết quả bốc hàng",
    "sidebar_account_parent": "Tài khoản",
    "sidebar_history_parent": "Lịch sử",
    "sidebar_login_history": "Lịch sử đăng nhập",
    "sidebar_vehicle_history": "Lịch sử đăng ký xe mới",
    "sidebar_guide": "Hướng dẫn",

    // Contracts Page
    "contract_entry_title": "Nhập hợp đồng",
    "contract_save_button": "Lưu",
    "contract_card_title": "Hợp đồng",
    "contract_search_placeholder": "Tìm trong danh sách...",
    "contract_loading_saving": "Đang lưu...",
    "contract_edit_title": "Sửa hợp đồng",
    "contract_loading_updating": "Đang cập nhật...",
    "contract_loading_deleting": "Đang xoá...",
    "contract_no_selection_title": "Chưa chọn dòng",
    "contract_no_selection_message": "Hãy tick các dòng cần xoá.",
    "contract_confirm_delete_title": "Xoá các mục đã chọn?",

    // Login Page
    "login_title": "Đăng nhập",
    "username_label": "Tên đăng nhập",
    "password_label": "Mật khẩu",
    "login_button": "Đăng nhập",
    "forgot_password_link": "Quên mật khẩu?",
    
    "continue_button": "Tiếp tục",
    "confirm_button": "Xác nhận",
    "forgot_password_input_label": "Vui lòng nhập tên đăng nhập của bạn",
    "forgot_password_input_placeholder": "Tên đăng nhập",
    "forgot_password_input_required": "Bạn cần nhập tên đăng nhập!",
    "reset_password_title": "Đặt lại mật khẩu",
    "reset_password_security_placeholder": "Mã bảo mật",
    "reset_password_new_placeholder": "Mật khẩu mới",
    "reset_password_confirm_placeholder": "Xác nhận mật khẩu mới",
    "reset_password_missing_fields": "Vui lòng điền đầy đủ thông tin",
    "reset_password_mismatch": "Mật khẩu mới không khớp",
    "loading_processing": "Đang xử lý...",
    "inactivity_title": "Thông báo:",
    "inactivity_message": "Bạn đã không sử dụng phần mềm quá lâu, vui lòng đăng nhập lại…",
    "login_again_button": "Đăng nhập lại",

    // Dashboard & Sidebar
    "sidebar_title": "Quản lý Xe",
    "sidebar_register": "Đăng ký mới",
    "sidebar_view": "Xe đã đăng ký",
																 
    "sidebar_total_list": "Danh sách xe tổng",
    "sidebar_account": "Quản lý User",

    // Account Page
    "change_password_header": "Đổi mật khẩu",
    "current_password_label": "Mật khẩu hiện tại",
    "new_password_label": "Mật khẩu mới",
    "confirm_new_password_label": "Xác nhận mật khẩu mới",
    "user_management_header": "Quản lý người dùng",
    "add_user_button": "Thêm người dùng",

    // Register Page
    "reg_open_message_text": "Hệ thống đăng ký bốc hàng sẽ đóng sau:",
    "reg_time_left": "Thời gian còn lại",
    "reg_closed_message_text": "Hệ thống đăng ký bốc hàng đang đóng.",
    "reg_readonly_notice": "Biểu mẫu đang ở trạng thái chỉ xem.",
    "reg_will_reopen": "Sẽ mở lại sau",
    "reg_manual_header": "Thêm mới một xe (Nhập liệu thủ công)",
    "reg_upload_header": "Thêm mới nhiều xe (Upload File)",
    "reg_upload_note": "Ghi chú: Chỉ chấp nhận các file có định dạng .xlsx, .xls, .csv.",
    "preview_data_button": "Xem trước dữ liệu",
    "preview_data_title": "Dữ liệu xem trước",
    "save_data_button": "Lưu dữ liệu",
    "register_vehicle_button": "Đăng ký xe",
    "select_company_option": "Chọn đơn vị",
    "reg_date_label": "Ngày đăng ký",
    "register_contract_placeholder": "Nhập hoặc chọn Số hợp đồng",
    "register_today_option": "Hôm nay ({date})",
    "register_tomorrow_option": "Ngày mai ({date})",
    "register_date_join_word": "hoặc",
    "register_upload_date_note_single": "File upload chỉ chấp nhận ngày đăng ký là {date}.",
    "register_upload_date_note_multi": "File upload chỉ chấp nhận ngày đăng ký là {dates}.",
    "register_missing_data_title": "Thiếu dữ liệu",
    "register_missing_data_message": "Vui lòng nhập Ngày đăng ký, Số hợp đồng và Biển số xe.",
    "loading_saving_data": "Đang lưu dữ liệu...",
    "register_success_message": "Đăng ký xe thành công!",
    "loading_processing_file": "Đang xử lý và xác thực file...",
    "no_file_selected_title": "Chưa chọn file",
    "no_file_selected_message": "Vui lòng chọn một file.",
    "upload_errors_intro": "Phát hiện lỗi trong file tải lên. Vui lòng sửa lại file Excel và thử lại. Các ô màu đỏ là các ô bị lỗi.",
    "upload_errors_more": "... và nhiều lỗi khác.",
    "invalid_data_title": "Dữ liệu không hợp lệ!",
    "file_no_data_error": "File không có dữ liệu.",
    "validation_required": "- Cột '{field}' không được để trống.",
    "validation_ambiguous_date": "- Cột '{field}' có định dạng ngày không xác định rõ (dd/MM/yyyy hay MM/dd/yyyy). Vui lòng kiểm tra lại.",    
    "validation_invalid_date": "- Cột '{field}' có định dạng ngày không hợp lệ.",
    "validation_only_tomorrow": "- Cột '{field}' chỉ chấp nhận ngày mai.",
    "validation_only_today_or_tomorrow": "- Cột '{field}' chỉ chấp nhận {dates}.",
    "validation_max_length": "- Cột '{field}' không được vượt quá {max} ký tự.",
    "validation_numeric_max": "- Cột '{field}' phải là số và không quá {max}.",
    "validation_numeric_only": "- Cột '{field}' phải là số.",
    "validation_allowed_values": "- Cột '{field}' chỉ chấp nhận: {values}.",
    "validation_contractor_mismatch": "- Bạn chỉ có thể đăng ký cho nhà thầu của mình ({contractor}).",
    "validation_row_label": "Dòng {row}",
    "duplicate_data_error": "Dữ liệu trùng lặp trong file.",
    "validation_duplicate_rows": "Dòng {row1} và {row2}",
    "validation_duplicate_details": "Trùng lặp dữ liệu (Ngày, Biển số xe, ĐVVC).",
    "no_valid_data_title": "Không có dữ liệu hợp lệ",
    "no_valid_data_message": "Không có dữ liệu nào để lưu.",
    "loading_checking_data": "Đang kiểm tra và lưu dữ liệu...",
    "combo_open_list_label": "Mở danh sách",

    // View Page
    "view_header": "Dữ liệu xe đã đăng ký",
    "search_in_table_placeholder": "Tìm kiếm trong bảng...",
    "export_excel_button": "Xuất Excel",
    "edit_rules_notice_line1": "<strong>Quy tắc chỉnh sửa:</strong><br>- Chỉ được chỉnh sửa/xóa dữ liệu từ <strong>07:00 - 16:00</strong>.",
    "edit_rules_notice_line2": "- Không được chỉnh sửa/xóa dữ liệu đã qua 1 ngày.",
    "edit_restricted_title": "Không thể thực hiện",
    "edit_restricted_time": "Bạn chỉ được chỉnh sửa hoặc xóa dữ liệu từ 07:00 - 16:00.",
    "edit_restricted_date": "Không thể chỉnh sửa hoặc xóa dữ liệu đã qua 1 ngày.",
    "edit_restricted_role": "Bạn không có quyền chỉnh sửa hoặc xóa dữ liệu này.",
    "view_filter_label": "Xem ngày",
    "view_today_label": "(Hôm nay)",
    "view_tomorrow_label": "(Ngày mai)",
    "view_filter_contract_label": "Số hợp đồng",
    "view_filter_contract_all": "Tất cả hợp đồng",
    "view_filter_contract_loading": "Đang tải...",
    "view_filter_contract_empty": "Không có hợp đồng trong ngày đã chọn",    
    "view_stat_total_label": "Tổng số xe đã đăng ký:",
    "view_stat_pending_label": "Tổng số xe chưa được phê duyệt:",
    "view_stat_approved_label": "Tổng số xe đã được phê duyệt:",
    "view_total_badge": "Tổng số xe đã đăng ký:",
    "no_selection_title": "Chưa chọn mục",
    "no_selection_message": "Vui lòng chọn ít nhất một mục để xóa.",
    "delete_selected_confirm_title": "Bạn có chắc muốn xóa {count} mục?",
    "delete_selected_confirm_text": "Hành động này không thể hoàn tác!",
    "cancel_button": "Hủy",
    "confirm_delete_button": "Vâng, xóa đi!",
    "loading_deleting": "Đang xóa...",
    "delete_success_title": "Đã xóa!",
    "loading_preparing_data": "Đang chuẩn bị dữ liệu...",
    "no_data_title": "Không có dữ liệu",
    "no_data_export_message": "Không có dữ liệu để xuất file.",
    "edit_vehicle_title": "Chỉnh sửa thông tin xe",
    "edit_validation_message": "Vui lòng điền đầy đủ và đúng định dạng các trường bắt buộc.",
    "loading_updating": "Đang cập nhật...",

    // History Pages
    "history_login_title": "Lịch sử đăng nhập",
    "history_vehicle_title": "Lịch sử đăng ký xe mới",
    "history_filter_date_from": "Từ ngày",
    "history_filter_date_to": "Đến ngày",
    "history_filter_contract": "Số hợp đồng",
    "history_filter_company": "Đơn vị vận chuyển",
    "history_filter_all": "Tất cả",
    "history_col_occurred_at": "Thời điểm đăng nhập",
    "history_col_outcome": "Kết quả",
    "history_col_ip": "Địa chỉ IP",
    "history_col_latitude": "Vĩ độ",
    "history_col_longitude": "Kinh độ",
    "history_col_accuracy": "Sai số (m)",
    "history_col_user_agent": "User Agent",
    "history_col_created_at": "Thời gian tạo",
    "history_col_action_type": "Loại hành động",
    "history_col_action_time": "Thời điểm hành động",
    "history_col_created_by": "Người thao tác",

    // Total List Page
    "total_list_upload_header": "Thêm mới danh sách xe (Upload File)",
    "total_list_upload_note": "Ghi chú: Chức năng này sẽ ghi đè toàn bộ danh sách xe hiện có. Chỉ chấp nhận file .xlsx, .xls, .csv.",
    "save_list_button": "Lưu danh sách",
    "total_list_header": "Danh sách xe tổng",
    "show_update_button": "Hiển thị/Cập nhật",
    "delete_selected_button": "Xóa mục đã chọn",
    "search_in_list_placeholder": "Tìm kiếm trong danh sách...",
    "total_vehicles": "Tổng số xe",
    "active_vehicles": "Xe đang hoạt động",
    "banned_vehicles": "Xe đang bị cấm",    

    // DataTables Columns
    "col_id": "ID",
    "col_register_date": "Ngày đăng ký",
    "col_contract_no": "Số hợp đồng",
    "col_truck_plate": "Biển số xe",
    "col_country": "Quốc gia",
    "col_wheel": "Số bánh",
    "col_trailer_plate": "Biển số Mooc",
    "col_truck_weight": "Trọng lượng xe",
    "col_payload": "Tải trọng xe",
    "col_container1": "Container 1",
    "col_container2": "Container 2",
    "col_driver_name": "Tên lái xe",
    "col_id_passport": "Số hộ chiếu",
    "col_phone_number": "Số điện thoại",
    "col_destination": "Điểm trả hàng dự kiến",
    "col_transport_company": "Đơn vị vận chuyển",
    "col_subcontractor": "Nhà thầu phụ",
    "col_vehicle_status": "Tình trạng xe",
    "col_activity_status": "Trạng thái hoạt động",    
    "col_registration_status": "Trạng thái đăng ký",
    "col_time": "Thời gian đăng ký",
    "col_creation_date": "Ngày tạo",
    "col_creation_time": "Thời gian tạo",
    "col_username": "Tên đăng nhập",
    "col_password": "Mật khẩu",
    "col_role": "Vai trò",
    "col_contractor": "Nhà thầu",
    "col_customer_name": "Khách hàng",    
    "col_security_code": "Mã bảo mật",

    // SweetAlerts & Messages
    "loading_page": "Đang tải trang...",
    "error_title": "Có lỗi xảy ra!",
    "session_expired_title": "Phiên đã hết hạn!",
    "session_expired_text": "Vui lòng đăng nhập lại để tiếp tục.",
    "login_failed": "Đăng nhập thất bại.",
    "logging_out": "Đang đăng xuất...",
    "forgot_password_title": "Quên mật khẩu",
    "success_title": "Thành công",
    "warning_title": "Cảnh báo",
    "info_title": "Thông tin",
    "duplicate_vehicle_popup_title": "Xe trùng đơn vị khác",
    "duplicate_vehicle_popup_message": "Là các xe đã được đăng ký với đơn vị vận chuyển khác. Yêu cầu liên hệ PSVN để được xử lý.",
    "new_vehicle_popup_title": "Thông báo xe mới",
    "new_vehicle_popup_message": "Là xe mới. Yêu cầu gửi đăng ký bổ sung vào danh sách tổng với PSVN.",
    "popup_plate_label": "Xe",
    "popup_ok_button": "OK",

    // XPPL Weighing Station
    "xppl_upload_card_title": "Upload dữ liệu trạm cân",
    "xppl_upload_button": "Tải lên",
    "xppl_filter_card_title": "Bộ lọc",
    "xppl_filter_date_label": "Ngày",
    "xppl_filter_contract_label": "Số hợp đồng",
    "xppl_filter_customer_label": "Khách hàng",
    "xppl_filter_all_option": "Tất cả",
    "xppl_select_date_first": "Chọn ngày trước",
    "xppl_summary_total_trucks": "Tổng số xe",
    "xppl_summary_trucks_sub": "Xe đã ghi nhận trong bộ lọc",
    "xppl_summary_total_weight": "Tổng khối lượng (Kg)",
    "xppl_summary_weight_sub": "Tổng khối lượng hàng đã cân",
    "xppl_data_card_title": "Dữ liệu trạm cân",
    "xppl_search_placeholder": "Tìm kiếm trong bảng...",
    "xppl_total_rows": "Tổng số dòng",
    "xppl_upload_confirm_title": "Xác nhận",
    "xppl_upload_confirm_text": "Bạn có chắc muốn tải lên?",
    "xppl_upload_confirm_button": "Xác nhận",
    "xppl_upload_cancel_button": "Hủy bỏ",
    "xppl_processing_file": "Đang xử lý file...",
    "xppl_file_no_data": "File không có dữ liệu",
    "xppl_header_mismatch": "Tiêu đề cột không khớp với mẫu yêu cầu.",
    "xppl_upload_success_message": "Tải lên thành công",
    "xppl_loading_data": "Đang tải dữ liệu...",
    "xppl_no_file_excel_message": "Vui lòng chọn file Excel.",
    "xppl_no_data_export_message": "Không có dữ liệu để xuất.",

    // Weigh Result Page
    "wr_filter_card_title": "Bộ lọc",
    "wr_search_placeholder": "Tìm kiếm...",
    "wr_date_from_label": "Từ ngày",
    "wr_date_to_label": "Đến ngày",
    "wr_adv_toggle_show": "Bộ lọc nâng cao",
    "wr_adv_toggle_hide": "Ẩn bộ lọc nâng cao",
    "wr_contract_label": "Số hợp đồng",
    "wr_customer_label": "Customer Name",
    "wr_match_title": "Tìm và gắn dữ liệu đơn vị vận chuyển",
    "wr_match_sub": "Đối chiếu nhanh thông tin phương tiện",
    "wr_unknown_title": "Xe không xác định đơn vị vận chuyển",
    "wr_unknown_sub": "Xem và xử lý thủ công",
    "wr_status_unassigned": "Chưa gắn đơn vị vận chuyển",
    "wr_status_unknown": "Không xác định đơn vị vận chuyển",
    "wr_status_assigned": "Đã xác định đơn vị vận chuyển",
    "wr_summary_total_trucks_label": "Tổng số xe",
    "wr_summary_total_trucks_sub": "Số lượng xe phù hợp với bộ lọc",
    "wr_summary_total_weight_label": "Tổng khối lượng (Kg)",
    "wr_summary_total_weight_sub": "Khối lượng đã ghi nhận theo bộ lọc",
    "wr_unknown_modal_title": "Xe không xác định đơn vị vận chuyển",
    "wr_result_card_title": "Kết quả bốc hàng",
    "wr_matching_loading": "Đang đối chiếu...",
    "wr_update_company_title": "Cập nhật đơn vị vận chuyển",
    "wr_no_row_selected_title": "Chưa chọn dòng",
    "wr_no_row_selected_message": "Hãy tick các dòng cần xoá.",
    "wr_delete_confirm_title": "Xoá các mục đã chọn?",
    "wr_deleting_loading": "Đang xoá...",
    "wr_no_export_columns_title": "Không có cột để xuất",
    "wr_no_export_columns_message": "Vui lòng hiển thị ít nhất 1 cột trước khi xuất Excel.",
    "wr_no_matching_data_message": "Không có bản ghi phù hợp với bộ lọc hiện tại.",
    "wr_exporting_data": "Đang xuất dữ liệu...",
  },
  en: {
    // General
    "hello_user": "Hello, {username} ({role})",
    "logout_button": "Logout",
    "server_busy_title": "Server is busy",
    "server_busy_message": "The system is receiving too many requests. Please try again in a moment.",
    "server_busy_retrying": "The system will retry in {seconds} second(s)...",
    "server_busy_final_message": "The server is still busy. Please try again in a few moments.",
    "close_button": "Close",  
    "save_changes_button": "Save Changes",
    "add_button": "Add",
    "edit_button": "Edit",
    "delete_button": "Delete",
    "cancel_button": "Cancel",
    "reload_button": "Reload",
    "action_column": "Actions",
    "file_choose_button": "Choose file",
    "file_no_file_selected": "No file selected",
    "select_all_checkbox": "Select all",    
    "show_label": "Show",
    "entries_label": "entries",
									

    // Login Page
    "login_title": "Login",
    "username_label": "Username",
    "password_label": "Password",
    "login_button": "Login",
    "forgot_password_link": "Forgot password?",
    "continue_button": "Continue",
    "confirm_button": "Confirm",
    "forgot_password_input_label": "Please enter your username",
    "forgot_password_input_placeholder": "Username",
    "forgot_password_input_required": "You must enter your username!",
    "reset_password_title": "Reset password",
    "reset_password_security_placeholder": "Security code",
    "reset_password_new_placeholder": "New password",
    "reset_password_confirm_placeholder": "Confirm new password",
    "reset_password_missing_fields": "Please fill in all required information",
    "reset_password_mismatch": "New password does not match",
    "loading_processing": "Processing...",
    "inactivity_title": "Notice:",
    "inactivity_message": "You have been inactive for too long, please log in again.",
    "login_again_button": "Log in again",    

    // Dashboard & Sidebar
    "sidebar_title": "Vehicle Management",
    "sidebar_register": "New Registration",
    "sidebar_view": "Registered Vehicles",
    "sidebar_contracts": "Transport Contracts",														  
    "sidebar_total_list": "Total Vehicle List",
     "sidebar_account": "User Management",
    "sidebar_vehicle": "Vehicle Registration",
    "sidebar_approval": "Approval",
    "sidebar_weighing": "Weighing Station",
    "sidebar_weighing_result": "Weighing Results",
    "sidebar_account_parent": "Account",
    "sidebar_history_parent": "History",
    "sidebar_login_history": "Login history",
    "sidebar_vehicle_history": "New vehicle registration history",
    "sidebar_guide": "Guide",

    // Contracts Page
    "contract_entry_title": "Enter Contract",
    "contract_save_button": "Save",
    "contract_card_title": "Contracts",
    "contract_search_placeholder": "Search in the list...",
    "contract_loading_saving": "Saving...",
    "contract_edit_title": "Edit Contract",
    "contract_loading_updating": "Updating...",
    "contract_loading_deleting": "Deleting...",
    "contract_no_selection_title": "No rows selected",
    "contract_no_selection_message": "Please tick the rows you want to delete.",
    "contract_confirm_delete_title": "Delete selected items?",

    // Account Page
    "change_password_header": "Change Password",
    "current_password_label": "Current Password",
    "new_password_label": "New Password",
    "confirm_new_password_label": "Confirm New Password",
    "user_management_header": "User Management",
    "add_user_button": "Add User",

    // Register Page
    "reg_open_message_text": "The registration system will close in:",
    "reg_time_left": "Time remaining",
    "reg_closed_message_text": "The registration system is currently closed.",
    "reg_readonly_notice": "The form is currently in read-only mode.",
    "reg_will_reopen": "Will reopen in",
    "reg_manual_header": "Add a New Vehicle (Manual Entry)",
    "reg_upload_header": "Add Multiple Vehicles (Upload File)",
    "reg_upload_note": "Note: Only .xlsx, .xls, .csv files are accepted.",
    "register_today_option": "Today ({date})",
    "register_tomorrow_option": "Tomorrow ({date})",
    "register_date_join_word": "or",
    "register_upload_date_note_single": "File upload only accepts registration date {date}.",
    "register_upload_date_note_multi": "File upload only accepts registration dates {dates}.",
    "preview_data_button": "Preview Data",
    "preview_data_title": "Preview Data",
    "save_data_button": "Save Data",
    "register_vehicle_button": "Register Vehicle",
    "select_company_option": "Select company",
    "reg_date_label": "Registration Date",
    "register_contract_placeholder": "Enter or select Contract No",
    "register_missing_data_title": "Missing data",
    "register_missing_data_message": "Please enter Registration Date, Contract No, and Truck Plate.",
    "loading_saving_data": "Saving data...",
    "register_success_message": "Vehicle registration successful!",
    "loading_processing_file": "Processing and validating file...",
    "no_file_selected_title": "No file selected",
    "no_file_selected_message": "Please select a file.",
    "upload_errors_intro": "Errors were found in the uploaded file. Please correct the Excel file and try again. Cells highlighted in red contain errors.",
    "upload_errors_more": "... and more errors.",
    "invalid_data_title": "Invalid data!",
    "file_no_data_error": "The file has no data.",
    "validation_required": "- Column '{field}' cannot be empty.",
    "validation_invalid_date": "- Column '{field}' has an invalid date format.",
    "validation_ambiguous_date": "- Column '{field}' has an ambiguous date format (dd/MM/yyyy vs MM/dd/yyyy). Please verify.",
    "validation_only_tomorrow": "- Column '{field}' only accepts tomorrow's date.",
    "validation_only_today_or_tomorrow": "- Column '{field}' only accepts {dates}.",
    "validation_max_length": "- Column '{field}' cannot exceed {max} characters.",
    "validation_numeric_max": "- Column '{field}' must be numeric and not exceed {max}.",
    "validation_numeric_only": "- Column '{field}' must be numeric.",
    "validation_allowed_values": "- Column '{field}' only accepts: {values}.",
    "validation_contractor_mismatch": "- You can only register vehicles for your contractor ({contractor}).",
    "validation_row_label": "Row {row}",
    "duplicate_data_error": "Duplicate data in the file.",
    "validation_duplicate_rows": "Rows {row1} and {row2}",
    "validation_duplicate_details": "Duplicate data (Date, Truck Plate, Transport Company).",
    "no_valid_data_title": "No valid data",
    "no_valid_data_message": "There is no data to save.",
    "loading_checking_data": "Checking and saving data...",
    "combo_open_list_label": "Open list",    

    // View Page
    "view_header": "Registered Vehicle Data",
    "view_filter_label": "View date",    
    "search_in_table_placeholder": "Search in table...",
    "export_excel_button": "Export Excel",
    "edit_rules_notice_line1": "<strong>Editing Rules:</strong><br>- Users can edit or delete records between <strong>07:00 - 16:00</strong>.",
    "edit_rules_notice_line2": "- Records older than 1 day cannot be modified.",
    "edit_restricted_title": "Action not allowed",
    "edit_restricted_time": "You can only edit or delete records between 07:00 and 16:00.",
    "edit_restricted_date": "You cannot edit or delete records that are older than 1 day.",
    "edit_restricted_role": "You do not have permission to modify this data.",
    "view_stat_total_label": "Total registered vehicles:",
    "view_stat_pending_label": "Total pending approval:",
    "view_stat_approved_label": "Total approved vehicles:",
    "view_filter_contract_label": "Contract No",
    "view_filter_contract_all": "All contracts",
    "view_filter_contract_loading": "Loading...",
    "view_filter_contract_empty": "No contracts for the selected date",
    "no_selection_title": "No selection",
    "no_selection_message": "Please select at least one item to delete.",
    "delete_selected_confirm_title": "Are you sure you want to delete {count} item(s)?",
    "delete_selected_confirm_text": "This action cannot be undone!",
    "confirm_delete_button": "Yes, delete!",
    "delete_success_title": "Deleted!",
    "loading_deleting": "Deleting...",
    "loading_updating": "Updating...",
    // History Pages
    "history_login_title": "Login history",
    "history_vehicle_title": "New vehicle registration history",
    "history_filter_date_from": "From date",
    "history_filter_date_to": "To date",
    "history_filter_contract": "Contract No",
    "history_filter_company": "Transportation company",
    "history_filter_all": "All",
    "history_col_occurred_at": "Login time",
    "history_col_outcome": "Outcome",
    "history_col_ip": "IP address",
    "history_col_latitude": "Latitude",
    "history_col_longitude": "Longitude",
    "history_col_accuracy": "Accuracy (m)",
    "history_col_user_agent": "User Agent",
    "history_col_created_at": "Created at",
    "history_col_action_type": "Action type",
    "history_col_action_time": "Action time",
    "history_col_created_by": "Operator",
    "edit_vehicle_title": "Edit vehicle information",
    "edit_validation_message": "Please complete all required fields with valid values.",    
    "register_contract_placeholder": "Enter or select Contract No",
    "register_today_option": "Today ({date})",
    "register_tomorrow_option": "Tomorrow ({date})",
    "register_date_join_word": "or",
    "register_upload_date_note_single": "File upload only accepts registration date {date}.",
    "register_upload_date_note_multi": "File upload only accepts registration dates {dates}.",
    "register_missing_data_title": "Missing data",
    "register_missing_data_message": "Please enter Registration Date, Contract No, and Truck Plate.",
    "loading_saving_data": "Saving data...",
    "register_success_message": "Vehicle registration successful!",
    "loading_processing_file": "Processing and validating file...",
    "no_file_selected_title": "No file selected",
    "no_file_selected_message": "Please select a file.",
    "upload_errors_intro": "Errors were found in the uploaded file. Please correct the Excel file and try again. Cells highlighted in red contain errors.",
    "upload_errors_more": "... and more errors.",
    "invalid_data_title": "Invalid data!",
    "file_no_data_error": "The file has no data.",
    "validation_required": "- Column '{field}' cannot be empty.",
    "validation_invalid_date": "- Column '{field}' has an invalid date format.",
    "validation_only_tomorrow": "- Column '{field}' only accepts tomorrow's date.",
    "validation_only_today_or_tomorrow": "- Column '{field}' only accepts {dates}.",
    "validation_max_length": "- Column '{field}' cannot exceed {max} characters.",
    "validation_numeric_max": "- Column '{field}' must be numeric and not exceed {max}.",
    "validation_numeric_only": "- Column '{field}' must be numeric.",
    "validation_allowed_values": "- Column '{field}' only accepts: {values}.",
    "validation_contractor_mismatch": "- You can only register vehicles for your contractor ({contractor}).",
    "validation_row_label": "Row {row}",
    "duplicate_data_error": "Duplicate data in the file.",
    "validation_duplicate_rows": "Rows {row1} and {row2}",
    "validation_duplicate_details": "Duplicate data (Date, Truck Plate, Transport Company).",
    "no_valid_data_title": "No valid data",
    "no_valid_data_message": "There is no data to save.",
    "loading_checking_data": "Checking and saving data...",
    "combo_open_list_label": "Open list",

    // Total List Page
    "total_list_upload_header": "Add New Vehicle List (Upload File)",
    "total_list_upload_note": "Note: This will overwrite the entire existing vehicle list. Only .xlsx, .xls, .csv files are accepted.",
    "save_list_button": "Save List",
    "total_list_header": "Total Vehicle List",
    "show_update_button": "Show/Update",
    "delete_selected_button": "Delete Selected",
    "search_in_list_placeholder": "Search in list...",
    "total_vehicles": "Total Vehicles",
    "active_vehicles": "Active Vehicles",
    "banned_vehicles": "Banned Vehicles",    

    // DataTables Columns (Shared)
    "col_id": "ID",
    "col_register_date": "Register Date",
    "col_contract_no": "Contract No",
    "col_truck_plate": "Truck Plate",
    "col_country": "Country",
    "col_wheel": "Wheels",
    "col_trailer_plate": "Trailer Plate",
    "col_truck_weight": "Truck Weight",
    "col_payload": "Payload",
    "col_container1": "Container 1",
    "col_container2": "Container 2",
    "col_driver_name": "Driver Name",
    "col_id_passport": "ID/Passport",
    "col_phone_number": "Phone Number",
    "col_destination": "Destination EST",
    "col_transport_company": "Transport Company",
    "col_subcontractor": "Subcontractor",
    "col_vehicle_status": "Vehicle Status",
    "col_activity_status": "Activity Status",    
    "col_registration_status": "Registration Status",
    "col_time": "Registration Time",
    "col_creation_date": "Creation Date",
    "col_creation_time": "Creation Time",
    "col_username": "Username",
    "col_password": "Password",
    "col_role": "Role",
    "col_contractor": "Contractor",
    "col_customer_name": "Customer Name",
    "col_security_code": "Security Code",

    // SweetAlerts & Messages
    "loading_page": "Loading page...",
    "error_title": "Something went wrong!",
    "session_expired_title": "Session Expired!",
    "session_expired_text": "Please log in again to continue.",
    "login_failed": "Login failed.",
    "logging_out": "Logging out...",
    "forgot_password_title": "Forgot Password",
    "success_title": "Success",
    "warning_title": "Warning",
    "info_title": "Information",
    "duplicate_vehicle_popup_title": "Vehicles registered with another company",
    "duplicate_vehicle_popup_message": "These vehicle plate(s) have already been registered with another transport company. Please contact PSVN for assistance.",
    "new_vehicle_popup_title": "New vehicle notice",
    "new_vehicle_popup_message": "These vehicle plate(s) are new. Please submit an additional registration to the total list with PSVN.",
    "popup_plate_label": "Vehicle",
    "popup_ok_button": "OK",

    // XPPL Weighing Station
    "xppl_upload_card_title": "Upload Weighing Station Data",
    "xppl_upload_button": "Upload",
    "xppl_filter_card_title": "Filters",
    "xppl_filter_date_label": "Date",
    "xppl_filter_contract_label": "Contract No",
    "xppl_filter_customer_label": "Customer",
    "xppl_filter_all_option": "All",
    "xppl_select_date_first": "Select a date first",
    "xppl_summary_total_trucks": "Total Trucks",
    "xppl_summary_trucks_sub": "Trucks captured by the filters",
    "xppl_summary_total_weight": "Total Weight (Kg)",
    "xppl_summary_weight_sub": "Total cargo weight recorded",
    "xppl_data_card_title": "Weighing Station Data",
    "xppl_search_placeholder": "Search within the table...",
    "xppl_total_rows": "Total rows",
    "xppl_upload_confirm_title": "Confirm",
    "xppl_upload_confirm_text": "Are you sure you want to upload?",
    "xppl_upload_confirm_button": "Confirm",
    "xppl_upload_cancel_button": "Cancel",
    "xppl_processing_file": "Processing file...",
    "xppl_file_no_data": "The file contains no data",
    "xppl_header_mismatch": "Column headers do not match the required template.",
    "xppl_upload_success_message": "Upload successful",
    "xppl_loading_data": "Loading data...",
    "xppl_no_file_excel_message": "Please choose an Excel file.",
    "xppl_no_data_export_message": "No data to export.",

    // Weigh Result Page
    "wr_filter_card_title": "Filters",
    "wr_search_placeholder": "Search...",
    "wr_date_from_label": "From date",
    "wr_date_to_label": "To date",
    "wr_adv_toggle_show": "Advanced filters",
    "wr_adv_toggle_hide": "Hide advanced filters",
    "wr_contract_label": "Contract No",
    "wr_customer_label": "Customer Name",
    "wr_match_title": "Find & link transport company data",
    "wr_match_sub": "Quickly reconcile vehicle information",
    "wr_unknown_title": "Transport company not identified",
    "wr_unknown_sub": "Review and handle manually",
    "wr_status_unassigned": "Transport company not linked",
    "wr_status_unknown": "Transport company unknown",
    "wr_status_assigned": "Transport company identified",
    "wr_summary_total_trucks_label": "Total trucks",
    "wr_summary_total_trucks_sub": "Vehicles matching the filters",
    "wr_summary_total_weight_label": "Total weight (Kg)",
    "wr_summary_total_weight_sub": "Recorded weight within the filters",
    "wr_unknown_modal_title": "Transport company not identified",
    "wr_result_card_title": "Weighing results",
    "wr_matching_loading": "Matching transport companies...",
    "wr_update_company_title": "Update transport company",
    "wr_no_row_selected_title": "No rows selected",
    "wr_no_row_selected_message": "Please select the rows to delete.",
    "wr_delete_confirm_title": "Delete selected entries?",
    "wr_deleting_loading": "Deleting...",
    "wr_no_export_columns_title": "No columns to export",
    "wr_no_export_columns_message": "Please show at least one column before exporting to Excel.",
    "wr_no_matching_data_message": "No records match the current filters.",
    "wr_exporting_data": "Exporting data...",
  }
};

function getLanguageDict(lang) {
    if (lang && translations[lang]) {
        return translations[lang];
    }

    if (currentLang && translations[currentLang]) {
        return translations[currentLang];
    }

    if (translations.vi) return translations.vi;
    const firstKey = Object.keys(translations || {})[0];
    return (translations && firstKey && translations[firstKey]) || {};
}

function setLanguage(lang) {
    currentLang = translations[lang] ? lang : (translations[currentLang] ? currentLang : 'vi');
    const dict = getLanguageDict(currentLang);

    document.querySelectorAll('[data-translate]').forEach(el => {
        const key = el.getAttribute('data-translate');
        if (key && dict[key]) {
            el.innerHTML = dict[key];
        }
    });
    document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
        const key = el.getAttribute('data-translate-placeholder');
        if (key && dict[key]) {
            el.setAttribute('placeholder', dict[key]);
        }
    });

    // Cập nhật các bảng nếu chúng đang tồn tại
    if ($.fn.DataTable.isDataTable('#registeredVehicleTable')) {
        initViewPage();
    }
    if ($.fn.DataTable.isDataTable('#totalListTable')) {
        initTotalListPage();
    }
    if ($.fn.DataTable.isDataTable('#usersTable')) {
        initUsersTable();
    }
    if ($.fn.DataTable.isDataTable('#login-history-table')) {
        initLoginHistoryPage();
    }
    if ($.fn.DataTable.isDataTable('#vehicle-history-table')) {
        initVehicleHistoryPage();
    }
    
    if (typeof xpplWeighingTable !== 'undefined' && $.fn.DataTable.isDataTable('#xppl-weighing-table')) {
        const count = xpplWeighingTable.rows({ search: 'applied' }).count();
        const label = (dict && dict.xppl_total_rows) || 'Tổng số dòng';
        $('#xppl-count').html(`${label}: <span class="badge bg-primary">${count}</span>`);
    }
    
    // Cập nhật thông tin người dùng
    if(userSession.isLoggedIn) {
         const roleText = getRoleDisplay();
         const helloTemplate = (dict && dict.hello_user) || 'Xin chào, {username} ({role})';
         $('#userInfo').text(
            helloTemplate
                .replace('{username}', userSession.username)
                .replace('{role}', roleText)
         );
    }

    refreshCustomFileDisplays(lang);
}

function refreshCustomFileDisplays(lang) {
  const language = lang || currentLang || 'vi';
  const dict = translations[language] || translations.vi || {};
  $('[data-file-display]').each(function(){
    const $display = $(this);
    const inputId = $display.data('fileDisplay');
    if (!inputId) return;
    const $input = $('#' + inputId);
    if (!$input.length) return;
    const updateFn = $input.data('fileUpdateFn') || $display.data('fileUpdateFn');
    if (typeof updateFn === 'function') {
      updateFn();
      return;
    }
    const files = ($input[0] && $input[0].files) || [];
    if (files.length) return;
    const key = $display.data('fileDefaultKey');
    const fallback = $display.data('fileFallback') || '';
    if (key && dict[key]) {
      $display.text(dict[key]);
    } else if (fallback) {
      $display.text(fallback);
    }
    $display.toggleClass('file-upload-label--empty', !files.length);
  });
}

function setupCustomFileInput(inputSelector, options = {}) {
  const $input = $(inputSelector);
  if (!$input.length) return;
  const inputId = $input.attr('id');
  const $display = options.display
    ? $(options.display)
    : (inputId ? $(`[data-file-display="${inputId}"]`) : $());
  if (!$display.length) return;
  const $trigger = options.trigger
    ? $(options.trigger)
    : (inputId ? $(`[data-file-target="${inputId}"]`) : $());
  const defaultKey = options.defaultKey || $display.data('fileDefaultKey');
  if (defaultKey) $display.data('fileDefaultKey', defaultKey);
  if (!$display.data('fileFallback')) {
    $display.data('fileFallback', $display.text().trim());
  }

  const updateDisplay = () => {
    const inputEl = $input[0];
    const files = (inputEl && inputEl.files) || [];
    if (files.length) {
      const names = Array.from(files).map(file => file.name).join(', ');
      $display.text(names).removeClass('file-upload-label--empty');
    } else {
      const lang = currentLang || 'vi';
      const dict = translations[lang] || translations.vi || {};
      const key = $display.data('fileDefaultKey');
      const fallback = $display.data('fileFallback') || '';
      if (key && dict[key]) {
        $display.text(dict[key]);
      } else {
        $display.text(fallback);
      }
      $display.addClass('file-upload-label--empty');
    }
  };

  $input.data('fileUpdateFn', updateDisplay);
  $display.data('fileUpdateFn', updateDisplay);

  $input.off('change.customFile').on('change.customFile', updateDisplay);

  if ($trigger.length) {
    $trigger.off('click.customFile').on('click.customFile', function(e){
      e.preventDefault();
      $input.trigger('click');
    });
  }

  $display.off('click.customFile').on('click.customFile', function(){
    $input.trigger('click');
  });

  $display.attr('tabindex', 0);
  $display.off('keydown.customFile').on('keydown.customFile', function(e){
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      $input.trigger('click');
    }
  });

  updateDisplay();    
}

$(document).on('click', '.lang-btn', function(e) {
    e.preventDefault();
    const lang = $(this).data('lang');
    setLanguage(lang);
});


$(document).ready(function() {
    $loaderWrapper = getLoaderWrapper();
    $appContainer = getAppContainer();
    preloadLoginTemplate();

    const storedSession = getStoredSession();
    let sessionFlagInTab = false;
    if (storedSession) {
        userSession = storedSession;
        try {
            sessionFlagInTab = !!sessionStorage.getItem(SESSION_FLAG_KEY);
        } catch (err) {
            sessionFlagInTab = false;
        }
        if (storedSession.token && !sessionFlagInTab) {
            setSessionFlag({ persistLocal: false });
            sessionFlagInTab = true;
        }
    }

    const existingToken = storedSession && storedSession.token ? storedSession.token : null;
    const hasSessionFlag = sessionFlagInTab;
    const shouldAttemptRestore = !!(existingToken && hasSessionFlag);
    sessionRestoreInProgress = shouldAttemptRestore;
    sessionCheckCompleted = false;

    if (shouldAttemptRestore) {
        showLoader();
        scheduleLoginFallback(800);
    } else {
        const loginVisible = renderLoginTemplate();
        if (!loginVisible) {
            showLoader();
            loadLoginPage();
            scheduleLoginFallback(450);
        } else {
            clearLoginFallbackTimer();
        }
    }

    try {
        initializeApp(existingToken);
    } catch (err) {
        if (typeof console !== 'undefined' && console.error) {
            console.error('Failed to initialize app:', err);
        }
        sessionCheckCompleted = true;
        clearLoginFallbackTimer();
        if (!renderLoginTemplate()) {
            loadLoginPage();
        }
    }
});


function initializeApp(existingToken) {
    google.script.run
        .withSuccessHandler(session => {
            sessionCheckCompleted = true;
            clearLoginFallbackTimer();
            sessionRestoreInProgress = false;
            const normalizedSession = (session && typeof session === 'object') ? session : {};
            const isValidSession = !!(normalizedSession.isLoggedIn && normalizedSession.token);
            if (isValidSession) {
                userSession = normalizedSession;
                setSessionFlag();
                persistUserSession(userSession);
                loadDashboard();
                setupInactivityTimer();
                ensureVietnamTime();
                google.script.run
                  .withSuccessHandler(list => { allowedCompanies = (list || []).filter(Boolean); })
                  .withFailureHandler(showError)
                  .getTransportCompanies();
            } else {
                userSession = { isLoggedIn: false, role: null, contractor: null, token: null };
                clearStoredSession();
                clearSessionFlag();
                if (!renderLoginTemplate()) {
                    loadLoginPage();
                }
            }
        })
        .withFailureHandler(error => {
            sessionCheckCompleted = true;
           clearLoginFallbackTimer();
            sessionRestoreInProgress = false;
            userSession = { isLoggedIn: false, role: null, contractor: null, token: null };
            clearStoredSession();
            clearSessionFlag();
            if (!renderLoginTemplate()) {
                loadLoginPage();
            }
            showError(error);
        })
        .getUserSession(existingToken || null);
}

// =================================================================
// PAGE & VIEW MANAGEMENT
// =================================================================

function showLoader() {
    const loader = getLoaderWrapper();
    const app = getAppContainer();
    if (!loader.length || !app.length) return;

    app.hide();
    if (!loader.is(':visible')) {
        loader.css('opacity', '0');
        loader.show();
    } else {
        loader.show();
    }

    if (window.requestAnimationFrame) {
        window.requestAnimationFrame(() => loader.css('opacity', '1'));
    } else {
        loader.css('opacity', '1');
    }
}

function showApp() {
    const loader = getLoaderWrapper();
    const app = getAppContainer();
    if (!loader.length || !app.length) return;

    if (typeof loader.stop === 'function') {
        loader.stop(true, true);
    }
    loader.css('opacity', '0');
    loader.hide();
    app.show();
    try {
        setLanguage(currentLang); // Áp dụng ngôn ngữ sau khi hiển thị
    } catch (err) {
        if (typeof console !== 'undefined' && console.warn) {
            console.warn('setLanguage failed while showing app:', err);
        }
    }
}

function bindLoginEvents() {
    const loginForm = $('#loginForm');
    if (loginForm.length) {
        loginForm.off('submit').on('submit', handleLogin);
    }

    const forgotLink = $('#forgotPasswordLink');
    if (forgotLink.length) {
        forgotLink.off('click').on('click', handleForgotPassword);
    }
}

function renderLoginTemplate() {
    preloadLoginTemplate();
    const app = getAppContainer();
    if (!loginTemplateHTML || !app.length) return false;


    document.body.className = 'login-view-active';
    app.html(loginTemplateHTML);
    try {
        setLanguage(currentLang);
    } catch (err) {
        if (typeof console !== 'undefined' && console.warn) {
            console.warn('setLanguage failed while rendering login template:', err);
        }
    }
    bindLoginEvents();
    showApp();
    return true;
}

function loadLoginPage() {
  if (renderLoginTemplate()) {
      return;
  }

  google.script.run
    .withSuccessHandler(html => {
        document.body.className = 'login-view-active';
        $('#app-container').html(html);
        try {
            setLanguage(currentLang);
        } catch (err) {
            if (typeof console !== 'undefined' && console.warn) {
                console.warn('setLanguage failed while loading login page:', err);
            }
        }
        bindLoginEvents();
        clearLoginFallbackTimer();
        showApp();
    })
    .withFailureHandler(showError)
    .include('Login');
}

function loadDashboard() {
  invalidateAllPageCache();
  showLoader();
  google.script.run
    .withSuccessHandler(html => {
        // Dòng mã thêm vào:
        document.body.className = ''; // Xóa "dấu" để trả về layout dashboard mặc định
        $('#app-container').html(html);
        // Ẩn các menu theo phân quyền
        if (userSession) {
          const hideMenuItem = page => {
            const item = $(`#sidebar-wrapper .list-group-item[data-page="${page}"]`);
            item.addClass('d-none disabled').removeClass('active');
            const parent = item.closest('.collapse');
            if (parent.length && parent.find('.list-group-item[data-page]:not(.d-none)').length === 0) {
              parent.addClass('d-none');
              parent.prev('a').addClass('d-none');
            }
          };

          const role = getUserRole();
          if (role === 'user-supervision') {
            hideMenuItem('Page_Register');
            hideMenuItem('Page_TotalList');
            hideMenuItem('Page_Contract');
            hideMenuItem('Page_XuLyXPPL');
            hideMenuItem('XPPL-WeighingStation');
            hideMenuItem('Page_LoginHistory');
            hideMenuItem('Page_VehicleHistory');
            hideMenuItem('Page_Guide');
            $('#sidebar-wrapper .list-group-item[data-page]').removeClass('active');
            const viewLink = $('#sidebar-wrapper .list-group-item[data-page="Page_View"]');
            viewLink.removeClass('d-none disabled').addClass('active');
            viewLink.closest('.collapse').addClass('show');
          } else if (role === 'admin-xppl') {
            hideMenuItem('Page_Register');
            hideMenuItem('Page_Contract');
            hideMenuItem('Page_XuLyXPPL');
            hideMenuItem('Page_LoginHistory');
            hideMenuItem('Page_VehicleHistory');
            $('#sidebar-wrapper .list-group-item[data-page="Page_View"]').addClass('active').closest('.collapse').addClass('show');
          } else if (role !== 'admin') {
            hideMenuItem('Page_XuLyXPPL');
            hideMenuItem('Page_LoginHistory');
            hideMenuItem('Page_VehicleHistory');
            const active = $('#sidebar-wrapper .list-group-item[data-page].active');
            if (active.data('page') === 'Page_XuLyXPPL') {
              active.removeClass('active');
              $('#sidebar-wrapper .list-group-item[data-page="Page_View"]').addClass('active').closest('.collapse').addClass('show');
            }
          }
        if (!hasAnyRole(['admin', 'admin-xppl'])) {
            hideMenuItem('XPPL-WeighingStation');
          }
        }
        setupDashboardListeners();
        const defaultPageLink = $('#sidebar-wrapper .list-group-item[data-page].active');
        defaultPageLink.closest('.collapse').addClass('show');
        const pageTitleKey = defaultPageLink.data('title-key');
        loadPage(defaultPageLink.data('page'), pageTitleKey, true);
        showApp();
    })
    .withFailureHandler(showError)
    .include('Dashboard');
}

function runPageInitializer(pageName) {
    const initializer = PAGE_INITIALIZERS[pageName];
    if (typeof initializer === 'function') {
        try {
            initializer();
        } catch (err) {
            if (typeof console !== 'undefined' && console.error) {
                console.error(`Failed to initialize ${pageName}:`, err);
            }
        }
    }
}

function renderPageContent(pageName, html, isInitialLoad) {
    $('#main-content').html(html);
    runPageInitializer(pageName);
    try {
        setLanguage(currentLang); // Dịch nội dung trang mới
    } catch (err) {
        if (typeof console !== 'undefined' && console.warn) {
            console.warn('setLanguage failed after loading page:', err);
        }
    }
    if (!isInitialLoad) {
        Swal.close();
    }
}

function loadPage(pageName, pageTitleKey, isInitialLoad = false) {
    if (registrationTimerInterval) {
        clearInterval(registrationTimerInterval);
        registrationTimerInterval = null;
    }

    $('.page-title').text(translations[currentLang][pageTitleKey] || pageTitleKey);
    const cachedHtml = getCachedPage(pageName);
    if (cachedHtml) {
        renderPageContent(pageName, cachedHtml, isInitialLoad);
        return;
    }

    if (!isInitialLoad) showLoading(translations[currentLang].loading_page);
    const role = getUserRole();
    if (role === 'user-supervision' && !SUPERVISION_ALLOWED_PAGES.has(pageName)) {
      if (!isInitialLoad) Swal.close();
      Swal.fire('Không có quyền', 'Tài khoản giám sát chỉ được phép xem dữ liệu đã được phê duyệt.', 'info');
      $('.page-title').text(translations[currentLang]['view_header'] || 'Xe đã đăng ký');
      loadPage('Page_View', 'view_header', true);
      return;
    }

        // Chặn client nếu không phải admin
    if (pageName === 'Page_XuLyXPPL' && userSession && role !== 'admin') {
      if (!isInitialLoad) Swal.close();
      Swal.fire('Không có quyền', 'Chức năng này chỉ dành cho Admin.', 'info');
      $('.page-title').text(translations[currentLang]['view_header'] || 'Xe đã đăng ký');
      loadPage('Page_View', 'view_header', true);
      return;
    }

    if (userSession && role === 'admin-xppl' && ['Page_Register','Page_Contract'].includes(pageName)) {
      if (!isInitialLoad) Swal.close();
      Swal.fire('Không có quyền', 'Chức năng này không khả dụng với tài khoản hiện tại.', 'info');
      $('.page-title').text(translations[currentLang]['view_header'] || 'Xe đã đăng ký');
      loadPage('Page_View', 'view_header', true);
      return;
    }

    if (pageName === 'XPPL-WeighingStation' && userSession && !hasAnyRole(['admin', 'admin-xppl'])) {
      if (!isInitialLoad) Swal.close();
      Swal.fire('Không có quyền', 'Chức năng này chỉ dành cho Admin hoặc admin-xppl.', 'info');
      $('.page-title').text(translations[currentLang]['view_header'] || 'Xe đã đăng ký');
      loadPage('Page_View', 'view_header', true);
      return;
    }

    if ((pageName === 'Page_LoginHistory' || pageName === 'Page_VehicleHistory') && !hasAnyRole(['admin'])) {
      if (!isInitialLoad) Swal.close();
      Swal.fire('Không có quyền', 'Chức năng này chỉ dành cho Admin.', 'info');
      $('.page-title').text(translations[currentLang]['view_header'] || 'Xe đã đăng ký');
      loadPage('Page_View', 'view_header', true);
      return;
    }

    google.script.run
        .withSuccessHandler(html => {
            cachePageHtml(pageName, html);
            renderPageContent(pageName, html, isInitialLoad);
        })
        .withFailureHandler(showError)
        .include(pageName);
}

function setupDashboardListeners() {
    $('#sidebar-wrapper .list-group-item[data-page]').on('click', function(e) {
        e.preventDefault();
        const link = $(this);
        if (link.hasClass('disabled')) return;
        
        $('#sidebar-wrapper .list-group-item[data-page]').removeClass('active');
        link.addClass('active');
        link.closest('.collapse').addClass('show');
        
        const page = link.data('page');
        const titleKey = link.data('title-key');
        if (page) {
            loadPage(page, titleKey);
        }
    });

    $('#logoutBtn').on('click', handleLogout);
    
    $("#menu-toggle").click(function(e) {
      e.preventDefault();
      $("#wrapper").toggleClass("toggled");
      setTimeout(() => {
        if ($.fn.DataTable.isDataTable('#registeredVehicleTable')) {
            $('#registeredVehicleTable').DataTable().columns.adjust();
        }
        if ($.fn.DataTable.isDataTable('#totalListTable')) {
            $('#totalListTable').DataTable().columns.adjust();
        }
        if ($.fn.DataTable.isDataTable('#login-history-table')) {
            $('#login-history-table').DataTable().columns.adjust();
        }
        if ($.fn.DataTable.isDataTable('#vehicle-history-table')) {
            $('#vehicle-history-table').DataTable().columns.adjust();
        }
      }, 300);
    });
}


// =================================================================
// AUTHENTICATION & SESSION MANAGEMENT
// =================================================================

function getUserAgentString() {
    if (typeof navigator !== 'undefined' && navigator.userAgent) {
        return navigator.userAgent;
    }
    return null;
}

function isFiniteNumber(value) {
    return typeof value === 'number' && isFinite(value);
}

async function fetchPublicIp(timeoutMs = 3500) {
    if (typeof fetch !== 'function') {
        return null;
    }

    let controller;
    let timer;
    try {
        if (typeof AbortController === 'function') {
            controller = new AbortController();
            if (typeof timeoutMs === 'number' && timeoutMs > 0) {
                timer = setTimeout(() => {
                    try {
                        controller.abort();
                    } catch (err) {
                        console.warn('Abort fetchPublicIp failed:', err);
                    }
                }, timeoutMs);
            }
        }

        const requestOptions = controller ? { signal: controller.signal } : {};
        const response = await fetch('https://api.ipify.org?format=json', requestOptions);
        if (!response || !response.ok) {
            return null;
        }
        const data = await response.json();
        if (data && data.ip) {
            return data.ip;
        }
    } catch (err) {
        console.warn('fetchPublicIp error:', err);
        return null;
    } finally {
        if (timer) {
            clearTimeout(timer);
        }
    }
    return null;
}

function requestBrowserGeolocation(options = {}) {
    if (typeof navigator === 'undefined' || !navigator.geolocation) {
        return Promise.resolve(null);
    }

    const geoOptions = {
        enableHighAccuracy: options.enableHighAccuracy === true,
        maximumAge: typeof options.maximumAge === 'number' ? options.maximumAge : 60 * 1000,
        timeout: typeof options.timeout === 'number' ? options.timeout : 5000
    };

    return new Promise(resolve => {
        try {
            navigator.geolocation.getCurrentPosition(
                position => {
                    if (position && position.coords) {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        });
                    } else {
                        resolve(null);
                    }
                },
                () => resolve(null),
                geoOptions
            );
        } catch (err) {
            console.warn('requestBrowserGeolocation error:', err);
            resolve(null);
        }
    });
}

async function collectLoginContext(options = {}) {
    const context = {};
    const userAgent = getUserAgentString();
    if (userAgent) {
        context.userAgent = userAgent;
    }

    const ipPromise = fetchPublicIp(options.ipTimeoutMs || 3500);
    const locationPromise = requestBrowserGeolocation({
        enableHighAccuracy: options.enableHighAccuracy === true,
        maximumAge: options.locationMaximumAgeMs || 60 * 1000,
        timeout: options.locationTimeoutMs || 5000
    });

    const [ipAddress, location] = await Promise.all([
        ipPromise.catch(() => null),
        locationPromise.catch(() => null)
    ]);

    if (ipAddress) {
        context.ip = ipAddress;
    }

    if (location) {
        if (isFiniteNumber(location.latitude)) {
            context.latitude = location.latitude;
        }
        if (isFiniteNumber(location.longitude)) {
            context.longitude = location.longitude;
        }
        if (isFiniteNumber(location.accuracy)) {
            context.accuracy = location.accuracy;
        }
    }

    return context;
}

async function handleLogin(e) {
    e.preventDefault();
    const loginBtn = $('#loginBtn');
    loginBtn.find('.spinner-border').removeClass('d-none');
    loginBtn.prop('disabled', true);

    let context = {};
    try {
        context = await collectLoginContext({
            ipTimeoutMs: 4000,
            locationTimeoutMs: 6000,
            locationMaximumAgeMs: 60 * 1000
        });
    } catch (err) {
        console.warn('collectLoginContext failed:', err);
        context = {};
    }

    const userAgent = getUserAgentString();
    if (userAgent && !context.userAgent) {
        context.userAgent = userAgent;
    }

    const credentials = {
        username: $('#username').val(),
        password: $('#password').val(),
        context
    };

    google.script.run
        .withSuccessHandler(session => {
            const normalizedSession = (session && typeof session === 'object') ? session : {};
            const isValid = !!(normalizedSession.isLoggedIn && normalizedSession.token);
            if (isValid) {
                userSession = normalizedSession;
                setSessionFlag();
                persistUserSession(userSession);
                loadDashboard();
                setupInactivityTimer();
            } else {
                userSession = { isLoggedIn: false, role: null, contractor: null, token: null };
                clearStoredSession();
                clearSessionFlag();
                showError({ message: translations[currentLang].login_failed });
                userSession = { isLoggedIn: false, role: null, contractor: null, token: null };
                clearStoredSession();
                loginBtn.find('.spinner-border').addClass('d-none');
                loginBtn.prop('disabled', false);                
            }
        })
        .withFailureHandler(error => {
            showError(error);
            loginBtn.find('.spinner-border').addClass('d-none');
            loginBtn.prop('disabled', false);
        })
        .checkLogin(credentials);
}

function buildCacheBustingUrl() {
    try {
        const url = new URL(window.location.href);
        url.hash = '';
        url.searchParams.set('_ts', Date.now().toString());
        return url.toString();
    } catch (err) {
        const base = window.location.href.split('#')[0];
        const separator = base.includes('?') ? '&' : '?';
        return `${base}${separator}_ts=${Date.now()}`;
    }
}

function redirectToAppWithCacheBusting() {
    const targetUrl = buildCacheBustingUrl();
    try {
        if (window.top && window.top !== window) {
            window.top.location.replace(targetUrl);
        } else {
            window.location.replace(targetUrl);
        }
    } catch (err) {
        window.location.href = targetUrl;
    }
}

function handleLogout() {
    const sessionToken = userSession && userSession.token;
    clearTimeout(inactivityTimer);
    $(document).off('mousemove mousedown keypress scroll touchstart');

    sessionCheckCompleted = true;
    clearLoginFallbackTimer();
    sessionRestoreInProgress = false;

    showLoader();
    invalidateAllPageCache();
    if (window.caches && typeof window.caches.keys === 'function') {
        try {
            window.caches.keys().then(keys => {
                keys.forEach(key => {
                    try {
                        const deletion = window.caches.delete(key);
                        if (deletion && typeof deletion.catch === 'function') {
                            deletion.catch(() => {});
                        }
                    } catch (err) {
                        // Ignore per-cache deletion errors
                    }
                });
            }).catch(() => {});
        } catch (err) {
            // Ignore cache deletion errors
        }
    }

    try { localStorage.clear(); } catch(_) {}

    clearStoredSession();
    clearSessionFlag();
    try { sessionStorage.clear(); } catch(_) {}
    try { localStorage.removeItem('userSession'); } catch(_) {}
    try { localStorage.removeItem(SESSION_STORAGE_KEY); } catch(_) {}
    userSession = { isLoggedIn: false, role: null, contractor: null, token: null };

    const loginRendered = renderLoginTemplate();
    if (!loginRendered) {
        loadLoginPage();
    }
        google.script.run
          .withSuccessHandler(() => {
              if (!loginRendered) {
                  showApp();

              }
            })
            .withFailureHandler(err => {
                if (err) {
                    showError(err);
                }
            if (!loginRendered) {
                showApp();
            }
          })
        .logout(sessionToken || null);
    }

function resetInactivityTimer() {
    clearTimeout(inactivityTimer);
    inactivityTimer = setTimeout(() => {
        const t = translations[currentLang] || translations.vi || {};      
        Swal.fire({
            title: t.inactivity_title || t.warning_title || 'Thông báo:',
            text: t.inactivity_message || 'Bạn đã không sử dụng phần mềm quá lâu, vui lòng đăng nhập lại…',
            icon: 'warning',
            confirmButtonText: t.login_again_button || t.confirm_button || 'Đăng nhập lại',
            allowOutsideClick: false
        }).then(() => {
            handleLogout();
        });
    }, 30 * 60 * 1000);
}

function setupInactivityTimer() {
    $(document).on('mousemove mousedown keypress scroll touchstart', resetInactivityTimer);
    resetInactivityTimer();
}

function handleForgotPassword(e) {
    e.preventDefault();
    const t = translations[currentLang] || translations.vi || {};    
    Swal.fire({
        title: t.forgot_password_title || 'Quên mật khẩu',
        input: 'text',
        inputLabel: t.forgot_password_input_label || 'Vui lòng nhập tên đăng nhập của bạn',
        inputPlaceholder: t.forgot_password_input_placeholder || 'Tên đăng nhập',
        showCancelButton: true,
        confirmButtonText: t.continue_button || 'Tiếp tục',
        cancelButtonText: t.cancel_button || 'Hủy',
        inputValidator: (value) => {
            if (!value) {
                return t.forgot_password_input_required || 'Bạn cần nhập tên đăng nhập!';
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const username = result.value;
            Swal.fire({
                title: t.reset_password_title || 'Đặt lại mật khẩu',
                html: `
                    <input type="text" id="swal-securitycode" class="swal2-input" placeholder="${t.reset_password_security_placeholder || 'Mã bảo mật'}">
                    <input type="password" id="swal-newpassword" class="swal2-input" placeholder="${t.reset_password_new_placeholder || 'Mật khẩu mới'}">
                    <input type="password" id="swal-confirm" class="swal2-input" placeholder="${t.reset_password_confirm_placeholder || 'Xác nhận mật khẩu mới'}">
                `,
                confirmButtonText: t.confirm_button || 'Xác nhận',
                focusConfirm: false,
                preConfirm: () => {
                    const securityCode = $('#swal-securitycode').val();
                    const newPassword = $('#swal-newpassword').val();
                    const confirm = $('#swal-confirm').val();
                    if (!securityCode || !newPassword || !confirm) {
                        Swal.showValidationMessage(t.reset_password_missing_fields || 'Vui lòng điền đầy đủ thông tin');
                        return false;
                    } else if (newPassword !== confirm) {
                        Swal.showValidationMessage(t.reset_password_mismatch || 'Mật khẩu mới không khớp');
                        return false;
                    }
                    return { username: username, securityCode: securityCode, newPassword: newPassword };
                }
            }).then((formResult) => {
                if (formResult.isConfirmed) {
                    showLoading(t.loading_processing || 'Đang xử lý...');
                    google.script.run
                        .withSuccessHandler(message => {
                            Swal.fire(t.success_title || 'Thành công', message, 'success');
                        })
                        .withFailureHandler(showError)
                        .resetPassword(formResult.value);
                }
            });
        }
    });
}

// =================================================================
// ACCOUNT PAGE SPECIFIC FUNCTIONS
// =================================================================
function initGuidePage() {
  const container = $('#guide-page');
  if (!container.length) return;

  const role = getUserRole();
  const generalSection = container.find('[data-guide-role="general"]');
  const xpplSection = container.find('[data-guide-role="xppl"]');

  if (role === 'admin-xppl') {
    generalSection.addClass('d-none');
    xpplSection.removeClass('d-none');
  } else {
    xpplSection.addClass('d-none');
    generalSection.removeClass('d-none');
  }
}

function initAccountPage() {
    $('#changePasswordForm').on('submit', handleChangePassword);

    if (isRole('admin')) {
        $('#admin-user-management').removeClass('d-none');
        initUsersTable();
        $('#addNewUserBtn').on('click', handleAddNewUser);
    }
}

function initUsersTable() {
    const t = translations[currentLang];
    if ($.fn.DataTable.isDataTable('#usersTable')) {
        $('#usersTable').DataTable().destroy();
    }
    const columns = [
        { data: null, title: t.action_column, orderable: false, render: (data, type, row) => {
            return `
                <button class="btn btn-info btn-sm edit-user-btn" title="${t.edit_button}"><i class="fas fa-edit"></i></button>
                <button class="btn btn-secondary btn-sm reset-password-btn" title="Reset Password"><i class="fas fa-key"></i></button>
                <button class="btn btn-danger btn-sm delete-user-btn" title="${t.delete_button}"><i class="fas fa-trash-alt"></i></button>
            `;
        }},
        { data: 'Username', title: t.col_username },
        { data: 'Password', title: t.col_password },
        { data: 'Role', title: t.col_role },
        { data: 'Contractor', title: t.col_contractor },
        { data: 'CustomerName', title: t.col_customer_name, defaultContent: '' },
        { data: 'SecurityCode', title: t.col_security_code }
    ];

    usersTable = $('#usersTable').DataTable({
        processing: true,
        columns: columns,
        order: [[1, 'asc']],
        paging: false,
        info: false,
        data: []
    });

    fetchUsersData();

    $('#usersTable tbody').off('click').on('click', '.edit-user-btn', function() {
        const rowData = usersTable.row($(this).closest('tr')).data();
        handleEditUser(rowData);
    }).on('click', '.reset-password-btn', function() {
        const rowData = usersTable.row($(this).closest('tr')).data();
        handleResetPassword(rowData.Username);
    }).on('click', '.delete-user-btn', function() {
        const rowData = usersTable.row($(this).closest('tr')).data();
        handleDeleteUser(rowData.Username);
    });
}

// ... (Các hàm còn lại giữ nguyên logic, chỉ cần đảm bảo các chuỗi văn bản tĩnh đã được thay thế bằng key trong các file .html)
// ... (Tôi sẽ dán phần còn lại của file để đảm bảo tính toàn vẹn)

function fetchUsersData() {
    showLoading('Đang tải danh sách người dùng...');
    google.script.run
        .withSuccessHandler(data => {
            usersTable.clear().rows.add(data).draw();
        requestAnimationFrame(() => usersTable.columns.adjust());
            Swal.close();
        })
        .withFailureHandler(showError)
        .getUsers(userSession.token);
}

function handleEditUser(rowData) {
    const contractors = ['Hoanh Son', 'Nam Tien', 'PTS'];
    Swal.fire({
        title: `Chỉnh sửa: ${rowData.Username}`,
        html: `
            <div class="swal-form-group">
                <label for="swal-role">Phân quyền</label>
                <select id="swal-role" class="swal2-select">
                    <option value="user" ${normalizeRole(rowData.Role) === 'user' ? 'selected' : ''}>user</option>
                    <option value="admin" ${normalizeRole(rowData.Role) === 'admin' ? 'selected' : ''}>admin</option>
                    <option value="admin-xppl" ${normalizeRole(rowData.Role) === 'admin-xppl' ? 'selected' : ''}>admin-xppl</option>
                    <option value="User-Supervision" ${normalizeRole(rowData.Role) === 'user-supervision' ? 'selected' : ''}>User-Supervision</option>
                </select>
            </div>
            <div class="swal-form-group">
                <label for="swal-customer-name">Customer Name</label>
                <input id="swal-customer-name" class="swal2-input" value="${rowData.CustomerName || ''}" placeholder="Nhập tên khách hàng">
            </div>            
            <div class="swal-form-group">
                <label for="swal-contractor">Nhà thầu chính</label>
                <input id="swal-contractor" class="swal2-input" list="contractors-list" value="${rowData.Contractor || ''}">
                <datalist id="contractors-list">
                    ${contractors.map(c => `<option value="${c}">`).join('')}
                </datalist>
            </div>
        `,
        confirmButtonText: 'Lưu',
        preConfirm: () => {
            return {
                Username: rowData.Username,
                Role: $('#swal-role').val(),
                Contractor: $('#swal-contractor').val(),
                CustomerName: $('#swal-customer-name').val()
            }
        }
    }).then(result => {
        if (result.isConfirmed) {
            showLoading('Đang cập nhật...');
            google.script.run
                .withSuccessHandler(message => {
                    Swal.fire('Thành công!', message, 'success');
                    fetchUsersData();
                })
                .withFailureHandler(showError)
                .updateUser(result.value, userSession.token);
        }
    });
}

function handleResetPassword(username) {
    Swal.fire({
        title: 'Xác nhận',
        text: `Bạn có chắc muốn đặt lại mật khẩu cho ${username}? Mật khẩu mới sẽ được tạo ngẫu nhiên.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Xác nhận',
        cancelButtonText: 'Hủy'
    }).then(result => {
        if (result.isConfirmed) {
            showLoading('Đang xử lý...');
            google.script.run
                .withSuccessHandler(message => {
                    Swal.fire({
                        title: 'Thành công!',
                        html: `<p>Vui lòng sao chép và gửi thông tin này cho người dùng:</p><pre style="text-align:left; background-color:#f0f0f0; padding:10px; border-radius:5px;">${message}</pre>`,
                        icon: 'success'
                    });
                })
                .withFailureHandler(showError)
                .adminResetPassword(username, userSession.token);
        }
    });
}

function handleAddNewUser() {
    const contractors = ['Hoanh Son', 'Nam Tien', 'PTS'];
    Swal.fire({
        title: 'Thêm người dùng mới',
        html: `
            <div class="swal-form-group">
                <label for="swal-username">Tên đăng nhập</label>
                <input id="swal-username" class="swal2-input" placeholder="Tên đăng nhập">
            </div>
            <div class="swal-form-group">
                <label for="swal-role">Phân quyền</label>
                <select id="swal-role" class="swal2-select">
                    <option value="user">user</option>
                    <option value="admin">admin</option>
                    <option value="admin-xppl">admin-xppl</option>
                    <option value="User-Supervision">User-Supervision</option>                    
                </select>
            </div>
            <div class="swal-form-group">
                <label for="swal-customer-name">Customer Name</label>
                <input id="swal-customer-name" class="swal2-input" placeholder="Nhập tên khách hàng">
            </div>            
            <div class="swal-form-group">
                <label for="swal-contractor">Nhà thầu chính</label>
                <input id="swal-contractor" class="swal2-input" list="contractors-list" placeholder="Nhập hoặc chọn nhà thầu">
                <datalist id="contractors-list">
                    ${contractors.map(c => `<option value="${c}">`).join('')}
                </datalist>
            </div>
        `,
        confirmButtonText: 'Tạo',
        preConfirm: () => {
            const username = $('#swal-username').val();
            if (!username) {
                Swal.showValidationMessage('Tên đăng nhập không được để trống');
            }
            return {
                Username: username,
                Role: $('#swal-role').val(),
                Contractor: $('#swal-contractor').val(),
                CustomerName: $('#swal-customer-name').val()
            }
        }
    }).then(result => {
        if (result.isConfirmed) {
            showLoading('Đang tạo người dùng...');
            google.script.run
                .withSuccessHandler(message => {
                    Swal.fire({
                        title: 'Thành công!',
                        html: `<p>Vui lòng sao chép và gửi thông tin này cho người dùng:</p><pre style="text-align:left; background-color:#f0f0f0; padding:10px; border-radius:5px;">${message}</pre>`,
                        icon: 'success'
                    });
                    fetchUsersData();
                })
                .withFailureHandler(showError)
                .addNewUser(result.value, userSession.token);
        }
    });
}

function handleDeleteUser(username) {
    Swal.fire({
        title: 'Xác nhận xóa',
        text: `Bạn có chắc chắn muốn xóa vĩnh viễn người dùng "${username}"? Hành động này không thể hoàn tác.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Vâng, xóa đi!',
        cancelButtonText: 'Hủy'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading('Đang xóa người dùng...');
            google.script.run
                .withSuccessHandler(message => {
                    Swal.fire('Đã xóa!', message, 'success');
                    fetchUsersData();
                })
                .withFailureHandler(showError)
                .deleteUser(username, userSession.token);
        }
    });
}

function handleChangePassword(e) {
    e.preventDefault();
    const currentPassword = $('#currentPassword').val();
    const newPassword = $('#newPassword').val();
    const confirmNewPassword = $('#confirmNewPassword').val();

    if (newPassword !== confirmNewPassword) {
        showError({ message: 'Mật khẩu mới và xác nhận mật khẩu không khớp.' });
        return;
    }

    showLoading('Đang xử lý...');
    google.script.run
        .withSuccessHandler(message => {
            Swal.fire('Thành công!', message, 'success');
            $('#changePasswordForm')[0].reset();
        })
        .withFailureHandler(showError)
        .changePassword({ currentPassword, newPassword }, userSession.token);
}

function initRegisterPage() {
  ensureVietnamTime();
  const t = translations[currentLang];

  setupCustomFileInput('#fileUploader', {
    trigger: '#fileUploaderTrigger',
    display: '#fileUploaderDisplay',
    defaultKey: 'file_no_file_selected'
  });

  let dateControl = $('#formRegisterDate');

  google.script.run
    .withSuccessHandler(status => {
      if (userSession.role === 'admin') {
        const nowVietnam = getVietnamNowClient();
        const today = new Date(nowVietnam.getTime());
        const todayInput = getVietnamIsoDate(today);
        dateControl.replaceWith(`<input type="date" id="formRegisterDate" class="form-control form-control-sm" value="${todayInput}">`);
        dateControl = $('#formRegisterDate');
        $('#upload-date-note').text('');
        $('#registration-open-notice, #registration-closed-notice').addClass('d-none');
        $('#registration-locked-overlay').addClass('d-none');
        const contentCards = $('#registration-content .card');
        contentCards.removeClass('opacity-50 disabled-card');
        contentCards.find('input, select, button').prop('disabled', false);
        refreshUploadSaveButtonState();
      } else {
        startRegistrationTimer(status);
      }
    })
    .withFailureHandler(showError)
    .checkRegistrationTime();

  $('#manualEntryForm').off('submit').on('submit', handleManualAdd);
  $('#uploadButton').off('click').on('click', handleFileUpload);
  $('#saveUploadBtn').off('click').on('click', handleSaveUploadedData);

  google.script.run
    .withSuccessHandler(list => {
      allowedCompanies = (list || []).filter(Boolean);
      const $sel = $('#formTransportationCompany');

      if (isRole('user')) {
        const me = String((userSession.contractor || '')).trim();
        if (me) {
          $sel.html(`<option value="${me}">${me}</option>`)
              .val(me)
              .prop('disabled', true)
              .addClass('bg-light');
        } else {
          const firstOption = t.select_company_option || 'Chọn đơn vị';
          const html = [`<option value="">${firstOption}</option>`,
                        ...allowedCompanies.map(c => `<option value="${c}">${c}</option>`)].join('');
          $sel.html(html).prop('disabled', false).removeClass('bg-light');
        }
      } else {
        const firstOption = t.select_company_option || 'Chọn đơn vị';
        const html = [`<option value="">${firstOption}</option>`,
                      ...allowedCompanies.map(c => `<option value="${c}">${c}</option>`)].join('');
        $sel.html(html).prop('disabled', false).removeClass('bg-light');
      }
    })
    .withFailureHandler(showError)
    .getTransportCompanies();

  loadActiveContractNosForRegister();
  refreshUploadSaveButtonState();
}



let latestRegistrationStatus = null;

function updateUserDateSelector(status) {
  if (!isRole('user')) return;

  const dateControl = $('#formRegisterDate');
  if (!dateControl.length) return;

  const nowVietnam = getVietnamNowClient();
  const today = new Date(nowVietnam.getTime());
  const tomorrow = addVietnamDays(today, 1);
  const todayStr = getFormattedDate(today);
  const tomorrowStr = getFormattedDate(tomorrow);
  const t = translations[currentLang] || {};

  const options = [];
  const allowedDates = [];

  if (status && status.allowToday) {
    const todayLabelTemplate = t.register_today_option || `Hôm nay ({date})`;
    const todayLabel = todayLabelTemplate.replace('{date}', todayStr);
    options.push({ value: todayStr, label: todayLabel });
    allowedDates.push(todayStr);
  }

  if (status && status.allowTomorrow) {
    const tomorrowLabelTemplate = t.register_tomorrow_option || `Ngày mai ({date})`;
    const tomorrowLabel = tomorrowLabelTemplate.replace('{date}', tomorrowStr);
    options.push({ value: tomorrowStr, label: tomorrowLabel });
    allowedDates.push(tomorrowStr);
  }

  const previousValue = dateControl.val();
  dateControl.empty();

  if (!options.length) {
    dateControl.append('<option value=""></option>');
    dateControl.val('');
    dateControl.prop('disabled', true);
  } else {
    options.forEach(opt => {
      dateControl.append(`<option value="${opt.value}">${opt.label}</option>`);
    });
    if (previousValue && allowedDates.includes(previousValue)) {
      dateControl.val(previousValue);
    } else {
      dateControl.val(options[0].value);
    }
    dateControl.prop('disabled', false);
  }

  const noteElement = $('#upload-date-note');
  let noteText = '';
  if (allowedDates.length === 1) {
    const singleTemplate = t.register_upload_date_note_single || t.register_upload_date_note || '';
    noteText = singleTemplate.replace('{date}', allowedDates[0]);
  } else if (allowedDates.length > 1) {
    const joinWord = t.register_date_join_word || 'or';
    const joinedDates = allowedDates.join(` ${joinWord} `);
    const multiTemplate = t.register_upload_date_note_multi || t.register_upload_date_note_single || '';
    noteText = multiTemplate.replace('{dates}', joinedDates).replace('{date}', joinedDates);
  }
  noteElement.text(noteText);
}

function updateRegistrationUiForStatus(status) {
  latestRegistrationStatus = status || null;

  const openNotice = $('#registration-open-notice');
  const closedNotice = $('#registration-closed-notice');
  const overlay = $('#registration-locked-overlay');
  const contentCards = $('#registration-content .card');
  const isUser = isRole('user');
  const t = translations[currentLang] || {};
  const isOpen = Boolean(status && status.isOpen);

  const openMessage = t.reg_open_message_text || 'Hệ thống đăng ký bốc hàng sẽ đóng sau:';
  const closedMessage = t.reg_closed_message_text || 'Hệ thống đăng ký bốc hàng đang đóng.';
  openNotice.find('#open-message').text(openMessage);
  closedNotice.find('#closed-message').text(closedMessage);

  if (isOpen) {
    openNotice.removeClass('d-none');
    closedNotice.addClass('d-none');
    overlay.addClass('d-none');
  } else {
    closedNotice.removeClass('d-none');
    openNotice.addClass('d-none');
    overlay.removeClass('d-none');
    overlay.find('[data-translate="reg_readonly_notice"]').text(t.reg_readonly_notice || 'Biểu mẫu đang ở trạng thái chỉ xem.');
  }

  contentCards.removeClass('d-none');
  contentCards.toggleClass('opacity-50', !isOpen);
  contentCards.toggleClass('disabled-card', !isOpen);
  contentCards.find('input, select, button, textarea').prop('disabled', !isOpen);

  if (isOpen && isUser) {
    $('#formTransportationCompany').prop('disabled', true);
  }

  if (!isOpen) {
    $('#previewContainer').addClass('d-none');
  }

  refreshUploadSaveButtonState();
  updateUserDateSelector(status);
}

function isRegistrationOpen() {
    if (hasAnyRole(['admin'])) {
    return true;
  }
  return Boolean(latestRegistrationStatus && latestRegistrationStatus.isOpen);
}

function refreshUploadSaveButtonState() {
  const saveBtn = $('#saveUploadBtn');
  if (!saveBtn.length) return;

  const hasData = Array.isArray(previewTableData) && previewTableData.length > 0;
  const hasErrors = hasData && previewTableData.some(row => row && row.errors);
  const hasValidRows = hasData && previewTableData.some(row => row && !row.errors);
  const shouldEnable = isRegistrationOpen() && hasData && !hasErrors && hasValidRows;
  saveBtn.prop('disabled', !shouldEnable);
}

function updateRegistrationCountdownTargets(status) {
  if (!status) {
    registrationCountdownTargets = { close: null, open: null };
    return;
  }

  const serverEpoch = Number(status.serverEpochMillis);
  const nowBase = Number.isFinite(serverEpoch) ? serverEpoch : Date.now();

  if (status.isOpen) {
    const timeToClose = Math.max(0, Number(status.timeToClose) || 0);
    registrationCountdownTargets.close = nowBase + timeToClose;
    registrationCountdownTargets.open = null;
  } else {
    const timeToOpen = Math.max(0, Number(status.timeToOpen) || 0);
    registrationCountdownTargets.open = nowBase + timeToOpen;
    registrationCountdownTargets.close = null;
  }
}

function getActiveCountdownTarget() {
  if (!latestRegistrationStatus) return null;
  return latestRegistrationStatus.isOpen ? registrationCountdownTargets.close : registrationCountdownTargets.open;
}

function formatCountdown(milliseconds) {
  const safeMs = Math.max(0, Number(milliseconds) || 0);
  const totalSeconds = Math.floor(safeMs / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function updateRegistrationCountdownDisplays() {
  const openNotice = $('#registration-open-notice');
  const closedNotice = $('#registration-closed-notice');

  if (!latestRegistrationStatus) {
    openNotice.find('#countdown-timer-open').text('--:--:--');
    closedNotice.find('#countdown-timer-closed').text('--:--:--');
    return;
  }

  const now = Date.now();
  if (latestRegistrationStatus.isOpen) {
    const remaining = registrationCountdownTargets.close != null
      ? Math.max(0, registrationCountdownTargets.close - now)
      : 0;
    openNotice.find('#countdown-timer-open').text(formatCountdown(remaining));
    closedNotice.find('#countdown-timer-closed').text('--:--:--');
  } else {
    const remaining = registrationCountdownTargets.open != null
      ? Math.max(0, registrationCountdownTargets.open - now)
      : 0;
    closedNotice.find('#countdown-timer-closed').text(formatCountdown(remaining));
    openNotice.find('#countdown-timer-open').text('--:--:--');
  }
}

function applyRegistrationStatus(status) {
  updateRegistrationUiForStatus(status);
  updateRegistrationCountdownTargets(status);
  updateRegistrationCountdownDisplays();
}

function fetchRegistrationStatus(force = false) {
  if (registrationStatusFetchInFlight) return;

  const now = Date.now();
  if (!force && now - lastRegistrationStatusFetch < REGISTRATION_STATUS_REFRESH_MS) {
    return;
  }

  registrationStatusFetchInFlight = true;
  google.script.run
    .withSuccessHandler(status => {
      registrationStatusFetchInFlight = false;
      lastRegistrationStatusFetch = Date.now();
      applyRegistrationStatus(status || null);
    })
    .withFailureHandler(error => {
      registrationStatusFetchInFlight = false;
      showError(error);
    })
    .checkRegistrationTime();
}

function startRegistrationTimer(initialStatus) {
  if (registrationTimerInterval) {
    clearInterval(registrationTimerInterval);
  }

  registrationStatusFetchInFlight = false;

  if (initialStatus) {
    lastRegistrationStatusFetch = Date.now();
    applyRegistrationStatus(initialStatus);
  } else if (latestRegistrationStatus) {
    applyRegistrationStatus(latestRegistrationStatus);
  } else {
    lastRegistrationStatusFetch = 0;
  }

  const tick = () => {
    updateRegistrationCountdownDisplays();
    const now = Date.now();
    const target = getActiveCountdownTarget();

    if (target != null && target - now <= 0) {
      fetchRegistrationStatus(true);
    } else if (now - lastRegistrationStatusFetch >= REGISTRATION_STATUS_REFRESH_MS) {
      fetchRegistrationStatus(false);
    }
  };

  tick();
  registrationTimerInterval = setInterval(tick, 1000);

  if (!initialStatus) {
    fetchRegistrationStatus(true);
  }
}

// === THAY TOÀN BỘ HÀM NÀY ===
function handleManualAdd(e) {
  e.preventDefault();

  // Lấy đúng id các input trên Page_Register.html
  const rawRegisterDate     = $('#formRegisterDate').val();
  const registerDate        = normalizeRegisterDateValue(rawRegisterDate);               // KHÔNG thêm dấu ' ở client
  const contractNo          = $('#manual-contractNo').val().trim();
  const truckPlate          = $('#formTruckPlate').val().trim();
  const country             = $('#formCountry').val();
  const wheel               = $('#formWheel').val().trim();
  const trailerPlate        = $('#formTrailerPlate').val().trim();
  const truckWeight         = $('#formTruckWeight').val().trim();
  const payLoad             = $('#formPayLoad').val().trim();
  const containerNo1        = $('#formContainerNo1').val().trim();
  const containerNo2        = $('#formContainerNo2').val().trim();
  const driverName          = $('#formDriverName').val().trim();
  const driverIdPassport    = $('#formIdPassport').val().trim();          // <-- id đúng là formIdPassport
  const phoneNumber         = $('#formPhoneNumber').val().trim();
  const destinationEST      = $('#formDestinationEST').val().trim();
  const transportationCompany = $('#formTransportationCompany').val();
  const subcontractor       = $('#formSubcontractor').val().trim();
  const vehicleStatus       = $('#formVehicleStatus').val();
  const t = translations[currentLang];  

  if (!registerDate || !contractNo || !truckPlate) {
    Swal.fire(t.register_missing_data_title || 'Thiếu dữ liệu',
              t.register_missing_data_message || 'Vui lòng nhập Ngày đăng ký, Số hợp đồng và Biển số xe.',
              'warning');
    return;
  }

  // GỬI ĐỦ CÁC CỘT giống header dữ liệu đăng ký xe
  const record = {
    'Register Date'       : registerDate,          // Gửi dạng "DD/MM/YYYY" bình thường
    'Contract No'         : contractNo,
    'Truck Plate'         : truckPlate,
    'Country'             : country,
    'Wheel'               : wheel,
    'Trailer Plate'       : trailerPlate,
    'Truck weight'        : truckWeight,
    'Pay load'            : payLoad,
    'Container No1'       : containerNo1,
    'Container No2'       : containerNo2,
    'Driver Name'         : driverName,
    'ID/Passport'         : driverIdPassport,
    'Phone number'        : phoneNumber,
    'Destination EST'     : destinationEST,
    'Transportation Company': transportationCompany,
    'Subcontractor'       : subcontractor,
    'Vehicle Status'      : vehicleStatus
  };

  showLoading(t.loading_saving_data || 'Đang lưu dữ liệu...');
  google.script.run
    .withSuccessHandler(msg => {
      Swal.close();
      Swal.fire(t.success_title || 'Thành công',
                msg || t.register_success_message || 'Đăng ký xe thành công!',
                'success');
      $('#manualEntryForm')[0].reset();
      if (typeof registeredVehicleTable !== 'undefined') {
        registeredVehicleTable.ajax.reload(null, false);
      }
    })
    .withFailureHandler(showError)
    .addManualVehicle(record, userSession.token, currentLang);
}


function handleFileUpload() {
    const file = $('#fileUploader')[0].files[0];
    const t = translations[currentLang];
    if (!file) {
        Swal.fire(t.no_file_selected_title || 'Chưa chọn file',
                  t.no_file_selected_message || 'Vui lòng chọn một file.',
                  'warning');
        return;
    }
    showLoadingDeferred(t.loading_processing_file || 'Đang xử lý và xác thực file...', 120);
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const workbook = XLSX.read(e.target.result, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

            if (jsonData.length < 2) throw new Error(t.file_no_data_error || 'File không có dữ liệu.');

            const { data, errors } = validateAndTransformData(jsonData.slice(1));

            previewTableData = data;

            const columns = [
                { data: 'ID', title: t.col_id || 'ID' },
                {
                    data: 'Register Date',
                    title: t.col_register_date || 'Register Date',
                    render: (data, type) => {
                        const parsed = parseRegisterDateValue(data);
                        if (type === 'sort' || type === 'type') {
                            return parsed ? parsed.toISOString() : (data == null ? '' : data);
                        }
                        return formatRegisterDateForDisplay(data);
                    }
                },
                { data: 'Contract No', title: t.col_contract_no || 'Contract No' },
                { data: 'Truck Plate', title: t.col_truck_plate || 'Truck Plate' },
                { data: 'Country', title: t.col_country || 'Country' },
                { data: 'Wheel', title: t.col_wheel || 'Wheel' },
                { data: 'Trailer Plate', title: t.col_trailer_plate || 'Trailer Plate' },
                { data: 'Truck weight', title: t.col_truck_weight || 'Truck weight' },
                { data: 'Pay load', title: t.col_payload || 'Pay load' },
                { data: 'Container No1', title: t.col_container1 || 'Container 1' },
                { data: 'Container No2', title: t.col_container2 || 'Container 2' },
                { data: 'Driver Name', title: t.col_driver_name || 'Driver Name' },
                { data: 'ID/Passport', title: t.col_id_passport || 'ID/Passport' },
                { data: 'Phone number', title: t.col_phone_number || 'Phone number' },
                { data: 'Destination EST', title: t.col_destination || 'Destination EST' },
                { data: 'Transportation Company', title: t.col_transport_company || 'Transportation Company' },
                { data: 'Subcontractor', title: t.col_subcontractor || 'Subcontractor' },
                { data: 'Vehicle Status', title: t.col_vehicle_status || 'Vehicle Status' }
            ];

            if ($.fn.DataTable.isDataTable('#previewDataTable')) {
                $('#previewDataTable').DataTable().destroy();
            }

            previewDataTable = $('#previewDataTable').DataTable({
                data: previewTableData,
                columns: columns,
                paging: false,
                info: false,
                searching: false,
                scrollX: true,
                createdRow: function(row, rowData) {
                    if (rowData.errors) {
                        for (const key in rowData.errors) {
                            const colIndex = columns.findIndex(c => c.data === key);
                            if (colIndex !== -1) {
                                $(row).find('td').eq(colIndex).addClass('is-invalid').attr('title', rowData.errors[key]);
                            }
                        }
                    }
                }
            });

            $('#previewContainer').removeClass('d-none');
            requestAnimationFrame(() => previewDataTable.columns.adjust());

            dismissLoading();

            if (errors.length > 0) {
                const maxErrorsToShow = 10;
                const slicedErrors = errors.slice(0, maxErrorsToShow);
                let errorHtml = `<p>${t.upload_errors_intro || 'Phát hiện lỗi trong file tải lên. Vui lòng sửa lại file Excel và thử lại. Các ô màu đỏ là các ô bị lỗi.'}</p><ul class="text-start">`;
                slicedErrors.forEach(err => { errorHtml += `<li>${err}</li>`; });
                if(errors.length > maxErrorsToShow) {
                    errorHtml += `<li>${t.upload_errors_more || '... và nhiều lỗi khác.'}</li>`;
                }
                errorHtml += '</ul>';
                Swal.fire({
                    icon: 'error',
                    title: t.invalid_data_title || 'Dữ liệu không hợp lệ!',
                    html: errorHtml
                });
            }

            refreshUploadSaveButtonState();
        } catch (error) {
            dismissLoading(true);
            showError({ message: error.message });
        }
    };
    reader.onerror = function() {
        dismissLoading(true);
        showError({ message: t.file_read_error || 'Không thể đọc file tải lên. Vui lòng thử lại.' });
    };
    reader.readAsArrayBuffer(file);
}

function parseRegisterDateValue(value) {
    const result = parseExcelDateDetailed(value, { preferDayFirst: true });
    if (result && result.date) {
        return result.date;
    }
    if (typeof value === 'string' && value.trim()) {
        const parsed = parseDateValue(value.trim());
        if (parsed) return parsed;
    }
    if (value instanceof Date && !isNaN(value)) {
        return value;
    }
    return null;
}

function formatRegisterDateForDisplay(value) {
    const parsed = parseRegisterDateValue(value);
    if (parsed) {
        return getFormattedDate(parsed);
    }
    if (value === null || value === undefined) return '';
    return String(value);
}

function validateAndTransformData(dataRows) {
    ensureVietnamTime();
    const nowVietnam = getVietnamNowClient();
    const today = new Date(nowVietnam.getTime());
    const tomorrow = addVietnamDays(today, 1);
    const todayStr = getFormattedDate(today);
    const tomorrowStr = getFormattedDate(tomorrow);
    const todayParts = getVietnamDateParts(today);
    const todayUtcDate = todayParts
        ? createUtcDate(
            Number.parseInt(todayParts.year, 10),
            Number.parseInt(todayParts.month, 10),
            Number.parseInt(todayParts.day, 10)
        )
        : null;
    const tomorrowParts = getVietnamDateParts(tomorrow);
    const tomorrowUtcDate = tomorrowParts
        ? createUtcDate(
            Number.parseInt(tomorrowParts.year, 10),
            Number.parseInt(tomorrowParts.month, 10),
            Number.parseInt(tomorrowParts.day, 10)
        )
        : null;
    const todayKey = todayUtcDate ? toUtcDateKey(todayUtcDate) : '';
    const tomorrowKey = tomorrowUtcDate ? toUtcDateKey(tomorrowUtcDate) : '';
    const nowParts = getVietnamDateParts(nowVietnam);
    const currentHour = nowParts && nowParts.hour ? parseInt(nowParts.hour, 10) : nowVietnam.getHours();
    const currentMinute = nowParts && nowParts.minute ? parseInt(nowParts.minute, 10) : nowVietnam.getMinutes();
    const currentMinutesTotal = (isNaN(currentHour) ? nowVietnam.getHours() : currentHour) * 60
      + (isNaN(currentMinute) ? nowVietnam.getMinutes() : currentMinute);

    const transformedData = [];
    const allErrors = [];
    
    const allowedStatus = ['RO', 'CO', 'PM', 'CM', 'AC', 'ND'];
    const allowedCountries = ['Vietnam', 'Laos'];
    const isAdmin = isRole('admin');
    const isUserRole = isRole('user');
    const status = latestRegistrationStatus || {};
    const userAllowsToday    = isUserRole && !!status.allowToday;
    const userAllowsTomorrow = isUserRole && !!status.allowTomorrow;

    const t = translations[currentLang];
    const formatMessage = (template, replacements = {}) => {
        let str = template || '';
        Object.entries(replacements).forEach(([key, value]) => {
            str = str.replace(new RegExp(`\{${key}\}`, 'g'), value);
        });
        return str;
    };

    const columnNames = {
        'Register Date': t.col_register_date || 'Register Date',
        'Contract No': t.col_contract_no || 'Contract No',
        'Truck Plate': t.col_truck_plate || 'Truck Plate',
        'Country': t.col_country || 'Country',
        'Wheel': t.col_wheel || 'Wheel',
        'Trailer Plate': t.col_trailer_plate || 'Trailer Plate',
        'Truck weight': t.col_truck_weight || 'Truck weight',
        'Pay load': t.col_payload || 'Pay load',
        'Container No1': t.col_container1 || 'Container No1',
        'Container No2': t.col_container2 || 'Container No2',
        'Driver Name': t.col_driver_name || 'Driver Name',
        'ID/Passport': t.col_id_passport || 'ID/Passport',
        'Phone number': t.col_phone_number || 'Phone number',
        'Destination EST': t.col_destination || 'Destination EST',
        'Transportation Company': t.col_transport_company || 'Transportation Company',
        'Subcontractor': t.col_subcontractor || 'Subcontractor',
        'Vehicle Status': t.col_vehicle_status || 'Vehicle Status'
    };

    dataRows.forEach((row, index) => {
        if (row.length === 0 || row.every(cell => cell === "")) return;

        const rowIndexForError = index + 2;
        const rowErrors = {};

        const appendError = (field, template, replacements = {}) => {
            const msg = formatMessage(template, replacements);
            if (!msg) return;
            rowErrors[field] = rowErrors[field] ? `${rowErrors[field]} ${msg}` : msg;
        };
        
        const record = {
            // Leave ID empty so Supabase can assign it automatically when saving
            'ID': '',
            'Register Date': row[1] || '', 'Contract No': row[2] || '',
            'Truck Plate': String(row[3] || '').replace(/\s/g, '').toUpperCase(), 'Country': row[4] || '',
            'Wheel': row[5] || '', 'Trailer Plate': String(row[6] || '').replace(/\s/g, '').toUpperCase(),
            'Truck weight': row[7] || '', 'Pay load': row[8] || '', 'Container No1': row[9] || '',
            'Container No2': row[10] || '', 'Driver Name': row[11] || '', 'ID/Passport': row[12] || '',
            'Phone number': row[13] || '', 'Destination EST': row[14] || '',
            'Transportation Company': row[15] || '', 'Subcontractor': row[16] || '',
            'Vehicle Status': String(row[17] || '').toUpperCase()
        };

        const requiredFields = ['Contract No', 'Truck Plate', 'Country', 'Wheel', 'Truck weight', 'Pay load', 'Driver Name', 'ID/Passport', 'Destination EST', 'Transportation Company', 'Subcontractor', 'Vehicle Status'];
        requiredFields.forEach(field => {
            if (!record[field]) {
                appendError(field, t.validation_required || "- Cột '{field}' không được để trống.", { field: columnNames[field] });
            }
        });

        const expectedDateForParsing = (!isAdmin && isUserRole && !userAllowsToday && userAllowsTomorrow)
            ? tomorrowUtcDate
            : null;
        const dateParseResult = parseExcelDateDetailed(record['Register Date'], {
            expectedDate: expectedDateForParsing,
            strictAmbiguity: isUserRole,
            requireExpected: Boolean(isUserRole && !userAllowsToday && userAllowsTomorrow)
        });

        if (!dateParseResult.date) {
            const errorCode = dateParseResult.errorCode;
            if (errorCode === 'ambiguous') {
                appendError('Register Date', t.validation_ambiguous_date || "- Cột '{field}' có định dạng ngày không xác định rõ (dd/MM/yyyy hay MM/dd/yyyy). Vui lòng kiểm tra lại.", { field: columnNames['Register Date'] });
            } else if (errorCode === 'unexpected') {
                appendError('Register Date', t.validation_only_tomorrow || "- Cột '{field}' chỉ chấp nhận ngày mai.", { field: columnNames['Register Date'] });
            } else {
                appendError('Register Date', t.validation_invalid_date || "- Cột '{field}' có định dạng ngày không hợp lệ.", { field: columnNames['Register Date'] });
            }
        } else {
            const dateStr = getFormattedDate(dateParseResult.date);
            const parsedDateKey = toUtcDateKey(dateParseResult.date);
            const isTomorrow = parsedDateKey && parsedDateKey === tomorrowKey;

            if (isUserRole) {
                const allowedDates = [];
                const allowedDateKeys = [];
                if (userAllowsToday) {
                    allowedDates.push(todayStr);
                    if (todayKey) allowedDateKeys.push(todayKey);
                }
                if (userAllowsTomorrow) {
                    allowedDates.push(tomorrowStr);
                    if (tomorrowKey) allowedDateKeys.push(tomorrowKey);
                }

                if (!allowedDates.length) {
                    appendError('Register Date', t.validation_only_tomorrow || "- Cột '{field}' chỉ chấp nhận ngày mai.", { field: columnNames['Register Date'] });
                } else {
                    const matchesKey = parsedDateKey && allowedDateKeys.includes(parsedDateKey);
                    const matchesString = allowedDates.includes(dateStr);
                    if (!matchesKey && !matchesString) {
                        const joinWord = t.register_date_join_word || 'or';
                        const allowedText = allowedDates.join(` ${joinWord} `);
                        const template = allowedDates.length > 1
                            ? (t.validation_only_today_or_tomorrow || "- Cột '{field}' chỉ chấp nhận {dates}.")
                            : (t.validation_only_tomorrow || "- Cột '{field}' chỉ chấp nhận ngày mai.");
                        appendError('Register Date', template, { field: columnNames['Register Date'], dates: allowedText });
                    }
                }
                record['Register Date'] = dateStr;
            } else {
                if (!isAdmin) {
                    const withinWindow = currentMinutesTotal >= 7 * 60 && currentMinutesTotal < 16 * 60;
                    if (withinWindow && !isTomorrow) {
                        appendError('Register Date', t.validation_only_tomorrow || "- Cột '{field}' chỉ chấp nhận ngày mai.", { field: columnNames['Register Date'] });
                    }
                }
                record['Register Date'] = dateStr;
            }
        }

        if (record['Truck Plate'].length > 11) {
            appendError('Truck Plate', t.validation_max_length || "- Cột '{field}' không được vượt quá {max} ký tự.", { field: columnNames['Truck Plate'], max: 11 });
        }
        if (record['Country'] && !allowedCountries.includes(record['Country'])) {
            appendError('Country', t.validation_allowed_values || "- Cột '{field}' chỉ chấp nhận: {values}.", { field: columnNames['Country'], values: allowedCountries.join(', ') });
        }
        if (record['Trailer Plate'].length > 11) {
            appendError('Trailer Plate', t.validation_max_length || "- Cột '{field}' không được vượt quá {max} ký tự.", { field: columnNames['Trailer Plate'], max: 11 });
        }
        
        const numericFields = {'Wheel': 1000, 'Truck weight': 1000, 'Pay load': 1000, 'Phone number': Infinity};
        for (const field in numericFields) {
            if (!record[field]) continue;
            const value = parseFloat(record[field]);
            if (isNaN(value)) {
                appendError(field, t.validation_numeric_only || "- Cột '{field}' phải là số.", { field: columnNames[field] });
            } else if (numericFields[field] !== Infinity && value > numericFields[field]) {
                appendError(field, t.validation_numeric_max || "- Cột '{field}' phải là số và không quá {max}.", { field: columnNames[field], max: numericFields[field] });
            }
        }

        const textLengthFields = {'Container No1': 70, 'Container No2': 70, 'Driver Name': 70, 'ID/Passport': 70, 'Destination EST': 70, 'Subcontractor': 70};
        for(const field in textLengthFields) {
            if (String(record[field]).length > textLengthFields[field]) {
                appendError(field, t.validation_max_length || "- Cột '{field}' không được vượt quá {max} ký tự.", { field: columnNames[field], max: textLengthFields[field] });
            }
        }

        if (record['Vehicle Status'] && !allowedStatus.includes(record['Vehicle Status'])) {
            appendError('Vehicle Status', t.validation_allowed_values || "- Cột '{field}' chỉ chấp nhận: {values}.", { field: columnNames['Vehicle Status'], values: allowedStatus.join(', ') });
        }
        
        if (isUserRole) {
            if (record['Transportation Company'] && record['Transportation Company'] !== userSession.contractor) {
                appendError('Transportation Company', t.validation_contractor_mismatch || '- Bạn chỉ có thể đăng ký cho nhà thầu của mình ({contractor}).', { contractor: userSession.contractor });
            }
            record['Transportation Company'] = userSession.contractor;
        } else {
            if (record['Transportation Company'] && !allowedCompanies.includes(record['Transportation Company'])) {
                appendError('Transportation Company', t.validation_allowed_values || "- Cột '{field}' chỉ chấp nhận: {values}.", { field: columnNames['Transportation Company'], values: allowedCompanies.join(', ') });
            }
        }
        
        if (Object.keys(rowErrors).length > 0) {
            const errorMessages = Object.values(rowErrors).map(msg => msg.trim()).join('<br>');
            const rowLabel = formatMessage(t.validation_row_label || 'Dòng {row}', { row: rowIndexForError });
            allErrors.push(`<b>${rowLabel}:</b><br>${errorMessages}`);
            record.errors = rowErrors;
        }

        record['Register Date'] = formatRegisterDateForDisplay(record['Register Date']);
        transformedData.push(record);
    });

    const seen = new Map();
    transformedData.forEach((record, index) => {
        if (record.errors) return;
        const key = `${record['Register Date']}-${record['Truck Plate']}-${record['Transportation Company']}`;
        if (seen.has(key)) {
            const firstIndex = seen.get(key);
            if (!transformedData[firstIndex].errors) transformedData[firstIndex].errors = {};
            if (!record.errors) record.errors = {};
            
            const errorMessage = t.duplicate_data_error || 'Dữ liệu trùng lặp trong file.';
            transformedData[firstIndex].errors['ID'] = errorMessage;
            record.errors['ID'] = errorMessage;

            const duplicateLabel = formatMessage(t.validation_duplicate_rows || 'Dòng {row1} và {row2}', { row1: firstIndex + 2, row2: index + 2 });
            const duplicateDetail = t.validation_duplicate_details || 'Trùng lặp dữ liệu (Ngày, Biển số xe, ĐVVC).';
            allErrors.push(`<b>${duplicateLabel}:</b> ${duplicateDetail}`);
        } else {
            seen.set(key, index);
        }
    });

    return { data: transformedData, errors: allErrors };
}

function handleSaveUploadedData() {
    const dataToSave = previewTableData.filter(row => !row.errors);
    const sanitizedDataToSave = dataToSave.map(row => {
        if (!row || typeof row !== 'object') return row;
        // Remove ID so Supabase can auto-generate it on insert
        const { ID, ...rest } = row;
        return rest;
    });
    const t = translations[currentLang];
    if (dataToSave.length === 0) {
        Swal.fire(t.no_valid_data_title || 'Không có dữ liệu hợp lệ',
                  t.no_valid_data_message || 'Không có dữ liệu nào để lưu.',
                  'error');
        return;
    }

    showLoadingDeferred(t.loading_checking_data || 'Đang kiểm tra và lưu dữ liệu...', 120);
    google.script.run
        .withSuccessHandler(message => {
            dismissLoading();
            Swal.fire(t.success_title || 'Thành công', message, 'success');
            previewTableData = [];
            if($.fn.DataTable.isDataTable('#previewDataTable')) $('#previewDataTable').DataTable().clear().destroy();
            $('#previewContainer').addClass('d-none');
            $('#fileUploader').val('').trigger('change');
            refreshUploadSaveButtonState();
        })
        .withFailureHandler(err => { dismissLoading(true); showError(err); })
        .saveData(sanitizedDataToSave, userSession.token, currentLang);
}

function initializeDataTable(config) {
    const {
        tableId,
        columns,
        ajaxFunction,
        getExtraParams = () => ({}),
        searchControl,
        lengthControl,
        deleteButton,
        selectAllCheckbox,
        enableSelect = true,
        pageLength = 50,
        order: initialOrder
    } = config;

    if ($.fn.DataTable.isDataTable(`#${tableId}`)) {
        $(`#${tableId}`).DataTable().destroy();
    }

    const options = {
        processing: true,
        serverSide: true,
        ajax: function(data, callback, settings) {
            let params = {
                draw: data.draw,
                start: data.start,
                length: data.length,
                search: data.search,
                order: data.order,
                sessionToken: userSession.token,
                ...getExtraParams()
            };
            ajaxFunction(params, callback);
        },
        columns: columns,
        paging: true,
        lengthChange: false,
        searching: true,
        info: true,
        autoWidth: false,
        deferRender: true,
        scrollX: true,
        stateSave: true,
        select: enableSelect ? { style: 'multi', selector: 'td:first-child .row-checkbox' } : false,
        pageLength: pageLength,
        language: {
            "processing": translations[currentLang].dt_processing || "Đang xử lý...",
            "lengthMenu": `${translations[currentLang].show_label || "Hiển thị"} _MENU_ ${translations[currentLang].entries_label || "dòng"}`,
            "zeroRecords": translations[currentLang].dt_zero_records || "Không tìm thấy kết quả",
            "info": `${translations[currentLang].dt_info_pre || "Hiển thị từ"} _START_ ${translations[currentLang].dt_info_mid || "đến"} _END_ ${translations[currentLang].dt_info_post || "của"} _TOTAL_ ${translations[currentLang].entries_label || "dòng"}`,
            "infoEmpty": translations[currentLang].dt_info_empty || "Không có dữ liệu",
            "infoFiltered": `(${translations[currentLang].dt_info_filtered_pre || "được lọc từ"} _MAX_ ${translations[currentLang].dt_info_filtered_post || "dòng"})`,
            "search": `${translations[currentLang].dt_search || "Tìm kiếm"}:`,
            "paginate": {
                "first": translations[currentLang].dt_paginate_first || "Đầu",
                "last": translations[currentLang].dt_paginate_last || "Cuối",
                "next": translations[currentLang].dt_paginate_next || "Sau",
                "previous": translations[currentLang].dt_paginate_previous || "Trước"
            }
        },
        drawCallback: function(settings) {
            requestAnimationFrame(() => this.api().columns.adjust());
        }
    };

    if (Array.isArray(initialOrder) && initialOrder.length) {
        options.order = initialOrder;
    }

    const table = $(`#${tableId}`).DataTable(options);

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    const debouncedSearch = debounce(function(value) {
        table.search(value).draw();
    }, 500);

    $(searchControl).off('keyup').on('keyup', function() {
        debouncedSearch(this.value);
    });

    $(lengthControl).off('change').on('change', function() { table.page.len($(this).val()).draw(); });
    
    if (deleteButton && selectAllCheckbox) {
        const updateDeleteBtnState = () => {
            const selectedCount = $(`#${tableId} tbody tr.selected`).length;
            $(deleteButton).toggleClass('disabled', selectedCount === 0);
        };
        
        $(selectAllCheckbox).off('change').on('change', function() {
            const isChecked = $(this).prop('checked');
            $(`#${tableId} tbody .row-checkbox`).prop('checked', isChecked);
            $(`#${tableId} tbody tr`).toggleClass('selected', isChecked);
            updateDeleteBtnState();
        });

        $(`#${tableId} tbody`).off('click change')
            .on('click', 'tr', function(e) {
                if (!$(e.target).is('input.row-checkbox, button, i')) {
                    $(this).toggleClass('selected');
                    const checkbox = $(this).find('.row-checkbox');
                    checkbox.prop('checked', $(this).hasClass('selected'));
                    updateDeleteBtnState();
                }
            })
            .on('change', '.row-checkbox', function() {
                $(this).closest('tr').toggleClass('selected', this.checked);
                updateDeleteBtnState();
            });
    }

    return table;
}

const REGISTERED_VEHICLE_USER_RULES = {
    startMinutes: 7 * 60,
    endMinutes: 16 * 60,
    maxPastDays: 1
};

function isWithinRegisteredVehicleUserHours(referenceDate) {
    const now = referenceDate instanceof Date && !Number.isNaN(referenceDate.getTime())
        ? referenceDate
        : getVietnamNowClient();
    const parts = getVietnamDateParts(now);
    if (!parts) return false;
    const hour = parseInt(parts.hour || parts.hours || '', 10);
    const minute = parseInt(parts.minute || parts.minutes || '', 10);
    if (Number.isNaN(hour) || Number.isNaN(minute)) return false;
    const totalMinutes = hour * 60 + minute;
    return (
        totalMinutes >= REGISTERED_VEHICLE_USER_RULES.startMinutes &&
        totalMinutes <= REGISTERED_VEHICLE_USER_RULES.endMinutes
    );
}

function getRegisteredVehicleRowDate(rowData) {
    if (!rowData || typeof rowData !== 'object') return null;
    const possibleKeys = ['Register Date', 'register_date', 'RegisterDate'];
    for (let i = 0; i < possibleKeys.length; i += 1) {
        const value = rowData[possibleKeys[i]];
        if (value) {
            const parsed = parseDateValue(value);
            if (parsed) {
                return parsed;
            }
        }
    }
    return null;
}

function isRegisteredVehicleRowWithinUserDateLimit(rowData, referenceDate) {
    const now = referenceDate instanceof Date && !Number.isNaN(referenceDate.getTime())
        ? referenceDate
        : getVietnamNowClient();
    const cutoffDate = normalizeToUtcDate(addVietnamDays(now, -REGISTERED_VEHICLE_USER_RULES.maxPastDays));
    const registerDate = normalizeToUtcDate(getRegisteredVehicleRowDate(rowData));
    if (!cutoffDate || !registerDate) return false;
    return registerDate.getTime() >= cutoffDate.getTime();
}

function canCurrentUserModifyRegisteredVehicleRow(rowData, options = {}) {
    if (isRole('admin')) {
        return { allowed: true };
    }
    if (!isRole('user')) {
        return { allowed: false, reason: 'role' };
    }
    const referenceDate = options.now instanceof Date && !Number.isNaN(options.now.getTime())
        ? options.now
        : getVietnamNowClient();
    if (!isWithinRegisteredVehicleUserHours(referenceDate)) {
        return { allowed: false, reason: 'time' };
    }
    if (rowData && !isRegisteredVehicleRowWithinUserDateLimit(rowData, referenceDate)) {
        return { allowed: false, reason: 'date' };
    }
    return { allowed: true };
}

function showRegisteredVehicleRestrictionAlert(reason) {
    const t = translations[currentLang] || {};
    const title = t.edit_restricted_title || t.warning_title || 'Warning';
    let message;
    switch (reason) {
        case 'time':
            message = t.edit_restricted_time || 'You can only edit or delete records between 07:00 and 16:00.';
            break;
        case 'date':
            message = t.edit_restricted_date || 'You cannot edit or delete records that are older than 1 day.';
            break;
        case 'role':
        default:
            message = t.edit_restricted_role || t.warning_title || 'You do not have permission to modify this data.';
            break;
    }
    Swal.fire({
        icon: 'warning',
        title,
        text: message
    });
}

function initViewPage() {
  const dateFilterControl = $('#date-filter-control');
  const contractFilter = $('#contract-filter');
  ensureVietnamTime();
  const nowVietnam = getVietnamNowClient();
  const today = new Date(nowVietnam.getTime());
  const tomorrow = addVietnamDays(today, 1);
  const todayStr = getFormattedDate(today);
  const tomorrowStr = getFormattedDate(tomorrow);
  const t = translations[currentLang];
  const role = getUserRole();
  const isAdmin = role === 'admin';
  const isUser = role === 'user';
  const showSelectActions = isAdmin || isUser;
  const useDateInput = hasAnyRole(['admin', 'admin-xppl', 'user-supervision']); 

  const contractAllLabel = t.view_filter_contract_all || 'All contracts';
  const contractLoadingLabel = t.view_filter_contract_loading || 'Loading...';
  const contractEmptyLabel = t.view_filter_contract_empty || 'No contracts for the selected date';

  contractFilter.empty().append($('<option>').val('').text(contractAllLabel)).prop('disabled', true);

  if (useDateInput) {
    dateFilterControl.html('<input type="date" id="date-filter-input" class="form-control form-control-sm">');
    $('#date-filter-input').val(getVietnamIsoDate(today));
  } else {
    const todayLabel = t.view_today_label ? ` ${t.view_today_label}` : '';
    const tomorrowLabel = t.view_tomorrow_label ? ` ${t.view_tomorrow_label}` : '';
    dateFilterControl.html(
      `<select id="date-filter-select" class="form-select form-select-sm">
         <option value="${todayStr}">${todayStr}${todayLabel}</option>
         <option value="${tomorrowStr}">${tomorrowStr}${tomorrowLabel}</option>
       </select>`
    );
  }

  const dateInput = useDateInput ? $('#date-filter-input') : $('#date-filter-select');

  const getSelectedDateString = () => {
    if (useDateInput) {
      const raw = (dateInput.val() || '').trim();
      const parsed = parseDateValue(raw);
      return parsed ? getFormattedDate(parsed) : getFormattedDate(getVietnamNowClient());
    }
    return dateInput.val();
  };

  const getSelectedContract = () => String(contractFilter.val() || '').trim();

  function renderContractOptions(list, preferredValue) {
    const options = Array.isArray(list)
      ? list.map(item => String(item == null ? '' : item).replace(/^'+/, '').trim()).filter(Boolean)
      : [];

    contractFilter.empty();
    contractFilter.append($('<option>').val('').text(contractAllLabel));

    if (!options.length) {
      contractFilter.append(
        $('<option>').val('').prop('disabled', true).text(contractEmptyLabel)
      );
      contractFilter.prop('disabled', true);
      contractFilter.val('');
      return;
    }

    options.forEach(value => {
      contractFilter.append($('<option>').val(value).text(value));
    });
    contractFilter.prop('disabled', false);

    if (preferredValue && options.includes(preferredValue)) {
      contractFilter.val(preferredValue);
    } else {
      contractFilter.val('');
    }
  }

  function refreshContractOptions({ resetSelection = true } = {}) {
    const previous = resetSelection ? '' : getSelectedContract();

    if (resetSelection) {
      contractFilter.val('');
      contractFilter.prop('disabled', true).empty().append(
        $('<option>').val('').text(contractLoadingLabel)
      );
    } else {
      contractFilter.prop('disabled', true);
    }

    const dateString = getSelectedDateString();
    if (!dateString) {
      renderContractOptions([], '');
      return;
    }

    google.script.run
      .withSuccessHandler(res => {
        const contracts = res && Array.isArray(res.contracts) ? res.contracts : [];
        renderContractOptions(contracts, previous);
      })
      .withFailureHandler(err => {
        renderContractOptions([], '');
        showError(err);
      })
      .getRegisteredContractOptions({ dateString }, userSession.token);
  }

  function handleDateChange() {
    refreshContractOptions({ resetSelection: true });
    if (typeof registeredVehicleTable !== 'undefined' && registeredVehicleTable) {
      registeredVehicleTable.draw();
    }
  }

  dateInput.off('change.view').on('change.view', handleDateChange);

  contractFilter.off('change.view').on('change.view', function () {
    if (typeof registeredVehicleTable !== 'undefined' && registeredVehicleTable) {
      registeredVehicleTable.draw();
    }
  });

  refreshContractOptions({ resetSelection: true });

  const baseColumns = [
    { data: 'ID', title: t.col_id },
    { data: 'Register Date', title: t.col_register_date },
    { data: 'Contract No', title: t.col_contract_no },
    { data: 'Truck Plate', title: t.col_truck_plate },
    { data: 'Country', title: t.col_country },
    { data: 'Wheel', title: t.col_wheel },
    { data: 'Trailer Plate', title: t.col_trailer_plate },
    { data: 'Truck weight', title: t.col_truck_weight },
    { data: 'Pay load', title: t.col_payload },
    { data: 'Container No1', title: t.col_container1 },
    { data: 'Container No2', title: t.col_container2 },
    { data: 'Driver Name', title: t.col_driver_name },
    { data: 'ID/Passport', title: t.col_id_passport },
    { data: 'Phone number', title: t.col_phone_number },
    { data: 'Destination EST', title: t.col_destination },
    { data: 'Transportation Company', title: t.col_transport_company },
    { data: 'Subcontractor', title: t.col_subcontractor },
    { data: 'Vehicle Status', title: t.col_vehicle_status },
    { data: 'Registration Status', title: t.col_registration_status },
    { data: 'Time', title: t.col_time }
  ];

  const columns = showSelectActions
    ? [
        { data: null, title: '<input type="checkbox" id="selectAllCheckbox">', orderable: false, render: () => '<input type="checkbox" class="row-checkbox">' },
        { data: null, title: t.action_column, orderable: false, render: () => `<button class="btn btn-warning btn-sm edit-btn" title="${t.edit_button}"><i class="fas fa-edit"></i></button>` },
        ...baseColumns
      ]
    : baseColumns;

  // --- Khởi tạo DataTable ---
  registeredVehicleTable = initializeDataTable({
    tableId: 'registeredVehicleTable',
    columns: columns,
    ajaxFunction: (params, callback) => {
      google.script.run
        .withSuccessHandler(json => callback(json))
        .withFailureHandler(showError)
        .getRegisteredDataServerSide(params);
    },
    getExtraParams: () => ({
      dateString: getSelectedDateString(),
      contractNo: getSelectedContract()
    }),
    searchControl: '#table-search-input',
    lengthControl: '#page-length-select',
    deleteButton: showSelectActions ? '#deleteSelectedBtn' : null,
    selectAllCheckbox: showSelectActions ? '#selectAllCheckbox' : null,
    enableSelect: showSelectActions
  });

// ===== Summary cards for registered vehicles =====
let useServerSummary = false;

const updateSummaryValues = (total, pending, approved) => {
  $('#stat-total').text(typeof total === 'number' ? total : 0);
  $('#stat-pending').text(typeof pending === 'number' ? pending : 0);
  $('#stat-approved').text(typeof approved === 'number' ? approved : 0);
};

const countStatuses = rows => {
  let pending = 0;
  let approved = 0;
  rows.forEach(row => {
    const status = String(row['Registration Status'] || '').toLowerCase();
    if (status === 'approved') {
      approved += 1;
    } else if (status === 'pending approval') {
      pending += 1;
    }
  });
  return { pending, approved };
};


$('#registeredVehicleTable')
  .off('xhr.dt.summary xhr.dt')
  .on('xhr.dt.summary', function (_e, _settings, json) {
    try {
      if (json && json.summary) {
        useServerSummary = true;
        updateSummaryValues(
          typeof json.summary.total === 'number' ? json.summary.total : 0,
          typeof json.summary.pending === 'number' ? json.summary.pending : 0,
          typeof json.summary.approved === 'number' ? json.summary.approved : 0
        );

      } else {
        useServerSummary = false;
        const rows = (json && json.data && json.data.length) ? json.data : [];
        const { pending, approved } = countStatuses(rows);
        const totalValue = (json && typeof json.recordsFiltered === 'number')
          ? json.recordsFiltered
          : rows.length;
        updateSummaryValues(totalValue, pending, approved);
      }
    } catch (err) {
      if (console && console.warn) console.warn('xhr.dt summary error:', err);
    }
  });

$('#registeredVehicleTable')
  .off('draw.dt.summaryLocal')
  .on('draw.dt.summaryLocal', function () {
    try {
      if (useServerSummary) return;

      const dt = $.fn.DataTable.isDataTable('#registeredVehicleTable')
        ? $('#registeredVehicleTable').DataTable()
        : null;
      if (!dt) {
        updateSummaryValues(0, 0, 0);
        return;
      }

      const rows = dt.rows({ search: 'applied' }).data().toArray();
      if (!rows || !rows.length) {
        updateSummaryValues(0, 0, 0);
        return;
      }

      const { pending, approved } = countStatuses(rows);
      updateSummaryValues(rows.length, pending, approved);
    } catch (err2) {
      if (console && console.warn) console.warn('draw.dt summaryLocal error:', err2);
    }
  });

  // ----- Phần còn lại giữ nguyên -----
  if (isUser) {
    const notice = $('#edit-rules-notice');
    notice.removeClass('d-none');
    notice.html(`${t.edit_rules_notice_line1}<br>${t.edit_rules_notice_line2}`);
  }

  $('#refreshBtn').on('click', () => {
    refreshContractOptions({ resetSelection: false });
    registeredVehicleTable.ajax.reload(null, false);
  });
  if (showSelectActions) {
    $('#deleteSelectedBtn').removeClass('d-none disabled').off('click').on('click', handleDeleteSelected);
  } else {
     $('#deleteSelectedBtn').addClass('d-none').off('click');
  }
  $('#exportBtn').off('click').on('click', handleExportExcel);


  // === Visibility & permissions for Registered Vehicles table (Admin vs User) ===
   if (typeof registeredVehicleTable !== 'undefined' && showSelectActions) {
    const SELECT_COL = 0;
    const ACTION_COL = 1;

    const applyRegisteredColumnsVisibility = () => {
      if (!registeredVehicleTable) return;
     if (isAdmin) {
        try {
          registeredVehicleTable.column(SELECT_COL).visible(true);
          registeredVehicleTable.column(ACTION_COL).visible(true);
        } catch (_e) {}
      } else {
        const allow = isWithinRegisteredVehicleUserHours();
        try {
          registeredVehicleTable.column(SELECT_COL).visible(allow);
          registeredVehicleTable.column(ACTION_COL).visible(allow);
        } catch (_e) {}
        if (!allow) {
          $('#deleteSelectedBtn').addClass('disabled').prop('disabled', true);
        } else {
          $('#deleteSelectedBtn').removeClass('disabled').prop('disabled', false);
        }
      }
    };

    applyRegisteredColumnsVisibility();
    registeredVehicleTable.on('draw.dt', applyRegisteredColumnsVisibility);
    if (!window.__rvVisInterval) {
      window.__rvVisInterval = setInterval(applyRegisteredColumnsVisibility, 60000);
    }

    $('#registeredVehicleTable tbody').off('click', '.edit-btn').on('click', '.edit-btn', function (e) {
      e.stopPropagation();
      const rowData = registeredVehicleTable.row($(this).closest('tr')).data();
      if (rowData) handleEdit(rowData);
    });
  }
}

const $btn = $('#exportBtn').prop('disabled', true);

function handleExportExcel() {
  // Lấy ngày theo đúng logic cũ
  var selectedDateStr;
  if (hasAnyRole(['admin', 'admin-xppl', 'user-supervision'])) {
    const raw = ($('#date-filter-input').val() || '').trim();
    const parsed = parseDateValue(raw);
    selectedDateStr = parsed ? getFormattedDate(parsed) : getFormattedDate(getVietnamNowClient());
  } else {
    selectedDateStr = $('#date-filter-select').val();
  }

  const table = registeredVehicleTable;
  const t = translations[currentLang];
  const selectedContract = ($('#contract-filter').val() || '').toString().trim();
  const contractLabel = selectedContract || (t.view_filter_contract_all || 'All contracts');
  let safeContractLabel = contractLabel.replace(/[\\/:*?"<>|]/g, '_').trim();
  if (!safeContractLabel) {
    safeContractLabel = 'All contracts';
  }
  const fileDatePart = selectedDateStr.replace(/\//g, '-');

  // Lấy cột ĐANG HIỂN THỊ theo thứ tự (bỏ cột select + action vì data = null)
  var colIdxs = table.columns({ visible: true, order: 'index' }).indexes().toArray();
  var aoCols  = table.settings()[0].aoColumns;
  var cols = colIdxs.map(function(idx) {
      var def = aoCols[idx];
      return { key: def.data, title: $(table.column(idx).header()).text().trim() };
    }).filter(function(c){ return typeof c.key === 'string' && c.key.length > 0; });

  // Hàm build AOA & ghi file
  function exportRows(rows) {
    var aoa = [ cols.map(function(c){ return c.title; }) ];
    rows.forEach(function(obj){
      aoa.push(cols.map(function(c){ return (obj[c.key] == null ? '' : obj[c.key]); }));
    });
    var ws = XLSX.utils.aoa_to_sheet(aoa);
    
    (function applyWorksheetStyling() {
      if (!ws['!ref']) return;
      var range = XLSX.utils.decode_range(ws['!ref']);
      var headerRow = range.s.r;
      var borderSide = { style: 'thin', color: { rgb: '000000' } };
      for (var R = range.s.r; R <= range.e.r; ++R) {
        for (var C = range.s.c; C <= range.e.c; ++C) {
          var cellRef = XLSX.utils.encode_cell({ r: R, c: C });
          var cell = ws[cellRef];
          if (!cell) continue;
          cell.s = cell.s || {};
          cell.s.border = {
            top: borderSide,
            right: borderSide,
            bottom: borderSide,
            left: borderSide
          };
          if (R === headerRow) {
            cell.s.font = Object.assign({}, cell.s.font, { bold: true });
          }
        }
      }
      var colCount = aoa[0] ? aoa[0].length : 0;
      if (!colCount) return;
      var colWidths = [];
      for (var cIdx = 0; cIdx < colCount; ++cIdx) {
        var maxLen = 0;
        for (var rIdx = 0; rIdx < aoa.length; ++rIdx) {
          var cellValue = aoa[rIdx][cIdx];
          var text = cellValue == null ? '' : String(cellValue);
          var parts = text.split(/\r?\n/);
          for (var p = 0; p < parts.length; ++p) {
            var len = parts[p].length;
            if (len > maxLen) maxLen = len;
          }
        }
        var width = Math.min(Math.max(maxLen + 2, 10), 60);
        colWidths.push({ wch: width });
      }
      ws['!cols'] = colWidths;
    })();
    var wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "VehicleRegistration");
    var fileName = `${safeContractLabel}-Registration Trucklist-${fileDatePart}.xlsx`;
    XLSX.writeFile(wb, fileName);
  }

  // Nếu có chọn dòng → xuất dòng đã chọn
  var selectedRows = table.rows({ selected: true }).data().toArray();
  if (selectedRows && selectedRows.length) {
    exportRows(selectedRows);
    return;
  }

  // Mặc định: gọi server để lấy TOÀN BỘ dữ liệu theo ngày (và theo search nếu có)
  var searchVal = table.search() || '';
  var $btn = $('#exportBtn').prop('disabled', true);
  showLoading(t.loading_preparing_data || 'Preparing data...');

  google.script.run
    .withSuccessHandler(function(data){
      Swal.close(); $btn.prop('disabled', false);
      if (Array.isArray(data) && data.length) {
        exportRows(data); // <-- data đã là toàn bộ (không phân trang)
      } else {
        Swal.fire(t.no_data_title || 'No data',
                  t.no_data_export_message || 'There is no data to export.',
                  'info');
      }
    })
    .withFailureHandler(function(err){ Swal.close(); $btn.prop('disabled', false); showError(err); })
    .getAllDataForExport(selectedDateStr, userSession.token, searchVal, selectedContract);
}


function getLoginHistoryFilters() {
  return {
    dateFrom: ($('#login-history-date-from').val() || '').trim(),
    dateTo: ($('#login-history-date-to').val() || '').trim(),
    contractNo: ($('#login-history-contract').val() || '').trim(),
    company: ($('#login-history-company').val() || '').trim()
  };
}

function getVehicleHistoryFilters() {
  return {
    dateFrom: ($('#vehicle-history-date-from').val() || '').trim(),
    dateTo: ($('#vehicle-history-date-to').val() || '').trim(),
    contractNo: ($('#vehicle-history-contract').val() || '').trim(),
    company: ($('#vehicle-history-company').val() || '').trim()
  };
}

function populateHistorySelect($select, values, previousValue) {
  if (!$select || !$select.length) return;
  const t = translations[currentLang];
  const normalizedValues = Array.isArray(values)
    ? values.map(v => String(v == null ? '' : v).trim()).filter(Boolean)
    : [];

  const prev = String(previousValue == null ? '' : previousValue).trim();

  const allOptionText = (t && t.history_filter_all) || 'Tất cả';
  $select.empty();
  $select.append($('<option>').val('').attr('data-translate', 'history_filter_all').text(allOptionText));

  normalizedValues.forEach(val => {
    $select.append($('<option>').val(val).text(val));
  });

  if (prev && normalizedValues.includes(prev)) {
    $select.val(prev);
  } else {
    $select.val('');
  }
  $select.prop('disabled', false);
}

function loadHistoryFilterOptions(contractSelector, companySelector) {
  const $contract = $(contractSelector);
  const $company = $(companySelector);
  if (!$contract.length || !$company.length) return;

  const prevContract = $contract.val();
  const prevCompany = $company.val();

  $contract.prop('disabled', true);
  $company.prop('disabled', true);

  populateHistorySelect($contract, [], prevContract);
  populateHistorySelect($company, [], prevCompany);
  $contract.prop('disabled', true);
  $company.prop('disabled', true);

  google.script.run
    .withSuccessHandler(res => {
      const contracts = res && Array.isArray(res.contracts) ? res.contracts : [];
      const companies = res && Array.isArray(res.companies) ? res.companies : [];
      populateHistorySelect($contract, contracts, prevContract);
      populateHistorySelect($company, companies, prevCompany);
    })
    .withFailureHandler(err => {
      populateHistorySelect($contract, [], '');
      populateHistorySelect($company, [], '');
      showError(err);
    })
    .getHistoryFilterOptions(userSession.token);
}

function buildHistoryExportFileName(prefix, filters) {
  const safePrefix = (prefix || 'History').replace(/[\/:*?"<>|]/g, '_');
  const dateParts = [];
  if (filters && typeof filters === 'object') {
    const from = String(filters.dateFrom == null ? '' : filters.dateFrom).trim();
    const to = String(filters.dateTo == null ? '' : filters.dateTo).trim();
    if (from) dateParts.push(from);
    if (to && to !== from) dateParts.push(to);
  }
  const suffix = dateParts.length ? dateParts.join('_') : new Date().toISOString().slice(0, 10);
  const safeSuffix = suffix.replace(/[\/:*?"<>|]/g, '-');
  return `${safePrefix}_${safeSuffix}.xlsx`;
}

function exportHistoryData({ table, exportButtonSelector, serverMethod, filters, sheetName, fileNamePrefix }) {
  if (!table) return;
  const t = translations[currentLang];
  const colDefs = table.settings().init().columns || [];
  const visibleIdx = table.columns({ visible: true, order: 'index' }).indexes().toArray();

  if (!visibleIdx.length) {
    Swal.fire(
      (t && t.wr_no_export_columns_title) || 'Không có cột để xuất',
      (t && t.wr_no_export_columns_message) || 'Vui lòng hiển thị ít nhất 1 cột trước khi xuất Excel.',
      'info'
    );
    return;
  }

  const headers = visibleIdx.map(i => $(table.column(i).header()).text().trim());
  const keys = visibleIdx.map(i => {
    const def = colDefs[i] || {};
    return typeof def.data === 'string' ? def.data : null;
  });

  const searchVal = table.search() || '';
  const $btn = $(exportButtonSelector);
  $btn.prop('disabled', true);
  showLoading((t && t.loading_preparing_data) || 'Đang chuẩn bị dữ liệu...');

  const onComplete = () => {
    Swal.close();
    $btn.prop('disabled', false);
  };

  const run = google.script.run
    .withSuccessHandler(rows => {
      onComplete();
      if (!Array.isArray(rows) || !rows.length) {
        Swal.fire((t && t.no_data_title) || 'Không có dữ liệu', (t && t.no_data_export_message) || 'Không có dữ liệu để xuất.', 'info');
        return;
      }

      const aoa = [headers];
      rows.forEach(row => {
        aoa.push(keys.map(key => {
          if (!key) return '';
          const value = row && Object.prototype.hasOwnProperty.call(row, key) ? row[key] : '';
          return value == null ? '' : value;
        }));
      });

      const ws = XLSX.utils.aoa_to_sheet(aoa);
      (function applyWorksheetStyling() {
        if (!ws['!ref']) return;
        const range = XLSX.utils.decode_range(ws['!ref']);
        const borderSide = { style: 'thin', color: { rgb: '000000' } };
        const headerRow = range.s.r;
        for (let r = range.s.r; r <= range.e.r; ++r) {
          for (let c = range.s.c; c <= range.e.c; ++c) {
            const ref = XLSX.utils.encode_cell({ r, c });
            const cell = ws[ref] || (ws[ref] = { t: 's', v: '' });
            cell.s = cell.s || {};
            cell.s.border = { top: borderSide, right: borderSide, bottom: borderSide, left: borderSide };
            if (r === headerRow) {
              cell.s.font = Object.assign({}, cell.s.font, { bold: true });
            }
          }
        }

        const colCount = aoa[0] ? aoa[0].length : 0;
        if (!colCount) return;
        const colWidths = [];
        for (let idx = 0; idx < colCount; ++idx) {
          let maxLen = 0;
          aoa.forEach(row => {
            const text = row[idx] == null ? '' : String(row[idx]);
            text.split(/\r?\n/).forEach(part => {

              if (part.length > maxLen) maxLen = part.length;
            });
          });
          const width = Math.min(Math.max(maxLen + 2, 10), 60);
          colWidths.push({ wch: width });
        }
        ws['!cols'] = colWidths;
      })();

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, sheetName || 'History');
      const fileName = buildHistoryExportFileName(fileNamePrefix || 'History', filters);
      XLSX.writeFile(wb, fileName);
    })
    .withFailureHandler(err => {
      onComplete();
      showError(err);
    });

  if (serverMethod === 'getAllLoginHistoryForExport') {
    run.getAllLoginHistoryForExport(filters, userSession.token, searchVal);
  } else if (serverMethod === 'getAllVehicleHistoryForExport') {
    run.getAllVehicleHistoryForExport(filters, userSession.token, searchVal);
  } else {
    onComplete();
  }
}

function initLoginHistoryPage() {
  ensureVietnamTime();
  const now = typeof getVietnamNowClient === 'function' ? getVietnamNowClient() : new Date();
  const todayIso = typeof formatDateInput === 'function' ? formatDateInput(now) : new Date().toISOString().slice(0, 10);

  $('#login-history-date-from').val(todayIso);
  $('#login-history-date-to').val(todayIso);

  loadHistoryFilterOptions('#login-history-contract', '#login-history-company');

  const t = translations[currentLang];
  const columns = [
    { data: 'occurred_at', title: t.history_col_occurred_at || 'Thời điểm đăng nhập' },
    { data: 'username', title: t.col_username || 'Tên đăng nhập' },
    { data: 'outcome', title: t.history_col_outcome || 'Kết quả' },
    { data: 'ip', title: t.history_col_ip || 'Địa chỉ IP' },
    { data: 'latitude', title: t.history_col_latitude || 'Vĩ độ' },
    { data: 'longitude', title: t.history_col_longitude || 'Kinh độ' },
    { data: 'accuracy_m', title: t.history_col_accuracy || 'Sai số (m)' },
    { data: 'user_agent', title: t.history_col_user_agent || 'User Agent' },
    { data: 'created_at', title: t.history_col_created_at || 'Thời gian tạo' }
  ];

  loginHistoryTable = initializeDataTable({
    tableId: 'login-history-table',
    columns,
    ajaxFunction: (params, callback) => {
      google.script.run
        .withSuccessHandler(json => callback(json))
        .withFailureHandler(showError)
        .getLoginHistoryServerSide(params);
    },
    getExtraParams: () => ({ filters: getLoginHistoryFilters() }),
    searchControl: '#login-history-search',
    lengthControl: '#login-history-length',
    enableSelect: false,
    pageLength: 25,
    order: [[0, 'desc']]
  });

  $('#login-history-length').val('25');
  $('#login-history-search').val('');

  $('#login-history-date-from, #login-history-date-to, #login-history-contract, #login-history-company')
    .off('.history')
    .on('change.history', function () {
      if (loginHistoryTable) loginHistoryTable.ajax.reload();
    });

  $('#login-history-reload')
    .off('.history')
    .on('click.history', function (e) {
      e.preventDefault();
      if (loginHistoryTable) loginHistoryTable.ajax.reload(null, false);
    });

  $('#login-history-export')
    .off('.history')
    .on('click.history', function (e) {
      e.preventDefault();
      exportHistoryData({
        table: loginHistoryTable,
        exportButtonSelector: '#login-history-export',
        serverMethod: 'getAllLoginHistoryForExport',
        filters: getLoginHistoryFilters(),
        sheetName: 'LoginHistory',
        fileNamePrefix: 'LoginHistory'
      });
    });
}

function initVehicleHistoryPage() {
  ensureVietnamTime();
  const now = typeof getVietnamNowClient === 'function' ? getVietnamNowClient() : new Date();
  const todayIso = typeof formatDateInput === 'function' ? formatDateInput(now) : new Date().toISOString().slice(0, 10);

  $('#vehicle-history-date-from').val(todayIso);
  $('#vehicle-history-date-to').val(todayIso);

  loadHistoryFilterOptions('#vehicle-history-contract', '#vehicle-history-company');

  const t = translations[currentLang];
  const columns = [
    { data: 'action_type', title: t.history_col_action_type || 'Loại hành động' },
    { data: 'action_time', title: t.history_col_action_time || 'Thời điểm hành động' },
    { data: 'register_date', title: t.col_register_date || 'Ngày đăng ký' },
    { data: 'contract_no', title: t.col_contract_no || 'Số hợp đồng' },
    { data: 'truck_plate', title: t.col_truck_plate || 'Biển số xe' },
    { data: 'country', title: t.col_country || 'Quốc gia' },
    { data: 'wheel', title: t.col_wheel || 'Số bánh' },
    { data: 'trailer_plate', title: t.col_trailer_plate || 'Biển số Mooc' },
    { data: 'truck_weight', title: t.col_truck_weight || 'Trọng lượng xe' },
    { data: 'pay_load', title: t.col_payload || 'Tải trọng xe' },
    { data: 'container_no1', title: t.col_container1 || 'Container 1' },
    { data: 'container_no2', title: t.col_container2 || 'Container 2' },
    { data: 'driver_name', title: t.col_driver_name || 'Tên lái xe' },
    { data: 'id_passport', title: t.col_id_passport || 'Số hộ chiếu' },
    { data: 'phone_number', title: t.col_phone_number || 'Số điện thoại' },
    { data: 'destination_est', title: t.col_destination || 'Điểm trả hàng dự kiến' },
    { data: 'transportation_comp', title: t.col_transport_company || 'Đơn vị vận chuyển' },
    { data: 'subcontractor', title: t.col_subcontractor || 'Nhà thầu phụ' },
    { data: 'vehicle_status', title: t.col_vehicle_status || 'Tình trạng xe' },
    { data: 'registration_status', title: t.col_registration_status || 'Trạng thái đăng ký' },
    { data: 'time', title: t.col_time || 'Thời gian đăng ký' },
    { data: 'created_by', title: t.history_col_created_by || 'Người thao tác' },
    { data: 'created_at', title: t.history_col_created_at || 'Thời gian tạo' }
  ];

  vehicleHistoryTable = initializeDataTable({
    tableId: 'vehicle-history-table',
    columns,
    ajaxFunction: (params, callback) => {
      google.script.run
        .withSuccessHandler(json => callback(json))
        .withFailureHandler(showError)
        .getVehicleRegistrationHistoryServerSide(params);
    },
    getExtraParams: () => ({ filters: getVehicleHistoryFilters() }),
    searchControl: '#vehicle-history-search',
    lengthControl: '#vehicle-history-length',
    enableSelect: false,
    pageLength: 25,
    order: [[1, 'desc']]
  });

  $('#vehicle-history-length').val('25');
  $('#vehicle-history-search').val('');

  $('#vehicle-history-date-from, #vehicle-history-date-to, #vehicle-history-contract, #vehicle-history-company')
    .off('.vhistory')
    .on('change.vhistory', function () {
      if (vehicleHistoryTable) vehicleHistoryTable.ajax.reload();
    });

  $('#vehicle-history-reload')
    .off('.vhistory')
    .on('click.vhistory', function (e) {
      e.preventDefault();
      if (vehicleHistoryTable) vehicleHistoryTable.ajax.reload(null, false);
    });

  $('#vehicle-history-export')
    .off('.vhistory')
    .on('click.vhistory', function (e) {
      e.preventDefault();
      exportHistoryData({
        table: vehicleHistoryTable,
        exportButtonSelector: '#vehicle-history-export',
        serverMethod: 'getAllVehicleHistoryForExport',
        filters: getVehicleHistoryFilters(),
        sheetName: 'VehicleHistory',
        fileNamePrefix: 'VehicleHistory'
      });
    });
}


function handleDeleteSelected() {
    const t = translations[currentLang];
    const isAdmin = isRole('admin');
    if (!isAdmin) {
        const timeCheck = canCurrentUserModifyRegisteredVehicleRow(null);
        if (!timeCheck.allowed) {
            showRegisteredVehicleRestrictionAlert(timeCheck.reason);
            return;
        }
    }

    if (!registeredVehicleTable) {
        showRegisteredVehicleRestrictionAlert('role');
        return;
    }

    const selectedData = registeredVehicleTable.rows('.selected').data().toArray();
    let selectedIds = selectedData.map(row => row.ID);  

    if (selectedIds.length === 0) {
        Swal.fire(t.no_selection_title || 'No selection',
                  t.no_selection_message || 'Please select at least one item to delete.',
                  'warning');
        return;
    }

    if (!isAdmin) {
        let hasInvalidRows = false;
        $('#registeredVehicleTable tbody tr.selected').each(function () {
            const data = registeredVehicleTable.row(this).data();
            if (!isRegisteredVehicleRowWithinUserDateLimit(data)) {
                $(this).removeClass('selected');
                $(this).find('.row-checkbox').prop('checked', false);
                hasInvalidRows = true;
            }
        });

        if (hasInvalidRows) {
            const remainingSelected = $('#registeredVehicleTable tbody tr.selected').length;
            $('#deleteSelectedBtn').toggleClass('disabled', remainingSelected === 0).prop('disabled', remainingSelected === 0);
            showRegisteredVehicleRestrictionAlert('date');
            if (remainingSelected === 0) {
                return;
            }
            selectedIds = registeredVehicleTable.rows('.selected').data().toArray().map(row => row.ID);
        }
    }

    Swal.fire({
        title: (t.delete_selected_confirm_title || 'Are you sure you want to delete {count} item(s)?').replace('{count}', selectedIds.length),
        text: t.delete_selected_confirm_text || 'This action cannot be undone!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonText: t.cancel_button || 'Cancel',
        confirmButtonText: t.confirm_delete_button || 'Yes, delete!'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading(t.loading_deleting || 'Deleting...');
            google.script.run
                .withSuccessHandler(message => {
                    Swal.fire(t.delete_success_title || 'Deleted!', message, 'success');
                    registeredVehicleTable.draw(false);
                })
                .withFailureHandler(showError)
                .deleteMultipleData(selectedIds, userSession.token);
        }
    });
}

function handleEdit(rowData) {
    const createOptions = (items, selectedValue) => items.map(item => `<option value="${item}" ${item === selectedValue ? 'selected' : ''}>${item}</option>`).join('');
    const t = translations[currentLang];
    const isAdmin = isRole('admin');

    if (!isAdmin) {
        const permission = canCurrentUserModifyRegisteredVehicleRow(rowData);
        if (!permission.allowed) {
            showRegisteredVehicleRestrictionAlert(permission.reason);
            return;
        }
    }

    const registerDateInput = isAdmin
        ? `<input type="text" id="editRegisterDate" class="form-control" value="${rowData['Register Date'] || ''}" required>`
        : `<input type="text" class="form-control" value="${rowData['Register Date']}" readonly>`;

    const formHtml = `
        <form id="editForm" class="edit-form-grid">
            <div class="form-group"><label>${t.col_id || 'ID'}</label><input type="text" class="form-control" value="${rowData.ID}" readonly></div>
            <div class="form-group"><label>${t.col_register_date || 'Register Date'}</label>${registerDateInput}</div>
            <div class="form-group"><label>${t.col_contract_no || 'Contract No'}</label><input type="text" id="editContractNo" class="form-control" value="${rowData['Contract No'] || ''}" required></div>
            <div class="form-group"><label>${t.col_truck_plate || 'Truck Plate'}</label><input type="text" id="editTruckPlate" class="form-control" value="${rowData['Truck Plate'] || ''}" maxlength="11" required></div>
            <div class="form-group"><label>${t.col_country || 'Country'}</label>
                <select id="editCountry" class="form-select">${createOptions(['Vietnam', 'Laos'], rowData['Country'])}</select>
            </div>
            <div class="form-group"><label>${t.col_wheel || 'Wheel'}</label><input type="number" id="editWheel" class="form-control" value="${rowData['Wheel'] || ''}" max="1000" required></div>
            <div class="form-group"><label>${t.col_trailer_plate || 'Trailer Plate'}</label><input type="text" id="editTrailerPlate" class="form-control" value="${rowData['Trailer Plate'] || ''}" maxlength="11"></div>
            <div class="form-group"><label>${t.col_truck_weight || 'Truck weight'}</label><input type="number" id="editTruckWeight" class="form-control" value="${rowData['Truck weight'] || ''}" max="1000" step="0.01" required></div>
            <div class="form-group"><label>${t.col_payload || 'Pay load'}</label><input type="number" id="editPayLoad" class="form-control" value="${rowData['Pay load'] || ''}" max="1000" step="0.01" required></div>
            <div class="form-group"><label>${t.col_container1 || 'Container 1'}</label><input type="text" id="editContainerNo1" class="form-control" value="${rowData['Container No1'] || ''}" maxlength="70"></div>
            <div class="form-group"><label>${t.col_container2 || 'Container 2'}</label><input type="text" id="editContainerNo2" class="form-control" value="${rowData['Container No2'] || ''}" maxlength="70"></div>
            <div class="form-group"><label>${t.col_driver_name || 'Driver Name'}</label><input type="text" id="editDriverName" class="form-control" value="${rowData['Driver Name'] || ''}" maxlength="70" required></div>
            <div class="form-group"><label>${t.col_id_passport || 'ID/Passport'}</label><input type="text" id="editIdPassport" class="form-control" value="${rowData['ID/Passport'] || ''}" maxlength="70" required></div>
            <div class="form-group"><label>${t.col_phone_number || 'Phone number'}</label><input type="number" id="editPhoneNumber" class="form-control" value="${rowData['Phone number'] || ''}" ></div>
            <div class="form-group"><label>${t.col_destination || 'Destination EST'}</label><input type="text" id="editDestinationEST" class="form-control" value="${rowData['Destination EST'] || ''}" maxlength="70" required></div>
            <div class="form-group"><label>${t.col_transport_company || 'Transportation Company'}</label>
                <select class="form-select" id="editTransportationCompany" ${isRole('user') ? 'disabled' : ''}>
                    ${createOptions(allowedCompanies, rowData['Transportation Company'])}
                </select>
            </div>
            <div class="form-group"><label>${t.col_subcontractor || 'Subcontractor'}</label><input type="text" id="editSubcontractor" class="form-control" value="${rowData['Subcontractor'] || ''}" maxlength="70" required></div>
            <div class="form-group"><label>${t.col_vehicle_status || 'Vehicle Status'}</label>
                <select class="form-select" id="editVehicleStatus" required>
                    ${createOptions(['RO', 'CO', 'PM', 'CM', 'AC', 'ND'], rowData['Vehicle Status'])}
                </select>
            </div>
        </form>`;

    Swal.fire({
        title: t.edit_vehicle_title || 'Edit vehicle information',
        html: formHtml,
        width: '90%',
        showCancelButton: true,
        confirmButtonText: t.save_changes_button || 'Save changes',
        cancelButtonText: t.cancel_button || 'Cancel',
        preConfirm: () => {
            const form = $('#editForm')[0];
            if (!form.checkValidity()) {
                Swal.showValidationMessage(t.edit_validation_message || 'Please complete all required fields with valid values.');
                return false;
            }
            const updatedRecord = { ...rowData };
            if (isAdmin) {
                updatedRecord['Register Date'] = $('#editRegisterDate').val();
            }
            updatedRecord['Contract No'] = $('#editContractNo').val();
            updatedRecord['Truck Plate'] = $('#editTruckPlate').val().replace(/\s/g, '').toUpperCase();
            updatedRecord['Country'] = $('#editCountry').val();
            updatedRecord['Wheel'] = $('#editWheel').val();
            updatedRecord['Trailer Plate'] = $('#editTrailerPlate').val().replace(/\s/g, '').toUpperCase();
            updatedRecord['Truck weight'] = $('#editTruckWeight').val();
            updatedRecord['Pay load'] = $('#editPayLoad').val();
            updatedRecord['Container No1'] = $('#editContainerNo1').val();
            updatedRecord['Container No2'] = $('#editContainerNo2').val();
            updatedRecord['Driver Name'] = $('#editDriverName').val();
            updatedRecord['ID/Passport'] = $('#editIdPassport').val();
            updatedRecord['Phone number'] = $('#editPhoneNumber').val();
            updatedRecord['Destination EST'] = $('#editDestinationEST').val();
            updatedRecord['Transportation Company'] = $('#editTransportationCompany').val();
            updatedRecord['Subcontractor'] = $('#editSubcontractor').val();
            updatedRecord['Vehicle Status'] = $('#editVehicleStatus').val();
            return updatedRecord;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading(t.loading_updating || 'Updating...');
            google.script.run
                .withSuccessHandler(message => {
                    Swal.fire(t.success_title || 'Success', message, 'success');
                    registeredVehicleTable.draw(false);
                })
                .withFailureHandler(showError)
                .updateData(result.value, userSession.token);
        }
    });
}

function initTotalListPage() {
    const t = translations[currentLang];
    const isAdmin = isRole('admin');

    setupCustomFileInput('#total-list-fileUploader', {
        trigger: '#totalListFileTrigger',
        display: '#totalListFileDisplay',
        defaultKey: 'file_no_file_selected'
    });    

    // 1) Destroy sạch mọi instance/bộ nhớ cũ
    if ($.fn.DataTable.isDataTable('#totalListTable')) {
        const old = $('#totalListTable').DataTable();
        old.clear().draw();
        old.destroy();
        $('#totalListTable').empty(); // quan trọng: xoá thead/tbody đã sinh
    }

    // 2) Xây header/cột theo role (user không có select + action)
    const columns = [];
    if (isAdmin) {
        columns.push({
            data: null,
            title: '<input type="checkbox" id="tl-select-all">',
            className: 'select-checkbox',
            orderable: false,
            defaultContent: ''
        });
        columns.push({
            data: null,
            title: t.action_column,
            className: 'dt-action',
            orderable: false,
            render: () => `<button class="btn btn-warning btn-sm"><i class="fas fa-edit"></i></button>`
        });
    }

    // Các cột dữ liệu thực (giữ nguyên thứ tự của bạn)
    columns.push(
        { data: 'ID', title: t.col_id },
        { data: 'Truck Plate', title: t.col_truck_plate },
        { data: 'Country', title: t.col_country },
        { data: 'Wheel', title: t.col_wheel },
        { data: 'Trailer Plate', title: t.col_trailer_plate },
        { data: 'Truck weight', title: t.col_truck_weight },
        { data: 'Pay load', title: t.col_payload },
        { data: 'Container No1', title: t.col_container1 },
        { data: 'Container No2', title: t.col_container2 },
        { data: 'Driver Name', title: t.col_driver_name },
        { data: 'ID/Passport', title: t.col_id_passport },
        { data: 'Phone number', title: t.col_phone_number },
        { data: 'Transportation Company', title: t.col_transport_company },
        { data: 'Subcontractor', title: t.col_subcontractor },
        { data: 'Vehicle Status', title: t.col_vehicle_status },
        { data: 'Activity Status', title: t.col_activity_status },
        { data: 'Register Date', title: t.col_register_date },
        { data: 'Time', title: t.col_time },
        { data: 'Created By', title: t.col_created_by || 'Created By' },
        { data: 'Updated At', title: t.col_updated_at || 'Updated At' },
        { data: 'Updated By', title: t.col_updated_by || 'Updated By' }
    );

    // 3) Sinh lại thead cho DataTables (tránh kế thừa header cũ)
    const $table = $(`
      <table id="totalListTable" class="table table-bordered table-striped w-100">
        <thead><tr>${columns.map(c => `<th>${c.title || ''}</th>`).join('')}</tr></thead>
        <tbody></tbody>
      </table>
    `);
    $('#total-list-table-wrapper').length
        ? $('#total-list-table-wrapper').html($table)
        : $('#total-list-container, .card-body').find('#totalListTable').replaceWith($table);

    // 4) Khởi tạo DataTable
    totalListTable = $('#totalListTable').DataTable({
        dom: 'frtip',
        processing: true,
        serverSide: true,
        searching: true,
        ordering: true,
        deferRender: true,
        paging: true,
        pageLength: parseInt($('#total-list-page-length-select').val() || '50', 10),
        columns: columns,
        // Không dùng scrollX để tránh lệch header/body
        // scrollX: false,
        language: {
            search: '',
            searchPlaceholder: t.search_in_list_placeholder || ''
        },
        drawCallback: function () {
            // Căn cột lại mỗi lần draw
            this.api().columns.adjust();

            // User: cưỡng bức ẩn nếu vì lý do nào đó 2 cột vẫn lọt vào
            if (!isAdmin) {
                try {
                    this.api().columns('.select-checkbox').visible(false);
                    this.api().columns('.dt-action').visible(false);
                } catch (_) {}
            }
        },
        ajax: function (data, callback) {
            // Truyền role/contractor để server lọc đúng
            const params = {
                draw: data.draw,
                start: data.start,
                length: data.length,
                search: data.search,
                order: data.order,
                sessionToken: userSession?.token
            };
            showLoading(t.loading_page);
            google.script.run
                .withSuccessHandler(res => {
                    Swal.close();
                    fetchTotalListSummary();

                    const rows = Array.isArray(res?.data) ? res.data : (Array.isArray(res?.rows) ? res.rows : []);
                    const total = (typeof res?.recordsTotal === 'number') ? res.recordsTotal : (typeof res?.total === 'number' ? res.total : 0);
                    const filtered = (typeof res?.recordsFiltered === 'number') ? res.recordsFiltered : (typeof res?.filtered === 'number' ? res.filtered : total);

                    callback({
                        data: rows,
                        recordsTotal: total,
                        recordsFiltered: filtered
                    });
                })
                .withFailureHandler(err => {
                    Swal.close();
                    showError(err);
                    callback({ data: [], recordsTotal: 0, recordsFiltered: 0 });
                })
                .getTotalListDataServerSide(params);
        }
    });

    
    // === Select All checkbox (admin) ===
    if (isAdmin) {
        $('#totalListTable thead').off('click', '#tl-select-all').on('click', '#tl-select-all', function(){
            const allApplied = totalListTable.rows({ search: 'applied' });
            if (this.checked) {
                allApplied.select();
            } else {
                totalListTable.rows().deselect();
            }
        });
        $('#totalListTable').on('select.dt deselect.dt draw.dt', function(){
            const all = totalListTable.rows({ search: 'applied' }).count();
            const sel = totalListTable.rows({ selected: true, search: 'applied' }).count();
            const el = document.getElementById('tl-select-all');
            if (el) el.checked = (all > 0 && sel === all);
        });
    }

    // --- Admin selection, edit, delete bindings ---
    if (isAdmin) {
        const updateDeleteBtnState = () => {
            const selectedCount = totalListTable.rows('.selected').data().length;
            $('#total-list-deleteBtn').toggleClass('disabled', selectedCount === 0);
        };
        // Enable DataTables select extension for admin
        totalListTable.settings()[0].oInit.select = { style: 'multi', selector: 'td.select-checkbox' };

        // Row select/deselect via checkbox cell
        $('#totalListTable tbody').off('click', 'td.select-checkbox').on('click', 'td.select-checkbox', function(e) {
            e.stopPropagation();
            const tr = $(this).closest('tr');
            tr.toggleClass('selected');
            updateDeleteBtnState();
        });

        // Select all checkbox in header
        $('#totalListTable thead').off('click', '#tl-select-all').on('click', '#tl-select-all', function(){
            const isChecked = $(this).prop('checked');
            $('#totalListTable tbody tr').toggleClass('selected', isChecked);
            updateDeleteBtnState();
        });

        // Bind delete button
        $('#total-list-deleteBtn').off('click').on('click', handleDeleteTotalList);

        // Bind edit button in action column
        $('#totalListTable tbody').off('click', 'td.dt-action button').on('click', 'td.dt-action button', function(e) {
            e.stopPropagation();
            const rowData = totalListTable.row($(this).closest('tr')).data();
            handleEditTotalListVehicle(rowData);
        });
        $('#total-list-uploadButton').off('click').on('click', handleTotalListFileUpload);
        $('#total-list-saveUploadBtn').off('click').on('click', handleSaveTotalListUploadedData);
        // Reset states on table draw
        totalListTable.on('draw', function(){
            $('#tl-select-all').prop('checked', false);
            updateDeleteBtnState();
        });
    }
    // 5) UI theo role
    if (!isAdmin) {
        $('#total-list-deleteBtn').addClass('d-none');
        $('#total-list-upload-card').addClass('d-none');
    } else {
        $('#total-list-deleteBtn').removeClass('d-none');
        $('#total-list-upload-card').removeClass('d-none');
    }

    // Tìm kiếm
    const doTotalListSearch = () => {
        totalListTable.search($('#total-list-search-input').val()).draw();
    };
    $('#total-list-search-btn').off('click').on('click', doTotalListSearch);
    $('#total-list-search-input').off('keypress').on('keypress', function (e) {
        if (e.which === 13) {
            doTotalListSearch();
        }
    });
    
    // Page length
    $('#total-list-page-length-select').off('change').on('change', function () {
        const len = parseInt(this.value || '50', 10);
        totalListTable.page.len(len).draw();
    });

    // Nút Hiển thị/Cập nhật
    $('#total-list-showDataBtn').off('click').on('click', () => {
        totalListTable.ajax.reload(null, false);
    });

    // Banner nhà thầu của user
    const contractor = userSession?.contractor || '';
    if (!isAdmin && contractor) {
        if (!$('#contractor-badge').length) {
            $('<div class="alert alert-secondary py-2 px-3 mb-2" id="contractor-badge"><i class="fas fa-warehouse me-2"></i>' + contractor + '</div>')
                .insertAfter($('.card-header:contains("Danh sách xe tổng")').closest('.card-header'));
        } else {
            $('#contractor-badge').text(contractor);
        }
    } else {
        $('#contractor-badge').remove();
    }
    
}


function fetchTotalListSummary() {
    google.script.run
        .withSuccessHandler(summary => {
            $('#total-count-summary').text(summary.total);
            $('#active-count').text(summary.active);
            $('#banned-count').text(summary.banned);
        })
        .withFailureHandler(showError)
        .getTotalListSummary(userSession.token);
}

// ====== JS: Xem trước & tô màu lỗi/trùng danh sách tổng ======
function handleTotalListFileUpload() {
  const file = $('#total-list-fileUploader')[0].files[0];
  if (!file) {
    Swal.fire('Chưa chọn file', 'Vui lòng chọn một file.', 'warning');
    return;
  }

  showLoadingDeferred('Đang xử lý và xác thực file...', 120);
  const reader = new FileReader();
  reader.onload = function (e) {
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true });

      google.script.run
        .withSuccessHandler(existingList => {
          try {
            const existingPlates = new Set(Array.isArray(existingList) ? existingList : []);

            const result = validateAndTransformTotalListData(jsonData.slice(1), existingPlates);
            const validationErrors = Array.isArray(result.errors) ? result.errors : [];

            totalListPreviewData = (result.data || []).map(r => ({
              ID: r.ID || (typeof generateRandomId === 'function' ? generateRandomId(12) : String(Date.now())),
              'Truck Plate': r['Truck Plate'] || '',
              Country: r['Country'] || '',
              Wheel: r['Wheel'] || '',
              'Trailer Plate': r['Trailer Plate'] || '',
              'Truck weight': r['Truck weight'] || '',
              'Pay load': r['Pay load'] || '',
              'Container No1': r['Container No1'] || '',
              'Container No2': r['Container No2'] || '',
              'Driver Name': r['Driver Name'] || '',
              'ID/Passport': r['ID/Passport'] || '',
              'Phone number': r['Phone number'] || '',
              'Transportation Company': r['Transportation Company'] || '',
              'Subcontractor': r['Subcontractor'] || '',
              'Vehicle Status': (r['Vehicle Status'] || '').toString().toUpperCase(),
              'Activity Status': r['Activity Status'] || '',
              'Register Date': r['Register Date'] || '',
              'Time': r['Time'] || '',
              _duplicate: typeof r._duplicate === 'boolean'
                ? r._duplicate
                : existingPlates.has(String(r['Truck Plate'] || '').replace(/\s/g, '').toUpperCase()),
              errors: r.errors || null
            }));

            if ($.fn.DataTable.isDataTable('#total-list-previewDataTable')) {
              $('#total-list-previewDataTable').DataTable().clear().destroy();
            }
            $('#total-list-previewDataTable').addClass('table-sm dt-compact');

            const columns = [
              { data: 'ID', title: 'ID', defaultContent: '' },
              { data: 'Truck Plate', title: 'Biển số xe', defaultContent: '' },
              { data: 'Country', title: 'Quốc gia', defaultContent: '' },
              { data: 'Wheel', title: 'Số bánh', defaultContent: '' },
              { data: 'Trailer Plate', title: 'Biển số Mooc', defaultContent: '' },
              { data: 'Truck weight', title: 'Trọng lượng xe', defaultContent: '' },
              { data: 'Pay load', title: 'Tải trọng xe', defaultContent: '' },
              { data: 'Container No1', title: 'Container 1', defaultContent: '' },
              { data: 'Container No2', title: 'Container 2', defaultContent: '' },
              { data: 'Driver Name', title: 'Tên lái xe', defaultContent: '' },
              { data: 'ID/Passport', title: 'Số hộ chiếu', defaultContent: '' },
              { data: 'Phone number', title: 'Số điện thoại', defaultContent: '' },
              { data: 'Transportation Company', title: 'Đơn vị vận chuyển', defaultContent: '' },
              { data: 'Subcontractor', title: 'Nhà thầu phụ', defaultContent: '' },
              { data: 'Vehicle Status', title: 'Tình trạng xe', defaultContent: '' },
              { data: 'Activity Status', title: 'Trạng thái hoạt động', defaultContent: '' },
              { data: 'Register Date', title: 'Ngày tạo', defaultContent: '' },
              { data: 'Time', title: 'Thời gian tạo', defaultContent: '' }
            ];

            totalListPreviewTable = $('#total-list-previewDataTable').DataTable({
              data: totalListPreviewData,
              columns,
              paging: false,
              info: false,
              searching: false,
              scrollX: true,
              createdRow: function (row, rowData) {
                let rowHasError = false;
                if (rowData && rowData.errors) {
                  Object.keys(rowData.errors).forEach((key) => {
                    const colIdx = columns.findIndex(c => c.data === key);
                    if (colIdx !== -1) {
                      $(row).find('td').eq(colIdx)
                        .addClass('is-invalid')
                        .attr('title', rowData.errors[key]);
                      rowHasError = true;
                    }
                  });
                }
                if (rowHasError) $(row).addClass('tl-row-error');
                if (rowData && rowData._duplicate) $(row).addClass('tl-row-dup');
              }
            });

            $('#total-list-previewContainer').removeClass('d-none');
            requestAnimationFrame(() => totalListPreviewTable.columns.adjust());

            const duplicatePlates = totalListPreviewData
              .filter(r => r && r._duplicate)
              .map(r => r['Truck Plate'])
              .filter(Boolean);
            const hasErrors = validationErrors.length > 0;
            const hasDup = duplicatePlates.length > 0;

            const alertSections = [];

            if (hasErrors) {
              const maxErrorRows = 10;
              const errorItems = validationErrors.slice(0, maxErrorRows).map(err => {
                const rowLabel = err && err.row ? `Dòng ${err.row}` : 'Dòng không xác định';
                const messages = Array.isArray(err.messages) ? err.messages.join('<br>') : '';
                return `<li><strong>${rowLabel}</strong><br>${messages}</li>`;
              }).join('');

              alertSections.push(`
                <div>
                  <div class="fw-bold mb-1">Lỗi dữ liệu</div>
                  <div class="text-start" style="max-height:160px; overflow:auto">
                    <ol class="ps-3 mb-0">${errorItems}</ol>
                    ${validationErrors.length > maxErrorRows ? '<div class="mt-2"><small>...</small></div>' : ''}
                  </div>
                </div>
              `);
            }

            if (hasDup) {
              const max = 20;
              const show = duplicatePlates.slice(0, max).join(', ');
              alertSections.push(`
                <div>
                  <div class="fw-bold mb-1">Biển số trùng</div>
                  <div class="text-start" style="max-height:120px; overflow:auto">
                    <small>${show}${duplicatePlates.length > max ? ', ...' : ''}</small>
                  </div>
                  <div class="mt-1"><small>Vui lòng loại bỏ/cập nhật trong file trước khi lưu.</small></div>
                </div>
              `);
            }

            dismissLoading();

            if (alertSections.length) {
              Swal.fire({
                icon: hasErrors ? 'error' : 'warning',
                title: 'Kiểm tra lại dữ liệu tải lên',
                html: alertSections.join('<hr class="my-2">')
              });
            }

            $('#total-list-saveUploadBtn').prop('disabled', hasErrors || hasDup);
          } catch (err) {
            dismissLoading(true);
            showError(err);
          }
        })
        .withFailureHandler(err => { dismissLoading(true); showError(err); })
        .getExistingTruckPlates(userSession.token);

    } catch (err) {
      dismissLoading(true);
      showError(err);
    }
  };
  reader.onerror = function() {
    dismissLoading(true);
    showError({ message: 'Không thể đọc file danh sách tổng. Vui lòng thử lại.' });
  };
  reader.readAsArrayBuffer(file);
}
function generateCustomId() {
  const now = new Date();
  const yy = String(now.getFullYear()).slice(-2);
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let randomStr = '';
  for (let i = 0; i < 6; i++) {
    randomStr += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return `${yy}${mm}-${randomStr}`;
}

function validateAndTransformTotalListData(dataRows, existingPlates) {
  const transformedData = [];
  const allErrors = [];
  const duplicateList = [];

  const allowedActivity = ['ACTIVE', 'BANNED'];
  const allowedVehicleStatus = ['RO', 'CO', 'PM', 'CM', 'AC', 'ND'];
  const allowedCountries = ['VIETNAM', 'LAOS'];

  dataRows.forEach((row, index) => {
    if (row.length === 0 || row.every(cell => cell === "")) return;

    const rowNumber = index + 2; // tính cả header
    const errors = {};
    const addError = (field, message) => {
      if (!message) return;
      errors[field] = errors[field] ? `${errors[field]} ${message}` : message;
    };

    const plate = String(row[1] || '').replace(/\s/g, '').toUpperCase();
    const countryRaw = String(row[2] || '').trim();
    const wheelRaw = String(row[3] || '').trim();
    const trailerPlate = String(row[4] || '').replace(/\s/g, '').toUpperCase();
    const truckWeightRaw = String(row[5] || '').trim();
    const payLoadRaw = String(row[6] || '').trim();
    const registerDateRaw = String(row[16] || '').trim();
    const normalizedRegisterDate = registerDateRaw ? normalizeRegisterDateValue(registerDateRaw) : '';
    const timeRaw = String(row[17] || '').trim();

    const activityRaw = String(row[15] || '').trim();
    const activityUpper = activityRaw.toUpperCase();
    const vehicleStatusRaw = String(row[14] || '').trim().toUpperCase();
    const phoneRaw = String(row[11] || '').trim();
    const transportCompanyRaw = String(row[12] || '').trim();
    const subcontractorRaw = String(row[13] || '').trim();

    const record = {
      'ID': generateCustomId(),
      'Truck Plate': plate,
      'Country': countryRaw,
      'Wheel': wheelRaw,
      'Trailer Plate': trailerPlate,
      'Truck weight': truckWeightRaw,
      'Pay load': payLoadRaw,
      'Container No1': row[7] || '',
      'Container No2': row[8] || '',
      'Driver Name': String(row[9] || '').trim(),
      'ID/Passport': String(row[10] || '').trim(),
      'Phone number': phoneRaw,
      'Transportation Company': transportCompanyRaw,
      'Subcontractor': subcontractorRaw,
      'Vehicle Status': vehicleStatusRaw,
      'Activity Status': activityRaw,
      'Register Date': normalizedRegisterDate || registerDateRaw,
      'Time': timeRaw,
      _duplicate: existingPlates.has(plate)
    };

    if (!plate) {
      addError('Truck Plate', "- Cột 'Truck Plate' không được để trống.");
    } else {
      if (plate.length > 13) {
        addError('Truck Plate', "- Cột 'Truck Plate' không vượt quá 13 ký tự.");
      }

      // Biển số Việt Nam: chữ cái Latin, số, '-', '.'
      const vnPlateRegex = /^[A-Za-z0-9.-]+$/;

      // Biển số Lào: chữ Lào (U+0E80–U+0EFF), số và dấu '.'
      const laPlateRegex = /^[\u0E80-\u0EFF0-9.]+$/;

      if (!vnPlateRegex.test(plate) && !laPlateRegex.test(plate)) {
        addError(
          'Truck Plate',
          "- Cột 'Truck Plate' chỉ chấp nhận biển số Việt Nam (A-Z, 0-9, '-', '.') hoặc biển số Lào (ບຄ4693 hoặc ບຄ4693.)."
        );
      }
    }

    if (!countryRaw) {
      addError('Country', "- Cột 'Country' không được để trống.");
    } else if (!allowedCountries.includes(countryRaw.toUpperCase())) {
      addError('Country', "- Cột 'Country' chỉ chấp nhận: Vietnam, Laos.");
    }

    if (!wheelRaw) {
      addError('Wheel', "- Cột 'Wheel' không được để trống.");
    } else {
      const wheelValue = Number(wheelRaw);
      if (!Number.isInteger(wheelValue) || wheelValue <= 0) {
        addError('Wheel', "- Cột 'Wheel' phải là số nguyên dương.");
      }
    }

    if (!truckWeightRaw) {
      addError('Truck weight', "- Cột 'Truck weight' không được để trống.");
    } else {
      const truckWeightValue = Number(truckWeightRaw);
      if (!Number.isFinite(truckWeightValue) || truckWeightValue <= 0) {
        addError('Truck weight', "- Cột 'Truck weight' phải là số lớn hơn 0.");
      }
    }

    if (!payLoadRaw) {
      addError('Pay load', "- Cột 'Pay load' không được để trống.");
    } else {
      const payLoadValue = Number(payLoadRaw);
      if (!Number.isFinite(payLoadValue) || payLoadValue <= 0) {
        addError('Pay load', "- Cột 'Pay load' phải là số lớn hơn 0.");
      }
    }

    if (!record['Driver Name']) {
      addError('Driver Name', "- Cột 'Driver Name' không được để trống.");
    }

    if (!record['ID/Passport']) {
      addError('ID/Passport', "- Cột 'ID/Passport' không được để trống.");
    }

    if (phoneRaw) {
      if (!/^.{0,200}$/.test(phoneRaw)) {
        addError('Phone number', "- Cột 'Phone number' chỉ chấp nhận tối đa 200 ký tự (ít nhất 8 ký tự).");
      }
    }

    if (!transportCompanyRaw) {
      addError('Transportation Company', "- Cột 'Transportation Company' không được để trống.");
    }

    if (!subcontractorRaw) {
      addError('Subcontractor', "- Cột 'Subcontractor' không được để trống.");
    }

    if (!vehicleStatusRaw) {
      addError('Vehicle Status', "- Cột 'Vehicle Status' không được để trống.");
    } else if (!allowedVehicleStatus.includes(vehicleStatusRaw)) {
      addError('Vehicle Status', "- Cột 'Vehicle Status' chỉ chấp nhận: RO, CO, PM, CM, AC, ND.");
    }

    if (!activityRaw) {
      addError('Activity Status', "- Cột 'Activity Status' không được để trống.");
    } else if (!allowedActivity.includes(activityUpper)) {
      addError('Activity Status', "- Cột 'Activity Status' chỉ chấp nhận: Active, Banned.");
    }

    if (registerDateRaw && !normalizedRegisterDate) {
      addError('Register Date', "- Cột 'Register Date' không đúng định dạng (dd/MM/yyyy hoặc yyyy-MM-dd).");
    }

    if (timeRaw) {
      if (!/^\d{1,2}:\d{2}(:\d{2})?$/.test(timeRaw)) {
        addError('Time', "- Cột 'Time' phải có định dạng HH:mm hoặc HH:mm:ss.");
      }
    }

    if (Object.keys(errors).length) {
      record.errors = errors;
      allErrors.push({
        row: rowNumber,
        fields: Object.keys(errors),
        messages: Object.values(errors)
      });
    }
    if (record._duplicate) {
      duplicateList.push(plate);
    }

    transformedData.push(record);
  });

  return { data: transformedData, duplicates: duplicateList, errors: allErrors };
}


// ====== JS: LƯU NỐI TIẾP DANH SÁCH TỔNG (KHÔNG GHI ĐÈ) ======
function handleSaveTotalListUploadedData() {
  // Không cho lưu nếu còn lỗi hoặc còn trùng
  const duplicatePlates = totalListPreviewData
    .filter(r => r && r._duplicate)
    .map(r => r['Truck Plate'])
    .filter(Boolean);

  const hasErrors = totalListPreviewData.some(
    r => r && r.errors && Object.keys(r.errors).length
  );

  if (hasErrors || duplicatePlates.length > 0) {
    const max = 20;
    const show = duplicatePlates.slice(0, max).join(', ');
    Swal.fire({
      icon: 'error',
      title: 'Không thể lưu',
      html:
        (hasErrors ? 'Còn dòng <b>sai định dạng</b>.<br>' : '') +
        (duplicatePlates.length
          ? `Có <b>${duplicatePlates.length}</b> biển số trùng:<br>
             <div class="text-start mt-2" style="max-height:120px; overflow:auto">
               <small>${show}${duplicatePlates.length > max ? ', ...' : ''}</small>
             </div>`
          : '')
    });
    return;
  }

  // Chỉ lấy các dòng hợp lệ (không trùng)
  const validRows = totalListPreviewData.filter(r => r && !r._duplicate);

  // Tự điền "Ngày tạo" & "Thời gian tạo" dạng TEXT (dd/MM/yyyy & HH:mm:ss)
  const now = new Date();
  const pad = n => String(n).padStart(2, '0');
  const regDate = `${pad(now.getDate())}/${pad(now.getMonth() + 1)}/${now.getFullYear()}`;
  const regTime = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;

  const payload = validRows.map(r => ({
    ...r,
    'Register Date': r['Register Date'] || regDate,
    'Time': r['Time'] || regTime
  }));

  showLoadingDeferred('Đang cập nhật danh sách...', 120);
  google.script.run
    .withSuccessHandler(msg => {
      dismissLoading();
      Swal.fire({
        icon: 'success',
        title: 'Lưu thành công',
        text: msg || 'Đã thêm mới vào Danh sách xe tổng.',
        timer: 1800,
        showConfirmButton: false
      });

      // Làm tươi bảng dưới nếu đang mở
      if ($.fn.DataTable.isDataTable('#totalListTable')) {
        $('#totalListTable').DataTable().ajax.reload(null, false);
      }
      fetchTotalListSummary();      

      // Dọn preview
      totalListPreviewData = [];
      if ($.fn.DataTable.isDataTable('#total-list-previewDataTable')) {
        $('#total-list-previewDataTable').DataTable().clear().destroy();
      }
      $('#total-list-previewContainer').addClass('d-none');
      $('#total-list-saveUploadBtn').prop('disabled', true);
      $('#total-list-fileUploader').val('').trigger('change');
    })
    .withFailureHandler(err => { dismissLoading(true); showError(err); })
    .saveTotalListAppend(payload, userSession.token);   // <== APPEND, không ghi đè
}





function handleDeleteTotalList() {
    const selectedIds = totalListTable.rows('.selected').data().toArray().map(row => row.ID);
    
    if (selectedIds.length === 0) {
        Swal.fire('Chưa chọn xe', 'Vui lòng chọn ít nhất một xe để xóa.', 'warning');
        return;
    }

    Swal.fire({
        title: `Bạn có chắc muốn xóa ${selectedIds.length} xe?`,
        text: "Hành động này sẽ xóa vĩnh viễn xe khỏi danh sách tổng!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonText: 'Hủy',
        confirmButtonText: 'Vâng, xóa đi!'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoadingDeferred('Đang xóa xe...', 120);
            google.script.run
                .withSuccessHandler(message => {
                    dismissLoading();
                    Swal.fire('Đã xóa!', message, 'success');
                    totalListTable.draw(false);
                    fetchTotalListSummary();
                })
                .withFailureHandler(err => { dismissLoading(true); showError(err); })
                .deleteTotalListVehicles(selectedIds, userSession.token);
        }
    });
}

function handleEditTotalListVehicle(rowData) {
    const createOptions = (items, selectedValue) => items.map(item => `<option value="${item}" ${item === selectedValue ? 'selected' : ''}>${item}</option>`).join('');

    const formHtml = `
        <form id="editTotalListForm" class="edit-form-grid">
            <div class="form-group"><label>ID</label><input type="text" class="form-control" value="${rowData.ID}" readonly></div>
            <div class="form-group"><label>Biển số xe</label><input type="text" id="editTruckPlate" class="form-control" value="${rowData['Truck Plate'] || ''}" maxlength="11" required></div>
            <div class="form-group"><label>Quốc gia</label>
                <select id="editCountry" class="form-select">${createOptions(['Vietnam', 'Laos'], rowData['Country'])}</select>
            </div>
            <div class="form-group"><label>Số bánh</label><input type="number" id="editWheel" class="form-control" value="${rowData['Wheel'] || ''}" max="1000" required></div>
            <div class="form-group"><label>Biển số Mooc</label><input type="text" id="editTrailerPlate" class="form-control" value="${rowData['Trailer Plate'] || ''}" maxlength="11"></div>
            <div class="form-group"><label>Trọng lượng xe</label><input type="number" id="editTruckWeight" class="form-control" value="${rowData['Truck weight'] || ''}" max="1000" step="0.01" required></div>
            <div class="form-group"><label>Tải trọng xe</label><input type="number" id="editPayLoad" class="form-control" value="${rowData['Pay load'] || ''}" max="1000" step="0.01" required></div>
            <div class="form-group"><label>Container 1</label><input type="text" id="editContainerNo1" class="form-control" value="${rowData['Container No1'] || ''}" maxlength="70"></div>
            <div class="form-group"><label>Container 2</label><input type="text" id="editContainerNo2" class="form-control" value="${rowData['Container No2'] || ''}" maxlength="70"></div>
            <div class="form-group"><label>Tên lái xe</label><input type="text" id="editDriverName" class="form-control" value="${rowData['Driver Name'] || ''}" maxlength="70" required></div>
            <div class="form-group"><label>Số hộ chiếu</label><input type="text" id="editIdPassport" class="form-control" value="${rowData['ID/Passport'] || ''}" maxlength="70" required></div>
            <div class="form-group"><label>Số điện thoại</label><input type="number" id="editPhoneNumber" class="form-control" value="${rowData['Phone number'] || ''}"></div>
            <div class="form-group"><label>Đơn vị vận chuyển</label>
                <select class="form-select" id="editTransportationCompany">
                    ${createOptions(allowedCompanies, rowData['Transportation Company'])}
                </select>
            </div>
            <div class="form-group"><label>Nhà thầu phụ</label><input type="text" id="editSubcontractor" class="form-control" value="${rowData['Subcontractor'] || ''}" maxlength="70" required></div>
            <div class="form-group"><label>Tình trạng xe</label>
                <select class="form-select" id="editVehicleStatus" required>
                    ${createOptions(['RO', 'CO', 'PM', 'CM', 'AC', 'ND'], rowData['Vehicle Status'])}
                </select>
            </div>
            <div class="form-group"><label>Trạng thái hoạt động</label>
                <select class="form-select" id="editActivityStatus" required>
                    ${createOptions(['Active', 'Banned'], rowData['Activity Status'])}
                </select>
            </div>         
        </form>`;

    Swal.fire({
        title: 'Chỉnh sửa thông tin xe (Danh sách tổng)',
        html: formHtml,
        width: '90%',
        showCancelButton: true,
        confirmButtonText: 'Lưu thay đổi',
        cancelButtonText: 'Hủy bỏ',
        preConfirm: () => {
            const form = $('#editTotalListForm')[0];
            if (!form.checkValidity()) {
                Swal.showValidationMessage('Vui lòng điền đầy đủ và đúng định dạng các trường bắt buộc.');
                return false;
            }
            const updatedRecord = { ...rowData };
            updatedRecord['Truck Plate'] = $('#editTruckPlate').val().replace(/\s/g, '').toUpperCase();
            updatedRecord['Country'] = $('#editCountry').val();
            updatedRecord['Wheel'] = $('#editWheel').val();
            updatedRecord['Trailer Plate'] = $('#editTrailerPlate').val().replace(/\s/g, '').toUpperCase();
            updatedRecord['Truck weight'] = $('#editTruckWeight').val();
            updatedRecord['Pay load'] = $('#editPayLoad').val();
            updatedRecord['Container No1'] = $('#editContainerNo1').val();
            updatedRecord['Container No2'] = $('#editContainerNo2').val();
            updatedRecord['Driver Name'] = $('#editDriverName').val();
            updatedRecord['ID/Passport'] = $('#editIdPassport').val();
            updatedRecord['Phone number'] = $('#editPhoneNumber').val();
            updatedRecord['Transportation Company'] = $('#editTransportationCompany').val();
            updatedRecord['Subcontractor'] = $('#editSubcontractor').val();
            updatedRecord['Vehicle Status'] = $('#editVehicleStatus').val();
            updatedRecord['Activity Status'] = $('#editActivityStatus').val();            
            const now = new Date();
            updatedRecord['Register Date'] = getFormattedDate(now);
            updatedRecord['Time'] = now.toTimeString().split(' ')[0];      
            return updatedRecord;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading('Đang cập nhật...');
            google.script.run
                .withSuccessHandler(message => {
                    Swal.fire('Thành công!', message, 'success');
                    totalListTable.draw(false);
                    fetchTotalListSummary();                    
                })
                .withFailureHandler(showError)
                .updateTotalListVehicle(result.value, userSession.token);
        }
    });
}

// =================================================================
// UTILITY FUNCTIONS
// =================================================================
function ensureVietnamTime() {
    if (vietnamTimeState && typeof vietnamTimeState.epochMillis === 'number' && typeof vietnamTimeState.clientCapturedAt === 'number') {
        return Promise.resolve(vietnamTimeState);
    }
    if (vietnamTimePromise) {
        return vietnamTimePromise;
    }

    vietnamTimePromise = new Promise(resolve => {
        const finish = data => {
            setVietnamTimeState(data);
            resolve(vietnamTimeState);
            vietnamTimePromise = null;
        };

        if (typeof google === 'undefined' || !google.script || !google.script.run) {
            finish({ epochMillis: Date.now() });
            return;
        }

        google.script.run
            .withSuccessHandler(finish)
            .withFailureHandler(err => {
                console.error('Failed to fetch Vietnam time:', err);
                finish({ epochMillis: Date.now() });
            })
            .getVietnamCurrentTime();
    });

    return vietnamTimePromise;
}

function setVietnamTimeState(data) {
    const epochMillis = data && typeof data.epochMillis === 'number'
        ? data.epochMillis
        : Date.now();
    vietnamTimeState = {
        epochMillis,
        clientCapturedAt: Date.now(),
        isoDate: data && typeof data.isoDate === 'string' ? data.isoDate : null,
        dateString: data && typeof data.dateString === 'string' ? data.dateString : null,
        timeString: data && typeof data.timeString === 'string' ? data.timeString : null
    };
}

function getVietnamNowClient() {
    if (vietnamTimeState && typeof vietnamTimeState.epochMillis === 'number' && typeof vietnamTimeState.clientCapturedAt === 'number') {
        const elapsed = Date.now() - vietnamTimeState.clientCapturedAt;
        return new Date(vietnamTimeState.epochMillis + elapsed);
    }
    return new Date();
}

function addVietnamDays(date, days) {
    if (!(date instanceof Date) || isNaN(date) || !Number.isFinite(days)) {
        return new Date(NaN);
    }

    const offsetDays = Number(days);
    const parts = getVietnamDateParts(date);
    if (!parts) {
        return new Date(NaN);
    }

    const baseDate = createUtcDate(
        Number.parseInt(parts.year, 10),
        Number.parseInt(parts.month, 10),
        Number.parseInt(parts.day, 10)
    );

    if (!baseDate) {
        return new Date(NaN);
    }

    if (offsetDays !== 0) {
        baseDate.setUTCDate(baseDate.getUTCDate() + offsetDays);
    }

    return baseDate;
}

function getVietnamDateParts(date) {
    if (!(date instanceof Date) || isNaN(date)) {
        return null;
    }
    const formatter = new Intl.DateTimeFormat('en-GB', {
        timeZone: VIETNAM_TIMEZONE,
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    });
    const parts = formatter.formatToParts(date);
    const result = {};
    parts.forEach(part => {
        if (part.type !== 'literal') {
            result[part.type] = part.value;
        }
    });
    return result;
}

function getFormattedDate(date) {
    const parts = getVietnamDateParts(date);
    if (!parts) return '';
    return `${parts.day}/${parts.month}/${parts.year}`;
}

function getVietnamIsoDate(date) {
    const parts = getVietnamDateParts(date);
    if (!parts) return '';
    return `${parts.year}-${parts.month}-${parts.day}`;
}

function parseDateValue(value) {
    if (value instanceof Date) {
        return isNaN(value) ? null : value;
    }
    if (typeof value !== 'string') return null;
    const trimmed = value.trim();
    if (!trimmed) return null;

    let match = trimmed.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (match) {
        const year = parseInt(match[1], 10);
        const month = parseInt(match[2], 10);
        const day = parseInt(match[3], 10);
        if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
            const date = new Date(Date.UTC(year, month - 1, day));
            if (date.getUTCFullYear() === year && date.getUTCMonth() === month - 1 && date.getUTCDate() === day) {
                return date;
            }
        }
        return null;
    }

    match = trimmed.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (match) {
        const day = parseInt(match[1], 10);
        const month = parseInt(match[2], 10);
        const year = parseInt(match[3], 10);
        if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
            const date = new Date(Date.UTC(year, month - 1, day));
            if (date.getUTCFullYear() === year && date.getUTCMonth() === month - 1 && date.getUTCDate() === day) {
                return date;
            }
        }
        return null;
    }

    return null;
}

function normalizeRegisterDateValue(value) {
    const parsed = parseDateValue(value);
    return parsed ? getFormattedDate(parsed) : '';
}

function normalizeToUtcDate(date) {
    if (!(date instanceof Date) || isNaN(date)) return null;
    return new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
}

function toUtcDateKey(date) {
    const normalized = normalizeToUtcDate(date);
    if (!normalized) return '';
    const y = normalized.getUTCFullYear();
    const m = String(normalized.getUTCMonth() + 1).padStart(2, '0');
    const d = String(normalized.getUTCDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

function createUtcDate(year, month, day) {
    if (typeof year !== 'number' || !isFinite(year) || typeof month !== 'number' || !isFinite(month) || typeof day !== 'number' || !isFinite(day)) return null;
    if (year < 1900 || month < 1 || month > 12 || day < 1 || day > 31) return null;
    const date = new Date(Date.UTC(year, month - 1, day));
    if (date.getUTCFullYear() !== year || date.getUTCMonth() !== month - 1 || date.getUTCDate() !== day) {
        return null;
    }
    return date;
}

function collectExcelDateCandidates(value) {
    const candidates = new Map();

    const addCandidate = (date, format) => {
        const normalized = normalizeToUtcDate(date);
        if (!normalized) return;
        const key = toUtcDateKey(normalized);
        if (!key || candidates.has(key)) return;
        candidates.set(key, { date: normalized, format: format || 'unknown', key });
    };

    if (value instanceof Date && !isNaN(value)) {
        addCandidate(value, 'dateObject');
    } else if (typeof value === 'number' && isFinite(value)) {
        const millis = Math.round((value - 25569) * 86400 * 1000);
        addCandidate(new Date(millis), 'serial');
    }

    if (typeof value === 'string') {
        const trimmed = value.trim();
        if (trimmed) {
            const sanitized = trimmed.replace(/^'+/, '').replace(/"/g, '');

            const numericMatch = sanitized.match(/^\d+(?:\.\d+)?$/);
            if (numericMatch) {
                const serialValue = Number.parseFloat(numericMatch[0]);
                if (Number.isFinite(serialValue)) {
                    const millis = Math.round((serialValue - 25569) * 86400 * 1000);
                    addCandidate(new Date(millis), 'serialString');
                }
            }

            const digitParts = sanitized.match(/(\d{1,4})/g);

            if (digitParts && digitParts.length === 3) {
                const numbers = digitParts.map(part => parseInt(part, 10));
                const lengths = digitParts.map(part => part.length);

                const addFromParts = (year, month, day, format) => {
                    const candidate = createUtcDate(year, month, day);
                    if (candidate) addCandidate(candidate, format);
                };

                if (lengths[0] === 4) {
                    addFromParts(numbers[0], numbers[1], numbers[2], 'YMD');
                } else if (lengths[2] === 4) {
                    addFromParts(numbers[2], numbers[1], numbers[0], 'DMY');
                    addFromParts(numbers[2], numbers[0], numbers[1], 'MDY');
                } else if (lengths[1] === 4) {
                    addFromParts(numbers[1], numbers[0], numbers[2], 'DMY');
                    addFromParts(numbers[1], numbers[2], numbers[0], 'MDY');
                } else {
                    addFromParts(numbers[2], numbers[1], numbers[0], 'DMY');
                    addFromParts(numbers[2], numbers[0], numbers[1], 'MDY');
                }
            }

            const fallback = new Date(sanitized);
            if (!isNaN(fallback)) {
                addCandidate(fallback, 'native');
            }
        }
    }

    return Array.from(candidates.values());
}

function parseExcelDateDetailed(excelDate, options = {}) {
    const preferDayFirst = options.preferDayFirst !== false;
    const strictAmbiguity = Boolean(options.strictAmbiguity);
    const requireExpected = Boolean(options.requireExpected);
    const expectedDate = options.expectedDate instanceof Date && !isNaN(options.expectedDate)
        ? normalizeToUtcDate(options.expectedDate)
        : null;
    const expectedKey = expectedDate ? toUtcDateKey(expectedDate) : '';

    const candidates = collectExcelDateCandidates(excelDate);
    if (!candidates.length) {
        return { date: null, errorCode: 'invalid' };
    }

    let matching = [];
    if (expectedKey) {
        matching = candidates.filter(candidate => candidate.key === expectedKey);
        if (matching.length === 1) {
            return { date: matching[0].date, errorCode: null };
        }
        if (matching.length > 1) {
            return { date: matching[0].date, errorCode: null };
        }
        if (requireExpected) {
            return { date: null, errorCode: 'unexpected' };
        }
    }

    if (candidates.length === 1) {
        return { date: candidates[0].date, errorCode: null };
    }

    if (matching.length === 1) {
        return { date: matching[0].date, errorCode: null };
    }

    if (strictAmbiguity) {
        return { date: null, errorCode: 'ambiguous' };
    }

    if (preferDayFirst) {
        const dmy = candidates.find(candidate => candidate.format === 'DMY');
        if (dmy) {
            return { date: dmy.date, errorCode: null };
        }
    }

    return { date: candidates[0].date, errorCode: null };
}

function parseExcelDate(excelDate, options) {
    const result = parseExcelDateDetailed(excelDate, options || {});
    return result.date || null;    
}


let loadingModalTimer = null;
let loadingModalVisible = false;

function clearPendingLoadingTimer() {
  if (loadingModalTimer) {
    clearTimeout(loadingModalTimer);
    loadingModalTimer = null;
  }
}

function showLoading(title) {
    clearPendingLoadingTimer();
    Swal.fire({
        title: title,
        allowOutsideClick: false,
        didOpen: () => {
            loadingModalVisible = true;
            Swal.showLoading();
        },
        willClose: () => {
            loadingModalVisible = false;
        }
    });
}

function showLoadingDeferred(title, delay = 150) {
    clearPendingLoadingTimer();
    const wait = Math.max(0, Number(delay) || 0);
    if (wait === 0) {
        showLoading(title);
        return;
    }
    loadingModalTimer = setTimeout(() => {
        loadingModalTimer = null;
        showLoading(title);
    }, wait);
}

function dismissLoading(force = false) {
    clearPendingLoadingTimer();
    if (force || loadingModalVisible) {
        try { Swal.close(); } catch (_) {}
    }
}

function formatMinutesForDisplay(minutes) {
  const value = parseInt(minutes, 10);
  if (isNaN(value) || value <= 0) return 'a few minutes';
  return `${value} minute${value === 1 ? '' : 's'}`;
}

function localizeErrorMessage(message, lang) {
  const rawMessage = (message || '').trim();
  if (!rawMessage) return rawMessage;

  const patterns = [
    {
      regex: /Tài khoản của bạn đã bị tạm khóa\. Vui lòng thử lại sau (\d+)\s*phút\./i,
      en: match => `Your account has been temporarily locked. Please try again in ${formatMinutesForDisplay(match[1])}.`
    },
    {
      regex: /Tên đăng nhập hoặc mật khẩu không đúng\./i,
      en: () => 'The username or password is incorrect.'
    },
    {
      regex: /Tài khoản này đã được đăng nhập trên một thiết bị khác\./i,
      en: () => 'This account is already logged in on another device.'
    }
  ];

  if (lang === 'en') {
    for (const entry of patterns) {
      const match = rawMessage.match(entry.regex);
      if (match) {
        if (typeof entry.en === 'function') {
          const translated = entry.en(match);
          if (translated) return translated;
        } else if (entry.en) {
          return entry.en;
        }
      }
    }
  }

  return rawMessage;
}

function showError(error) {
  dismissLoading();
  const t = translations[currentLang] || translations.vi || {};
  let raw = getRawErrorMessage(error);
  if (!raw) raw = 'Đã xảy ra lỗi không xác định. Vui lòng thử lại.';

  const serverBusyRegex = /(http\s*503|service unavailable|networkerror|connection failure)/i;
  const isServerBusy = serverBusyRegex.test(raw);

  if (!isServerBusy) {
    closeServerBusyToast();
  }

  if (raw.includes('Bạn chưa đăng nhập')) {
    clearStoredSession();
    try { userSession = { isLoggedIn: false, role: null, contractor: null, token: null }; } catch (_) {}
    try { sessionStorage.removeItem(SESSION_FLAG_KEY); } catch (_) {}
    Swal.fire({
      icon: 'error',
      title: t.session_expired_title || 'Phiên làm việc đã hết hạn',
      text: t.session_expired_text || 'Vui lòng đăng nhập lại.',
      timer: 3000,
      timerProgressBar: true,
      didClose: () => { window.location.reload(); }
    });
    return;
  }

  if (isServerBusy) {
    const message = t.server_busy_final_message || t.server_busy_message || 'Hệ thống đang xử lý quá nhiều yêu cầu. Vui lòng thử lại sau ít phút.';
    showServerBusyToast({ sticky: true, message, title: t.server_busy_title || 'Máy chủ bận' });
    return;
  }

  const cleanMsg = getCleanErrorMessage(error) || raw;
  const safeMsg = cleanMsg || raw || 'Đã xảy ra lỗi không xác định. Vui lòng thử lại.';
  const displayMsg = localizeErrorMessage(safeMsg, currentLang);  

  // --- Nhận diện "Xe mới" ---
  const mNew =
    safeMsg.match(/Xe\s+(.+?)\s+là xe mới/i) ||
    safeMsg.match(/Vehicle plate\(s\)\s+(.+?)\s+are new/i);
  if (mNew && mNew[1]) {
    const platesNew = mNew[1].split(/[,\n\r\t ]+/).map(s => s.trim()).filter(Boolean);
    if (platesNew.length) { showNewVehiclePopup(platesNew); return; }
  }

  // --- Nhận diện "Xe trùng đơn vị khác" ---
  const dupPatternVi = /đã được đăng ký với (công ty|đơn vị)(?:\s+vận chuyển)? khác/i;
  const dupPatternEn = /have already been registered with another transport company/i;
  if (dupPatternVi.test(safeMsg) || dupPatternEn.test(safeMsg) || /->\s*\"/.test(safeMsg)) {
    // Cố gắng bóc biển số từ dạng "PLATE -> "Company""
    const found = [];
    const pairRegex = /([A-Z0-9\-\.]+)\s*->/gi;
    let p;
    while ((p = pairRegex.exec(safeMsg)) !== null) found.push(p[1]);

    if (!found.length) {
      let extracted = null;
      const mDupVi = safeMsg.match(/Xe\s+(.+?)\s+đã được đăng ký/i);
      if (mDupVi && mDupVi[1]) extracted = mDupVi[1];
      else {
        const mDupEn = safeMsg.match(/Vehicle plate\(s\)\s+(.+?)\s+have already been registered/i);
        if (mDupEn && mDupEn[1]) extracted = mDupEn[1];
      }
      if (extracted) {
        extracted.split(/[,\n\r\t ]+/).forEach(s => { s = s.trim(); if (s) found.push(s); });
      }
    }
    if (found.length) { showDuplicatedVehiclesPopup(found); return; }
  }

  // Mặc định: báo lỗi chuẩn
  Swal.fire({
    icon: 'warning',
    iconHtml: '⚠️',
    title: t.error_title || 'Lỗi',
    text: displayMsg,
    customClass: { icon: 'swal2-warning-emoji' }
  });
}



// Popup "Xe trùng đơn vị khác" – icon cảnh báo, tối đa 20 biển số, mỗi biển số 1 dòng, có "..."
function showDuplicatedVehiclesPopup(platesInput) {
  let plates = Array.isArray(platesInput) ? platesInput : String(platesInput || '');

  if (!Array.isArray(plates)) {
    // Tách các cặp "PLATE -> "Company"" nếu có
    const found = [];
    const pairRegex = /([A-Z0-9\-\.]+)\s*->/gi;
    let m;
    while ((m = pairRegex.exec(plates)) !== null) found.push(m[1]);
    plates = found.length ? found : plates.split(/[,\n\r\t ]+/).map(s => s.trim()).filter(Boolean);
  }

  Swal.fire({
    title: (translations[currentLang] && translations[currentLang].duplicate_vehicle_popup_title) || 'Xe trùng đơn vị khác',
    icon: 'warning',
    html: `
      ${buildListHtml(plates)}
      <div style="margin-top:8px; font-weight:600;">
        ${(translations[currentLang] && translations[currentLang].duplicate_vehicle_popup_message) || 'Là các xe đã được đăng ký với đơn vị vận chuyển khác. Yêu cầu liên hệ PSVN để được xử lý.'}
      </div>
    `,
    width: 520,
    confirmButtonText: (translations[currentLang] && translations[currentLang].popup_ok_button) || 'OK',
    allowOutsideClick: true,
    didOpen: () => {
      const c = Swal.getHtmlContainer();
      if (c) { c.style.maxHeight = '60vh'; c.style.overflowY = 'auto'; }
    }
  }).then(() => {
    // bôi vàng
    highlightRowsInTable(plates, 'hl-dup-vehicle');
  });
}



// Popup "Thông báo xe mới" – hiển thị tối đa 20 biển số, mỗi biển số 1 dòng, có "..." nếu còn nữa
function showNewVehiclePopup(newPlates) {
  const plates = Array.isArray(newPlates)
    ? newPlates
    : String(newPlates || '').split(/[,\n\r\t ]+/).map(s => s.trim()).filter(Boolean);

  Swal.fire({
    title: (translations[currentLang] && translations[currentLang].new_vehicle_popup_title) || 'Thông báo xe mới',
    icon: 'info',
    html: `
      ${buildListHtml(plates)}
      <div style="margin-top:8px; font-weight:600;">
        ${(translations[currentLang] && translations[currentLang].new_vehicle_popup_message) || 'Là xe mới. Yêu cầu gửi đăng ký bổ sung vào danh sách tổng với PSVN.'}
      </div>
    `,
    width: 520,
    confirmButtonText: (translations[currentLang] && translations[currentLang].popup_ok_button) || 'OK',
    allowOutsideClick: true,
    didOpen: () => {
      const c = Swal.getHtmlContainer();
      if (c) { c.style.maxHeight = '60vh'; c.style.overflowY = 'auto'; }
    }
  }).then(() => {
    // bôi đỏ
    highlightRowsInTable(plates, 'hl-new-vehicle');
  });
}



function generateRandomId(length) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}




// === Total List Export to Excel ===
// === Total List Export to Excel (lấy thứ tự cột từ DataTable) ===
function exportTotalListExcel() {
    if (!userSession || !userSession.token) {
        Swal.fire('Phiên đã hết hạn', 'Vui lòng đăng nhập lại.', 'warning');
        return;
    }

    const table = totalListTable;
    // Lấy các cột đang HIỂN THỊ theo thứ tự hiện tại (bỏ cột select + action vì data = null)
    const colIdxs = table.columns({ visible: true, order: 'index' }).indexes().toArray();
    const aoCols = table.settings()[0].aoColumns;
    const cols = colIdxs
        .map(idx => {
            const def = aoCols[idx];
            return {
                key: def.data, // tên field trong object
                title: $(table.column(idx).header()).text().trim()
            };
        })
        .filter(c => typeof c.key === 'string' && c.key.length > 0); // loại bỏ cột kỹ thuật (null/undefined)

    const params = {
        draw: 1,
        start: 0,
        length: 100000, // đủ lớn
        search: { value: table ? table.search() : '' },
        order: [], // để server không reorder cột/field
        sessionToken: userSession.token
    };

    showLoading('Đang chuẩn bị dữ liệu...');
    google.script.run
        .withSuccessHandler(res => {
            Swal.close();

            const rows = Array.isArray(res?.data) ? res.data
                        : (Array.isArray(res?.rows) ? res.rows : []);
            if (!rows.length) {
                Swal.fire('Không có dữ liệu', 'Không có dữ liệu để xuất file.', 'info');
                return;
            }

            // Header theo đúng title đang hiển thị
            const exportData = [cols.map(c => c.title)];
            // Map dữ liệu theo đúng thứ tự cột
            rows.forEach(r => {
                exportData.push(cols.map(c => (r[c.key] ?? '')));
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            (function applyWorksheetStyling() {
                if (!ws['!ref']) return;
                const range = XLSX.utils.decode_range(ws['!ref']);
                const borderSide = { style: 'thin', color: { rgb: '000000' } };
                const headerRow = range.s.r;
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const ref = XLSX.utils.encode_cell({ r: R, c: C });
                        const cell = ws[ref];
                        if (!cell) continue;
                        cell.s = cell.s || {};
                        cell.s.border = {
                            top: borderSide,
                            right: borderSide,
                            bottom: borderSide,
                            left: borderSide
                        };
                        if (R === headerRow) {
                            cell.s.font = Object.assign({}, cell.s.font, { bold: true });
                        }
                    }
                }
                const colCount = exportData[0] ? exportData[0].length : 0;
                if (!colCount) return;
                const colWidths = [];
                for (let cIdx = 0; cIdx < colCount; ++cIdx) {
                    let maxLen = 0;
                    for (let rIdx = 0; rIdx < exportData.length; ++rIdx) {
                        const cellValue = exportData[rIdx][cIdx];
                        const text = cellValue == null ? '' : String(cellValue);
                        const parts = text.split(/\r?\n/);
                        for (let p = 0; p < parts.length; ++p) {
                            const len = parts[p].length;
                            if (len > maxLen) maxLen = len;
                        }
                    }
                    const width = Math.min(Math.max(maxLen + 2, 10), 60);
                    colWidths.push({ wch: width });
                }
                ws['!cols'] = colWidths;
            })();            
            XLSX.utils.book_append_sheet(wb, ws, 'TotalList');

            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            XLSX.writeFile(wb, `TotalList_${yyyy}-${mm}-${dd}.xlsx`);
        })
        .withFailureHandler(err => { Swal.close(); showError(err); })
        .getTotalListDataServerSide(params);
}

// Chuẩn hóa biển số để so sánh
function normalizePlate(s) {
  return String(s || '')
    .toUpperCase()
    .replace(/\s+/g, '')
    .replace(/[^A-Z0-9\-\.]/g, ''); // giữ lại ký tự thường thấy
}

// Lấy instance DataTable cần bôi màu (ưu tiên bảng preview khi upload)
function getActiveRegistrationTable() {
  if ($.fn.DataTable.isDataTable('#previewDataTable')) return $('#previewDataTable').DataTable();
  if (typeof registeredVehicleTable !== 'undefined' && registeredVehicleTable) return registeredVehicleTable;
  return null;
}

// Bôi màu các hàng theo danh sách biển số
function highlightRowsInTable(plates, className) {
  const table = getActiveRegistrationTable();
  if (!table || !Array.isArray(plates) || !plates.length) return;

  const setPlates = new Set(plates.map(normalizePlate));

  table.rows().every(function () {
    const node = $(this.node());
    const row = this.data();
    // Thử lấy theo object key, nếu không có thì fallback đọc text theo cột "Truck Plate"
    let plate = '';
    if (row && typeof row === 'object') {
      if (row['Truck Plate']) plate = row['Truck Plate'];
      else if (Array.isArray(row)) {
        // đoán cột biển số nếu DataTable trả mảng: thử tìm cell có pattern
        const text = node.find('td').map((i, td) => $(td).text().trim()).get();
        const maybe = text.find(t => /[A-Z0-9]{2,}[-\.][A-Z0-9]+/.test(t) || /[A-Z]{1,3}\d{3,}/i.test(t)) || '';
        plate = maybe;
      }
    }
    if (setPlates.has(normalizePlate(plate))) {
      node.addClass(className);
    }
  });
}

// Giới hạn hiển thị danh sách (tối đa 20, thêm "...")
function buildListHtml(items) {
  const esc = s => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  const visible = items.slice(0, 20);
  const label =
    (translations && translations[currentLang] && translations[currentLang].popup_plate_label) ||
    (currentLang === 'en' ? 'Vehicle' : 'Xe');
  const listHtml = visible.map(p => `<div>${label} ${esc(p)}</div>`).join('');
  const more = items.length > 20 ? `<div class="text-muted">...</div>` : '';
  return listHtml + more;
}


// === HIGHLIGHT HÀNG TRONG DATATABLE (Xe mới / Xe trùng đơn vị khác) ===
window.__HL_NEW_SET = new Set();
window.__HL_DUP_SET = new Set();

function normalizePlate(s) {
  return String(s || '').toUpperCase().replace(/\s+/g, '').replace(/[^A-Z0-9\-\.]/g, '');
}

// Lấy danh sách DataTable đang dùng (preview khi upload và/hoặc bảng "Xe đã đăng ký")
function getActiveRegistrationTables() {
  const tables = [];
  if ($.fn.DataTable.isDataTable('#previewDataTable')) tables.push($('#previewDataTable').DataTable());
  if (typeof registeredVehicleTable !== 'undefined' && registeredVehicleTable) tables.push(registeredVehicleTable);
  return tables;
}

// Tìm chỉ số cột "Truck Plate" nếu không có object key
function findTruckPlateIndex(table) {
  // Ưu tiên dataSrc = 'Truck Plate'
  const settings = table.settings()[0];
  const idxByData = settings.aoColumns.findIndex(c => c && c.mData === 'Truck Plate');
  if (idxByData >= 0) return idxByData;

  // Fallback theo header text (tùy ngôn ngữ)
  const headers = $(table.columns().header()).map((i, th) => $(th).text().trim()).get();
  const candidates = ['Truck Plate', 'Biển số xe', 'Biển số', 'Plate'];
  for (let i = 0; i < headers.length; i++) {
    const h = headers[i];
    if (candidates.some(k => h.toLowerCase().includes(k.toLowerCase()))) return i;
  }
  return -1;
}

// Lấy biển số từ 1 row (object hoặc đọc từ cell)
function extractPlateFromRow(rowData, table, rowNode) {
  if (rowData && typeof rowData === 'object' && !Array.isArray(rowData)) {
    if (rowData['Truck Plate']) return rowData['Truck Plate'];
  }
  const idx = findTruckPlateIndex(table);
  if (idx >= 0) {
    return $(rowNode).find('td').eq(idx).text().trim();
  }
  return '';
}

function applyHighlightsToTable(table) {
  const newSet = window.__HL_NEW_SET;
  const dupSet = window.__HL_DUP_SET;

  table.rows({ page: 'current' }).every(function() {
    const $tr = $(this.node());
    // Bỏ highlight cũ để tránh tích tụ
    $tr.removeClass('hl-new-vehicle hl-dup-vehicle');

    const plate = normalizePlate(extractPlateFromRow(this.data(), table, this.node()));
    if (!plate) return;

    if (dupSet.has(plate)) {
      $tr.addClass('hl-dup-vehicle');    // ưu tiên hiện màu trùng đơn vị
    } else if (newSet.has(plate)) {
      $tr.addClass('hl-new-vehicle');
    }
  });
}

function applyHighlights() {
  getActiveRegistrationTables().forEach(applyHighlightsToTable);
}

// Gắn lại highlight mỗi khi redraw
function ensureHighlightHooks() {
  getActiveRegistrationTables().forEach(t => {
    if (!t.__hlHooked) {
      t.on('draw.dt', () => applyHighlightsToTable(t));
      t.__hlHooked = true;
    }
  });
}

// Public API: gọi sau khi biết danh sách xe mới
function highlightNewVehicles(plates) {
  (plates || []).forEach(p => window.__HL_NEW_SET.add(normalizePlate(p)));
  ensureHighlightHooks();
  applyHighlights();
}

// Public API: gọi sau khi biết danh sách xe trùng đơn vị khác
function highlightDuplicatedVehicles(plates) {
  (plates || []).forEach(p => window.__HL_DUP_SET.add(normalizePlate(p)));
  ensureHighlightHooks();
  applyHighlights();
}

//Hop dong
// ====================== CONTRACTS PAGE ======================
let contractTable;

function initContractPage() {
  const t = translations[currentLang] || {};
  // Quyền: admin thấy khung nhập + thao tác, user thì ẩn
  const isAdmin = isRole('admin');
  if (isAdmin) $('#contract-entry-card').removeClass('d-none');
  else $('#contract-entry-card').addClass('d-none');
  $('#ct-delete').toggleClass('d-none', !isAdmin);

  google.script.run
    .withSuccessHandler(list => {
      window.__ctCompanyList = list || [];
      const $sel = $('#ct-company').empty();
      window.__ctCompanyList.forEach(v => $sel.append(new Option(v, v)));
    })
    .withFailureHandler(showError)
    .getContractorOptions();

  // Form lưu (admin)
  $('#contractForm').off('submit').on('submit', function(e){
    e.preventDefault();
    if (!isAdmin) return;
    const payload = {
      'Contract No': $('#ct-contractNo').val().trim(),
      'Customer Name': $('#ct-customerName').val().trim(),														  
      'Transportation Company': $('#ct-company').val().trim(),
      'Status': $('#ct-status').val().trim()
    };
    showLoading(t.contract_loading_saving || 'Đang lưu...');
    google.script.run
      .withSuccessHandler(msg => {
        Swal.close();
        Swal.fire(t.success_title || 'Thành công', msg, 'success');
        contractTable.ajax.reload(null, false);
        this.reset();
      })
      .withFailureHandler(showError)
      .upsertContract(payload, userSession.token);
  });
// Nạp dropdown "Transportation Company" từ Users (admin mới thấy form)
    google.script.run
      .withSuccessHandler(list => {
        const $sel = $('#ct-company').empty();
        (list || []).forEach(v => $sel.append(new Option(v, v)));
      })
      .withFailureHandler(showError)
      .getContractorOptions();

// Status đã là dropdown cố định trong HTML (Active / Completed)

  buildContractTable(isAdmin);
  bindContractToolbar(isAdmin);
}

function buildContractTable(isAdmin) {
  const t = translations[currentLang];  
  if ($.fn.DataTable.isDataTable('#contractTable')) $('#contractTable').DataTable().destroy();

  const columns = [
    { data: null, title: 'Select', orderable:false, className:'no-export text-center', visible:isAdmin,
      render: () => `<input type="checkbox" class="row-checkbox form-check-input">` },
    { data: null, title: t.action_column || 'Hành động', orderable:false,
      className:'no-export text-center', visible:isAdmin,
      render: () => `<button class="btn btn-warning btn-sm ct-edit"><i class="fas fa-edit"></i></button>` },

    { data: 'ID', title: 'ID' },
    { data: 'Contract No', title: 'Contract No' },
    { data: 'Customer Name', title: 'Customer Name' },           // <-- THÊM
    { data: 'Transportation Company', title: 'Transportation Company' },
    { data: 'Status', title: 'Status' },
    { data: 'Created At', title: 'Created At' },
    { data: 'Created By', title: 'Created By' },    
  ];

  contractTable = $('#contractTable').DataTable({
    processing: true,
    serverSide: true,
    pageLength: 50,
    scrollX: true,
    ajax: function(dtReq, callback) {
      const params = {
        draw: dtReq.draw,
        start: dtReq.start,
        length: dtReq.length,
        search: dtReq.search,
        order: dtReq.order,
        sessionToken: userSession.token
      };
      google.script.run
        .withSuccessHandler(res => callback(res))
        .withFailureHandler(err => { showError(err); callback({draw:dtReq.draw,recordsTotal:0,recordsFiltered:0,data:[]}); })
        .getContractDataServerSide(params);
    },
    columns: columns
  });

  // search box
  $('#ct-search').off('keyup').on('keyup', function(){ contractTable.search(this.value).draw(); });

  // Click chọn dòng (checkbox) – tránh gắn trùng
  $('#contractTable tbody').off('change', '.row-checkbox').on('change', '.row-checkbox', function(){
    $(this).closest('tr').toggleClass('selected', this.checked);
  });

  // Edit (admin) – tránh gắn trùng + fix .then
  $('#contractTable tbody').off('click', '.ct-edit').on('click', '.ct-edit', function(){
    if (!isAdmin) return;
    const row = contractTable.row($(this).closest('tr')).data();
    if (!row) return;

    const companyOptions = (window.__ctCompanyList || []).map(v =>
      `<option value="${esc(v)}" ${v === (row['Transportation Company']||'') ? 'selected':''}>${esc(v)}</option>`
    ).join('');

    const statusList = ['Active','Completed'];
    const statusOptions = statusList.map(s =>
      `<option value="${s}" ${s === (row['Status']||'') ? 'selected':''}>${s}</option>`
    ).join('');

    Swal.fire({
      title: t.contract_edit_title || 'Sửa hợp đồng',
      html: `
        <div class="text-start">
          <div class="mb-2"><label class="form-label">ID</label>
            <input class="form-control form-control-sm" value="${esc(row['ID'])}" disabled>
          </div>
          <div class="mb-2"><label class="form-label">Contract No</label>
            <input id="sw-ct-no" class="form-control form-control-sm" value="${esc(row['Contract No']||'')}">
          </div>
          <div class="mb-2"><label class="form-label">Customer Name</label>
            <input id="sw-ct-cust" class="form-control form-control-sm" value="${esc(row['Customer Name']||'')}">
          </div>
         <div class="mb-2"><label class="form-label">Transportation Company</label>
            <select id="sw-ct-company" class="form-control form-control-sm">${companyOptions}</select>
          </div>
          <div class="mb-2"><label class="form-label">Status</label>
            <select id="sw-ct-status" class="form-control form-control-sm">${statusOptions}</select>
          </div>
        </div>
      `,
      focusConfirm: false,
      preConfirm: () => ({
        ID: row['ID'],
        'Contract No': $('#sw-ct-no').val().trim(),
        'Customer Name': $('#sw-ct-cust').val().trim(),
		'Transportation Company': $('#sw-ct-company').val(),
        'Status': $('#sw-ct-status').val()
      })
    }).then(res => {
      if (!res.isConfirmed) return;
      showLoading(t.contract_loading_updating || t.loading_updating || 'Đang cập nhật...');
      google.script.run
        .withSuccessHandler(msg => {
          Swal.close();
          Swal.fire(t.success_title || 'Thành công', msg, 'success');
          contractTable.ajax.reload(null, false);
        })
        .withFailureHandler(showError)
        .upsertContract(res.value, userSession.token);
    });
  });
}

function bindContractToolbar(isAdmin) {
  const t = translations[currentLang];  
  // Reload
  $('#ct-reload').off('click').on('click', function(e){ e.preventDefault(); contractTable.ajax.reload(); });

  // Delete (admin)
  $('#ct-delete').off('click').on('click', function(e){
    e.preventDefault();
    if (!isAdmin) return;

    const ids = [];
    contractTable.rows('.selected').every(function(){ const d=this.data(); if(d && d.ID) ids.push(d.ID); });

    if (!ids.length) {
      Swal.fire(
        t.contract_no_selection_title || 'Chưa chọn dòng',
        t.contract_no_selection_message || 'Hãy tick các dòng cần xoá.',
        'info'
      );
      return;
    }
    Swal.fire({icon:'warning', title: t.contract_confirm_delete_title || 'Xoá các mục đã chọn?', showCancelButton:true})
      .then(r => {
        if (!r.isConfirmed) return;
        showLoading(t.contract_loading_deleting || t.loading_deleting || 'Đang xoá...');
        google.script.run
          .withSuccessHandler(msg => {
            Swal.close();
            Swal.fire(t.success_title || 'Thành công', msg, 'success');
            contractTable.ajax.reload(null, false);
          })
          .withFailureHandler(showError)
          .deleteContracts(ids, userSession.token);
      });
  });

  // Export Excel (theo đúng thứ tự cột đang hiển thị & bỏ 2 cột Select/Action)
  $('#ct-export').off('click').on('click', function(e){
    e.preventDefault();
    const colDefs = contractTable.settings().init().columns; // our definition above
    const visibleIdx = contractTable.columns(':visible').indexes().toArray()
      .filter(i => !$(contractTable.column(i).header()).hasClass('no-export'));

    const headers = visibleIdx.map(i => $(contractTable.column(i).header()).text().trim());
    const data = contractTable.rows({search:'applied'}).data().toArray()
      .map(row => visibleIdx.map(i => {
        const key = colDefs[i].data; 
        return key ? (row[key] ?? '') : '';
      }));

    const aoa = [headers, ...data];
    const sheet = XLSX.utils.aoa_to_sheet(aoa);

    const range = XLSX.utils.decode_range(sheet['!ref'] || `A1:${XLSX.utils.encode_cell({ r: aoa.length - 1, c: headers.length - 1 })}`);
    const border = {
      top:    { style: 'thin', color: { rgb: 'FF000000' } },
      bottom: { style: 'thin', color: { rgb: 'FF000000' } },
      left:   { style: 'thin', color: { rgb: 'FF000000' } },
      right:  { style: 'thin', color: { rgb: 'FF000000' } }
    };

    for (let r = range.s.r; r <= range.e.r; r++) {
      for (let c = range.s.c; c <= range.e.c; c++) {
        const cellAddr = XLSX.utils.encode_cell({ r, c });
        if (!sheet[cellAddr]) {
          sheet[cellAddr] = { t: 's', v: '' };
        }
        sheet[cellAddr].s = sheet[cellAddr].s || {};
        sheet[cellAddr].s.border = border;
        if (r === range.s.r) {
          sheet[cellAddr].s.font = Object.assign({}, sheet[cellAddr].s.font, { bold: true });
        }
      }
    }

    const textify = val => {
      if (val == null) return '';
      if (typeof val === 'number') return val.toString();
      return String(val);
    };
    sheet['!cols'] = headers.map((header, idx) => {
      const maxLen = aoa.reduce((max, row) => {
        const cellText = textify(row[idx] ?? '');
        return Math.max(max, Array.from(cellText).length);
      }, 0);
      const padding = 2;
      const minWidth = 10;
      const maxWidth = 40;
      return { wch: Math.min(Math.max(maxLen + padding, minWidth), maxWidth) };
    });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, sheet, 'Contracts');
    XLSX.writeFile(wb, `Contracts_${new Date().toISOString().slice(0,10)}.xlsx`);
  });
}

function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

//nạp Số HĐ cho trang Đăng ký xe
function loadActiveContractNosForRegister() { 
  google.script.run
    .withSuccessHandler(arr => {
      // vẫn nạp datalist để fallback (không bắt buộc, nhưng giữ như cũ)
      const $dl = $('#contractNoList').empty();
      (arr || []).forEach(no => $dl.append(`<option value="${esc(no)}"></option>`));

      // ✅ khởi tạo combobox nhìn & dùng như select
      initComboBox('#manual-contractNo', arr || []);
    })
    .withFailureHandler(showError)
    .getActiveContractNos(userSession.token);
}


// ====== ComboBox nhẹ cho input (gõ + sổ danh sách) ======
function initComboBox(inputSel, options) {
  const $input = $(inputSel);
  if (!$input.length) return;
  const t = translations[currentLang];  

  // Bọc input
  if (!$input.parent().hasClass('combo-wrap')) {
    $input.wrap('<div class="combo-wrap"></div>');
    const ariaLabel = t.combo_open_list_label || 'Mở danh sách';
    $input.after(`<button type="button" class="combo-btn" aria-label="${ariaLabel}">▾</button><div class="combo-menu"></div>`);
  }
  const $wrap = $input.parent();
  const $btn  = $wrap.find('.combo-btn');
  const $menu = $wrap.find('.combo-menu');

  function render(list) {
    $menu.empty();
    list.forEach(v => $menu.append(`<div class="combo-item" data-val="${_.escape(v)}">${_.escape(v)}</div>`));
    $menu.toggle(list.length > 0);
  }

  function filterAndShow() {
    const q = $input.val().toLowerCase().trim();
    const list = (options || []).filter(v => String(v).toLowerCase().includes(q)).slice(0, 200);
    render(list);
  }

  // Sự kiện
  $input.on('input.combo', filterAndShow);
  $btn.off('click.combo').on('click.combo', function(){
    if ($menu.is(':visible')) { $menu.hide(); return; }
    $input.trigger('focus');
    render(options.slice(0, 200));
  });
  $menu.off('click.combo').on('click.combo', '.combo-item', function(){
    $input.val($(this).data('val'));
    $menu.hide();
    $input.trigger('change');
  });

  // điều hướng bàn phím
  $input.off('keydown.combo').on('keydown.combo', function(e){
    if (!$menu.is(':visible')) return;
    const $items = $menu.find('.combo-item');
    let idx = $items.index($items.filter('.active'));
    if (e.key === 'ArrowDown') { idx = Math.min(idx + 1, $items.length - 1); e.preventDefault(); }
    else if (e.key === 'ArrowUp') { idx = Math.max(idx - 1, 0); e.preventDefault(); }
    else if (e.key === 'Enter') { if (idx >= 0) { $items.eq(idx).click(); e.preventDefault(); } return; }
    else { return; }
    $items.removeClass('active'); if (idx >= 0) $items.eq(idx).addClass('active')[0].scrollIntoView({block:'nearest'});
  });

  // Ẩn khi click ngoài
  $(document).off('mousedown.combo').on('mousedown.combo', function(ev){
    if (!$.contains($wrap[0], ev.target)) $menu.hide();
  });

  // Lần đầu
  render([]); // ẩn
}

// Lodash escape tối giản (nếu bạn chưa có _)
if (typeof _ === 'undefined') {
  window._ = { escape: s => String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') };
}

try {
  if (translations && translations.vi)
    translations.vi['sidebar_xppl_approval'] = translations.vi['sidebar_xppl_approval'] || 'Xử lý xe đăng ký gửi XPPL';
  if (translations && translations.en)
    translations.en['sidebar_xppl_approval'] = translations.en['sidebar_xppl_approval'] || 'XPPL Registration Approval';
  if (translations && translations.vi)
    translations.vi['sidebar_xppl_weighing'] = translations.vi['sidebar_xppl_weighing'] || 'Trạm cân XPPL';
  if (translations && translations.en)
    translations.en['sidebar_xppl_weighing'] = translations.en['sidebar_xppl_weighing'] || 'XPPL Weighing Station';
  if (translations && translations.vi)
    translations.vi['sidebar_weighing_result'] = translations.vi['sidebar_weighing_result'] || 'Kết quả bốc hàng';
  if (translations && translations.en)
    translations.en['sidebar_weighing_result'] = translations.en['sidebar_weighing_result'] || 'Weighing Results';    
} catch (e) {}

const XPPL_WEIGHING_HEADERS = [
  'ID','No.','W.ID','Weighing Type','TicketID','Truck No','Date In','Time In','Date Out','Time Out',
  'Weight In','Weight Out','Net Weight','Product Name','CoalSource','ProductionCode','Customer Name',
  'DriverName','Id/Passport','CargoLotNo','CargoName','CargoCompany','PackUnit','PackQtt','OrderNo',
  'ContractNo','InvoiceNo','CoNo','OVS_DMT','Plant','Trailer No','Truck Country','Truck Type','WeighStationCode','Note',
  'CreateUser'
];
// Excel files from the weighing station do not include the leading ID column
const XPPL_FILE_HEADERS = XPPL_WEIGHING_HEADERS.slice(1);
let xpplWeighingTable;

function initXPPLWeighingStationPage() {
  $('#xppl-filter-date').val('');

  setupCustomFileInput('#xppl-weighing-file', {
    trigger: '#xpplWeighingFileTrigger',
    display: '#xpplWeighingFileDisplay',
    defaultKey: 'file_no_file_selected'
  });

  if ($.fn.DataTable.isDataTable('#xppl-weighing-table')) {
    $('#xppl-weighing-table').DataTable().destroy();
  }
  xpplWeighingTable = $('#xppl-weighing-table').DataTable({
    data: [],
    columns: XPPL_WEIGHING_HEADERS.map(h => ({
      data: h.includes('.') ? function(row){ return row[h]; } : h,
      title: h
    })),
    autoWidth: true,
    pageLength: 50,
    lengthChange: false,
    searching: true,
    paging: true,
    columnDefs: [{ targets: '_all', className: 'text-nowrap' }]
  });
  xpplWeighingTable.columns.adjust();

  xpplWeighingTable.on('draw.dt', function () {
    const count = xpplWeighingTable.rows({ search: 'applied' }).count();
    const t = (translations && translations[currentLang]) || translations.vi || {};
    const label = t.xppl_total_rows || 'Tổng số dòng';
    $('#xppl-count').html(label + ': <span class="badge bg-primary">' + count + '</span>');
  });

  $('#xppl-weighing-upload').off('click').on('click', handleXpplWeighingUpload);
  $('#xppl-filter-date, #xppl-filter-contract, #xppl-filter-customer')
    .off('change').on('change', loadXpplWeighingData);
  $('#xppl-search').off('keyup').on('keyup', function(){
    xpplWeighingTable.search(this.value).draw();
  });
  $('#xppl-page-length').off('change').on('change', function(){
    xpplWeighingTable.page.len($(this).val()).draw();
  });
  $('#xppl-refresh').off('click').on('click', loadXpplWeighingData);
  $('#xppl-export').off('click').on('click', exportXpplWeighingExcel);

  loadXpplWeighingData();
}

function handleXpplWeighingUpload() {
  const t = (translations && translations[currentLang]) || translations.vi || {};  
  const file = $('#xppl-weighing-file')[0].files[0];
  if (!file) {
    Swal.fire(t.no_file_selected_title || 'Chưa chọn file', t.xppl_no_file_excel_message || t.no_file_selected_message || 'Vui lòng chọn file Excel.', 'warning');
    return;
  }
  Swal.fire({
    title: t.xppl_upload_confirm_title || 'Xác nhận',
    text: t.xppl_upload_confirm_text || 'Bạn có chắc muốn tải lên?',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: t.xppl_upload_confirm_button || 'Xác nhận',
    cancelButtonText: t.xppl_upload_cancel_button || t.cancel_button || 'Hủy bỏ'
  }).then(res => {
    if (!res.isConfirmed) return;
    showLoadingDeferred(t.xppl_processing_file || 'Đang xử lý file...', 120);
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const workbook = XLSX.read(e.target.result, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'' });
        if (rows.length < 2) throw new Error(t.xppl_file_no_data || t.file_no_data_error || 'File không có dữ liệu');
        const headers = rows[0].map(h => String(h || '').trim());
        const expected = XPPL_FILE_HEADERS;
        if (headers.length !== expected.length || !headers.every((h,i) => h === expected[i])) {
          throw new Error(t.xppl_header_mismatch || 'Tiêu đề cột không khớp với mẫu yêu cầu.');
        }
        const data = rows.slice(1).map(r => {
          const obj = { ID: '' };
          XPPL_FILE_HEADERS.forEach((h, i) => obj[h] = r[i] || '');
          return obj;
        });
        google.script.run
          .withSuccessHandler(msg => {
            dismissLoading();
            Swal.fire(t.success_title || 'Thành công', msg || (t.xppl_upload_success_message || 'Tải lên thành công'), 'success');
            $('#xppl-weighing-file').val('');
            $('#xppl-weighing-file').val('').trigger('change');
            $('#xppl-filter-contract').val('');
            $('#xppl-filter-customer').val('');
            loadXpplWeighingData();
          })
          .withFailureHandler(err => { dismissLoading(true); showError(err); })
          .saveXpplWeighingData(data, userSession.token);
      } catch(err) {
        dismissLoading(true);
        Swal.fire({
          icon: 'warning',
          iconHtml: '⚠️',
          title: t.error_title || 'Lỗi',
          text: err.message || String(err),
          customClass: { icon: 'swal2-warning-emoji' }
        });
      }
    };
    reader.readAsArrayBuffer(file);
  });
}

function loadXpplWeighingData() {
  const t = (translations && translations[currentLang]) || translations.vi || {};  
  const dateVal = $('#xppl-filter-date').val();
  const contractVal = $('#xppl-filter-contract').val();
  const customerVal = $('#xppl-filter-customer').val();

  if (!dateVal) {
    $('#xppl-filter-contract').prop('disabled', true)
      .empty().append(`<option value="" data-translate="xppl_select_date_first">${t.xppl_select_date_first || 'Chọn ngày trước'}</option>`);
    $('#xppl-filter-customer').prop('disabled', true)
     .empty().append(`<option value="" data-translate="xppl_select_date_first">${t.xppl_select_date_first || 'Chọn ngày trước'}</option>`);
    if ($.fn.DataTable.isDataTable('#xppl-weighing-table')) {
      xpplWeighingTable.clear().draw();
    }
    $('#xppl-summary-trucks').text(0);
    $('#xppl-summary-weight').text(0);
    return;
  }

  const filter = {
    date: dateVal,
    contractNo: contractVal,
    customerName: customerVal
  };

  showLoadingDeferred(t.xppl_loading_data || 'Đang tải dữ liệu...', 120);
  callServerWithRetry('getXpplWeighingData', [filter, userSession.token], {
    attempts: 3,
    initialDelay: 700,
    onSuccess: res => {
      dismissLoading();
      if (!res) res = {};
      if (res.contracts) {
        const $c = $('#xppl-filter-contract').prop('disabled', false)
          .empty().append(`<option value="" data-translate="xppl_filter_all_option">${t.xppl_filter_all_option || 'Tất cả'}</option>`);
        res.contracts.forEach(c => $c.append(`<option value="${c}">${c}</option>`));
        if (filter.contractNo) $c.val(filter.contractNo);
      }
      if (res.customers) {
        const $c2 = $('#xppl-filter-customer').prop('disabled', false)
          .empty().append(`<option value="" data-translate="xppl_filter_all_option">${t.xppl_filter_all_option || 'Tất cả'}</option>`);
        res.customers.forEach(c => $c2.append(`<option value="${c}">${c}</option>`));
        if (filter.customerName) $c2.val(filter.customerName);
      }
      $('#xppl-summary-trucks').text(res.summary ? res.summary.trucks || 0 : 0);
      $('#xppl-summary-weight').text(res.summary ? (res.summary.weight || 0).toLocaleString('en-US') : 0);
      if ($.fn.DataTable.isDataTable('#xppl-weighing-table')) {
        xpplWeighingTable.clear().rows.add(res.data || []).draw();
        xpplWeighingTable.columns.adjust().draw();
      }
    },
    onFailure: err => {
      dismissLoading(true);
      showError(err);
    }
  });
}

function exportXpplWeighingExcel() {
  const t = (translations && translations[currentLang]) || translations.vi || {};  
  const rows = xpplWeighingTable.rows({ search: 'applied' }).data().toArray();
  if (!rows.length) {
    Swal.fire(t.no_data_title || 'Không có dữ liệu', t.xppl_no_data_export_message || t.no_data_export_message || 'Không có dữ liệu để xuất.', 'info');
    return;
  }
  const dateVal = $('#xppl-filter-date').val();
  const contractVal = $('#xppl-filter-contract').val();
  function formatExportDate(value) {
    if (!value) {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, '0');
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const yyyy = now.getFullYear();
      return `${dd}-${mm}-${yyyy}`;
    }
    const isoMatch = String(value).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (isoMatch) {
      return `${isoMatch[3]}-${isoMatch[2]}-${isoMatch[1]}`;
    }
    const vnMatch = String(value).match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (vnMatch) {
      return `${vnMatch[1]}-${vnMatch[2]}-${vnMatch[3]}`;
    }
    return String(value);
  }
  const formattedDate = formatExportDate(dateVal);
  const filePrefix = contractVal ? contractVal : 'All';  
  const aoa = [XPPL_WEIGHING_HEADERS];
  rows.forEach(r => {
    aoa.push(XPPL_WEIGHING_HEADERS.map(h => r[h] || ''));
  });
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  (function applyWorksheetStyling() {
    if (!ws['!ref']) return;
    const range = XLSX.utils.decode_range(ws['!ref']);
    const borderSide = { style: 'thin', color: { rgb: '000000' } };
    const headerRow = range.s.r;
    for (let R = range.s.r; R <= range.e.r; ++R) {
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const ref = XLSX.utils.encode_cell({ r: R, c: C });
        const cell = ws[ref];
        if (!cell) continue;
        cell.s = cell.s || {};
        cell.s.border = {
          top: borderSide,
          right: borderSide,
          bottom: borderSide,
          left: borderSide
        };
        if (R === headerRow) {
          cell.s.font = Object.assign({}, cell.s.font, { bold: true });
        }
      }
    }
    const colCount = aoa[0] ? aoa[0].length : 0;
    if (!colCount) return;
    const colWidths = [];
    for (let cIdx = 0; cIdx < colCount; ++cIdx) {
      let maxLen = 0;
      for (let rIdx = 0; rIdx < aoa.length; ++rIdx) {
        const value = aoa[rIdx][cIdx];
        const text = value == null ? '' : String(value);
        const parts = text.split(/\r?\n/);
        for (let p = 0; p < parts.length; ++p) {
          const len = parts[p].length;
          if (len > maxLen) maxLen = len;
        }
      }
      const width = Math.min(Math.max(maxLen + 2, 10), 60);
      colWidths.push({ wch: width });
    }
    ws['!cols'] = colWidths;
  })();  
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'XPPL');
  const fileName = `${filePrefix}_Weighing Report_${formattedDate}.xlsx`;
  XLSX.writeFile(wb, fileName);
}

// ===== XPPL Approval Page =====
let xpplDT;

function initXuLyXPPLPage() {
  // ===== 3.1. STATE & HELPER =====
  const $ddContract = $('#xppl-form-contract');
  const $ddCustomer = $('#xppl-form-customer');

  // map Contract No -> [Customer Name,...]
  let __cusMapByContract = {};
  // trạng thái export
  let xpplExportState = { confirmed: false, filter: null, rows: [] };

  // tổng hợp số liệu theo từng hợp đồng (tổng xe / đã duyệt)
  let contractSummary = {};
  let fullyApprovedContracts = new Set();
  const contractLabels = {};
  const contractRawValues = {};

  function normalizeContractValue(value) {
    if (value == null) return '';
    return String(value).trim();
  }

  function recordContractLabel(key, raw) {
    if (!key) return;
    const rawStr = raw == null ? '' : String(raw);
    const trimmed = rawStr.trim();
    if (trimmed) {
      contractLabels[key] = trimmed;
    } else if (!contractLabels[key]) {
      contractLabels[key] = key;
    }
    if (!contractRawValues[key]) {
      contractRawValues[key] = trimmed ? rawStr : key;
    }
  }

  function computeContractSummary(rows) {
    const summary = {};
    (rows || []).forEach(row => {
      const rawValue = row['Contract No'];
      const contractNo = normalizeContractValue(rawValue);
      if (!contractNo) return;
      recordContractLabel(contractNo, rawValue);
      const bucket = summary[contractNo] || { total: 0, approved: 0 };
      bucket.total += 1;
      if (String(row['Registration Status'] || '').toLowerCase() === 'approved') {
        bucket.approved += 1;
      }
      summary[contractNo] = bucket;
    });
    return summary;
  }

  function formatContractLabel(contractNo, stats, markApproved) {
    const total = stats && typeof stats.total === 'number' ? stats.total : 0;
    const baseLabel = `${contractNo} / ${total}`;
    return markApproved ? `${baseLabel} ✓` : baseLabel;
  }

  function isFullyApproved(contractNo, stats) {
    const key = normalizeContractValue(contractNo);
    if (stats && stats.total > 0) {
      return stats.approved === stats.total;
    }
    return fullyApprovedContracts.has(key);
  }

  function updateContractOptionLabels() {
    $('#xppl-contracts option').each(function () {
      const rawValue = this.value;
      const key = this.dataset.contractKey || normalizeContractValue(rawValue);
      if (!key) return;
      const stats = contractSummary[key];
      const approved = isFullyApproved(key, stats);
      const display = contractLabels[key] || normalizeContractValue(rawValue) || rawValue;
      this.textContent = formatContractLabel(display, stats, approved);
      this.classList.toggle('approved', !!approved);
      const totalVal = stats && typeof stats.total === 'number' ? stats.total : 0;
      const approvedVal = stats && typeof stats.approved === 'number' ? stats.approved : 0;
      this.dataset.total = totalVal;
      this.dataset.approved = approvedVal;
      this.dataset.contractKey = key;
    });
  }  

  function toggleExportButtons(on){
    $('#xppl-form-preview').prop('disabled', !on);
    $('#xppl-form-export').prop('disabled', !on);
  }
  function resetExportFormPlaceholders() {
    $ddContract.empty().append('<option value="">— Không có hợp đồng trong ngày —</option>');
    $ddCustomer.empty().append('<option value="">— Không có khách hàng —</option>');
    toggleExportButtons(false);
    xpplExportState = { confirmed:false, filter:null, rows:[] };
  }
  // Luôn trả dd/MM/yyyy từ #xppl-date dù input hiển thị dạng gì
  function getDateVN() {
    const $input = $('#xppl-date');
    const fallbackDate = getVietnamNowClient();

    if (!$input.length) {
      if (lastXpplDateString) {
        return lastXpplDateString;
      }
      const fallbackString = getFormattedDate(fallbackDate);
      lastXpplDateString = fallbackString;
      return fallbackString;
    }

    let raw = ($input.val() || '').trim();
    if (!raw) {
      const isoFallback = getVietnamIsoDate(fallbackDate);
      if (isoFallback) {
        $input.val(isoFallback);
        raw = isoFallback;
      }
    }

    let parsed = parseDateValue(raw);
    if (!parsed || isNaN(parsed)) {
      parsed = fallbackDate instanceof Date && !isNaN(fallbackDate) ? fallbackDate : null;
      if (parsed) {
        const iso = getVietnamIsoDate(parsed);
        if (iso) {
          $input.val(iso);
        }
      }
    }

    if (!parsed || isNaN(parsed)) {
      return lastXpplDateString || '';
    }

    const formatted = getFormattedDate(parsed);
    if (formatted) {
      lastXpplDateString = formatted;
      return formatted;
    }

    return lastXpplDateString || ''; 
  }

  ensureVietnamTime();
  // set ngày mặc định hôm nay (ISO yyyy-mm-dd) cho input type=date
  const todayISO = getVietnamIsoDate(getVietnamNowClient());
  $('#xppl-date').val(todayISO);

  // ===== 3.2. NẠP OPTIONS CONTRACT/CUSTOMER THEO NGÀY =====
  function loadExportOptionsForDate() {
    resetExportFormPlaceholders();
    const dateVN = getDateVN(); // dd/MM/yyyy
    if (!dateVN) {
      Swal.fire('Thiếu ngày đăng ký', 'Vui lòng chọn ngày đăng ký trước khi tải danh sách hợp đồng.', 'info');
      return;
    }

    showLoading('Đang tải danh sách hợp đồng…');
    google.script.run
      .withSuccessHandler(res => {
        Swal.close();
        const contracts = (res && res.contracts) || [];
        __cusMapByContract = (res && res.customersByContract) || {};

        if (!contracts.length) return;

        // đổ Contract No
        const frag = document.createDocumentFragment();
        contracts.forEach(no => {
          const opt = document.createElement('option');
          opt.value = no;
          opt.textContent = no;
          frag.appendChild(opt);
        });
        $ddContract.empty()[0].appendChild(frag);

        // hiển thị Customer theo contract đầu tiên
        const first = $ddContract.val();
        const list = __cusMapByContract[first] || [];
        $ddCustomer.empty();
        if (list.length) {
          const f2 = document.createDocumentFragment();
          list.forEach(cus => {
            const opt = document.createElement('option');
            opt.value = cus;
            opt.textContent = cus;
            f2.appendChild(opt);
          });
          $ddCustomer[0].appendChild(f2);
        } else {
          $ddCustomer.append('<option value="">— Không có khách hàng —</option>');
        }

        // reset state export
        toggleExportButtons(false);
        xpplExportState = { confirmed:false, filter:null, rows:[] };
      })
      .withFailureHandler(err => { Swal.close(); showError(err); })
      // ✅ quan trọng: TRUYỀN OBJECT { dateString }
      .getXpplExportOptions({ dateString: dateVN }, userSession.token);
  }

  // Khi đổi Contract No → nạp Customer Name đúng map
  $ddContract.off('change.xppl-contract').on('change.xppl-contract', function () {
    const no = $(this).val();
    const list = __cusMapByContract[no] || [];
    $ddCustomer.empty();
    if (list.length) {
      const frag = document.createDocumentFragment();
      list.forEach(cus => {
        const opt = document.createElement('option');
        opt.value = cus;
        opt.textContent = cus;
        frag.appendChild(opt);
      });
      $ddCustomer[0].appendChild(frag);
    } else {
      $ddCustomer.append('<option value="">— Không có khách hàng —</option>');
    }
    toggleExportButtons(false);
    xpplExportState = { confirmed:false, filter:null, rows:[] };
  });

  // đổi ngày / bấm “Hiển thị/Cập nhật” → nạp lại dropdown
  $('#xppl-date').off('change.xpplopt').on('change.xpplopt', loadExportOptionsForDate);
  $('#xppl-refresh').off('click.xpplopt').on('click.xpplopt', function(e){
    e.preventDefault(); loadExportOptionsForDate();
  });
  // nạp lần đầu
  loadExportOptionsForDate();

  // ===== 3.3. Nút "Xác nhận" — khoá điều kiện & kiểm tra Approved =====
  $('#xppl-form-confirm').off('click.xppl').on('click.xppl', function(){
    const filter = {
      dateString:   getDateVN(),
      contractNo:   $ddContract.val() || '',
      customerName: $ddCustomer.val() || ''
    };

    const missing = [];
    if (!filter.dateString)   missing.push('Register Date');
    if (!filter.contractNo)   missing.push('Contract No');
    if (!filter.customerName) missing.push('Customer Name');
    if (missing.length){
      Swal.fire('Thiếu điều kiện', 'Vui lòng chọn: ' + missing.join(', '), 'warning');
      return;
    }

    showLoading('Đang kiểm tra điều kiện (Approved)…');
    google.script.run
      .withSuccessHandler(function(res){
        Swal.close();
        if (!res || !res.ok){
          const msg = (res && res.errors && res.errors.length) ? res.errors.join('<br>') : 'Không đủ điều kiện để xuất.';
          Swal.fire('Không đạt', msg, 'error');
          xpplExportState = { confirmed:false, filter:null, rows:[] };
          toggleExportButtons(false);
          return;
        }
        xpplExportState = { confirmed:true, filter:res.filter, rows:res.rows || [] };
        toggleExportButtons(true);
        Swal.fire('OK', `Đã khoá điều kiện. Số dòng Approved: <b>${res.total}</b>.`, 'success');
      })
      .withFailureHandler(err => { Swal.close(); showError(err); })
      .getXpplExportData(filter, userSession.token);
  });

  // ===== 3.4. Nút "Kiểm tra" — preview A9:J =====
  $('#xppl-form-preview').off('click.xppl').on('click.xppl', function(){
  if (!xpplExportState || !xpplExportState.confirmed) {
    Swal.fire('Chưa xác nhận', 'Vui lòng bấm “Xác nhận” trước.', 'info'); return;
  }
  const rows = xpplExportState.rows || [];
  if (!rows.length){ Swal.fire('Trống', 'Không có dữ liệu để xem.', 'info'); return; }

  const { dateString, contractNo, customerName } = xpplExportState.filter;

  const thead = `
    <tr>
      <th>No</th>
      <th>Truck plate</th>
      <th>Country</th>
      <th>Wheel</th>
      <th>Trailer plate</th>
      <th>Driver name</th>
      <th>ID/Passport</th>
      <th>Phone number</th>
      <th>Transportation Company</th>
      <th>Subcontractor</th>
    </tr>`;
  let tbody = '';
  rows.forEach((r,i)=>{ tbody += `
    <tr>
      <td>${i+1}</td>
      <td>${r['Truck Plate']||''}</td>
      <td>${r['Country']||''}</td>
      <td>${r['Wheel']||''}</td>
      <td>${r['Trailer Plate']||''}</td>
      <td>${r['Driver Name']||''}</td>
      <td>${r['ID/Passport']||''}</td>
      <td>${r['Phone number']||''}</td>
      <td>${r['Transportation Company']||''}</td>
      <td>${r['Subcontractor']||''}</td>
    </tr>`; });

  Swal.fire({
    width: '90%',
    title: 'Xem trước Truck list',
    html: `
      <div class="text-start mb-2">
        <b>Date:</b> ${dateString} &nbsp;&nbsp; <b>Contract:</b> ${contractNo}
        &nbsp;&nbsp; <b>Customer:</b> ${customerName} &nbsp;&nbsp; <b>Total truck:</b> ${rows.length}
      </div>
      <div class="table-responsive" style="max-height:60vh;overflow:auto">
        <table class="table table-bordered table-sm">
          <thead>${thead}</thead>
          <tbody>${tbody}</tbody>
        </table>
      </div>`,
    confirmButtonText: 'Đóng'
  });
});



// ===== 3.5. Nút "Xuất Excel" — xuất theo Google Sheet mẫu (template) =====
$('#xppl-form-export').off('click.xppl').on('click.xppl', function () {
  if (!xpplExportState.confirmed) {
    Swal.fire('Chưa xác nhận', 'Vui lòng bấm “Xác nhận” trước.', 'info');
    return;
  }
  const filter = xpplExportState.filter;

  showLoading('Đang tạo file…');
  google.script.run
    .withSuccessHandler(function (res) {
      Swal.close();
      if (!res || !res.ok) {
        Swal.fire('Không thể xuất', (res && res.message) || 'Lỗi không xác định.', 'error');
        return;
      }

      // Đặt tên file tải về (ưu tiên server trả về fileName)
      var filename = (res.fileName || res.name || ('XPPL_' + (filter.contractNo || '') + '_' + (filter.dateString || '') + '.xlsx'))
        .replace(/[\\\/:\*\?"<>\|]/g, '_'); // sanitize ký tự cấm

      // Tải về từ base64
      var a = document.createElement('a');
      a.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + res.base64;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    })
    .withFailureHandler(function (err) {
      Swal.close();
      showError(err && err.message ? err.message : err);
    })
    .exportXpplAsXlsx(filter, userSession.token);
});



  // ====== Admin guard & DataTable ======
  if (!userSession || !isRole('admin')) {
    $('#main-content').html('<div class="alert alert-warning">Bạn không có quyền truy cập trang này.</div>');
    return;
  }

  if ($.fn.DataTable.isDataTable('#xppl-table')) $('#xppl-table').DataTable().destroy();
  xpplDT = $('#xppl-table').DataTable({
    paging:true, pageLength:50, lengthChange:false, searching:true, ordering:true,
    autoWidth:false, deferRender:true, scrollX:true, serverSide:false,
    processing:true, searchDelay:300, orderMulti:false,
    columns: [
      { title: 'Select', data: null, orderable:false, className:'text-center no-export',
        render: ()=>'<input type="checkbox" class="row-checkbox form-check-input">' },
      { title: 'Hành động', data: null, orderable:false, className:'text-center no-export',
        render: ()=>'<button class="btn btn-warning btn-sm xppl-edit"><i class="fas fa-edit"></i></button>' },
      { title: 'ID', data: 'ID' },
      { title: 'Register Date', data: 'Register Date',
        render: v => {
          if (!v) return '';
          const s = String(v);
          if (/^\d{4}-\d{2}-\d{2}T/.test(s)) {
            const d = new Date(s); if (!isNaN(d)) {
              const dd=('0'+d.getDate()).slice(-2), mm=('0'+(d.getMonth()+1)).slice(-2), yy=d.getFullYear();
              return `${dd}/${mm}/${yy}`;
            }
          }
          return s;
        }
      },
      { title: 'Contract No', data: 'Contract No' },
      { title: 'Truck Plate', data: 'Truck Plate' },
      { title: 'Trailer Plate', data: 'Trailer Plate' },
      { title: 'Transportation Company', data: 'Transportation Company' },
      { title: 'Registration Status', data: 'Registration Status',
        render: v => {
          const t=(v||'');
          const cls = t==='Approved' ? 'text-danger fw-bold' : 'text-primary fw-bold';
          return `<span class="${cls}">${t}</span>`;
        }}
    ]
  });

  // ===== Realtime counters from table =====
  function updateXpplCountersFromTable() {
    const dt = $('#xppl-table').DataTable();
    const data = dt.rows({ search: 'applied' }).data().toArray();
    let p=0,a=0,s=0;
    data.forEach(r=>{
      const st = String(r['Registration Status']||'').toLowerCase();
      if (st==='approved') a++; else if (st==='pending approval') p++;
      const sx = r['Sent XPPL']||r['XPPL Sent']||r['Sent to XPPL'];
      if (sx===true || String(sx).toLowerCase()==='yes' || String(sx).toLowerCase()==='sent' || sx===1) s++;
    });
    $('#xppl-pending').text(p);
    $('#xppl-approved').text(a);
    $('#xppl-sent').text(s);
  }
  $('#xppl-table').off('draw.dt search.dt').on('draw.dt search.dt', updateXpplCountersFromTable);

  // ===== Snapshot + Table data =====
  function updateSelectAllStyles(){
    const sel = document.getElementById('xppl-contracts');
    if (!sel) return;
    const all = sel.options.length>0 && sel.selectedOptions.length===sel.options.length;
    $('#btn-select-all-contracts').toggleClass('btn-primary', all).toggleClass('btn-outline-secondary', !all);
  }
  function fillContracts(contracts, fullyApproved) {
    const $sel = $('#xppl-contracts');
    const selEl = $sel[0];
    if (!selEl) return;

    const prevSelected = new Set(Array.from(selEl.selectedOptions || []).map(opt => opt.value));
    const seen = new Set();
    const list = Array.isArray(contracts) && contracts.length
      ? contracts
      : Object.keys(contractSummary).map(key => contractRawValues[key] || key);

    fullyApprovedContracts = new Set((fullyApproved || []).map(normalizeContractValue));

    selEl.innerHTML = '';
    const frag = document.createDocumentFragment();

    (list || []).forEach(rawValue => {
      const key = normalizeContractValue(rawValue);
      if (!key || seen.has(key)) return;
      seen.add(key);
      recordContractLabel(key, rawValue);
      const stats = contractSummary[key];
      if (stats) {
        const statsApproved = stats.total > 0 && stats.approved === stats.total;
        if (statsApproved) fullyApprovedContracts.add(key);
        else fullyApprovedContracts.delete(key);
      }
      const approved = isFullyApproved(key, stats);
      const opt = document.createElement('option');
      const rawString = rawValue == null ? key : String(rawValue);
      opt.value = rawString;
      const display = contractLabels[key] || key;
      opt.textContent = formatContractLabel(display, stats, approved);
      if (approved) opt.classList.add('approved');
      const totalVal = stats && typeof stats.total === 'number' ? stats.total : 0;
      const approvedVal = stats && typeof stats.approved === 'number' ? stats.approved : 0;
      opt.dataset.total = totalVal;
      opt.dataset.approved = approvedVal;
      opt.dataset.contractKey = key;
      if (prevSelected.has(opt.value)) {
        opt.selected = true;
      }
      frag.appendChild(opt);
    });

    selEl.appendChild(frag);
    updateSelectAllStyles();
  }
  function renderRows(rows) {
    xpplDT.clear().rows.add(rows || []).draw();
    let p = 0, a = 0, s = 0;
    (rows || []).forEach(r=>{
      const st = String(r['Registration Status']||'').toLowerCase();
      if (st==='approved') a++;
      else if (st==='pending approval') p++;
      const sx = r['Sent XPPL']||r['XPPL Sent']||r['Sent to XPPL'];
      if (sx===true || String(sx).toLowerCase()==='yes' || String(sx).toLowerCase()==='sent' || sx===1) s++;
    });
    $('#xppl-pending').text(p);
    $('#xppl-approved').text(a);
    $('#xppl-sent').text(s);
  }
  function refreshSnapshot() {
    const d = getDateVN();
    if (!d) {
      Swal.fire('Thiếu ngày đăng ký', 'Vui lòng chọn ngày đăng ký trước khi tải dữ liệu.', 'info');
      return;
    }
    showLoading('Đang tải dữ liệu…');
    google.script.run
      .withSuccessHandler(res=>{
        Swal.close();
        $('#xppl-pending').text(res.pending||0);
        $('#xppl-approved').text(res.approved||0);
        $('#xppl-sent').text(res.sent||0);
        contractSummary = computeContractSummary(res.rows || []);
        Object.keys(contractSummary).forEach(key => {
          recordContractLabel(key, contractRawValues[key]);
        });
        (Array.isArray(res.contracts) ? res.contracts : []).forEach(no => {
          recordContractLabel(normalizeContractValue(no), no);
        });
        const contractList = (Array.isArray(res.contracts) && res.contracts.length)
          ? res.contracts
          : Object.keys(contractSummary).map(key => contractRawValues[key] || key);
        fillContracts(contractList, res.fullyApproved||[]);
        updateContractOptionLabels();
        refreshTable(); // sau khi có hợp đồng -> tải bảng theo lựa chọn hiện tại
      })
      .withFailureHandler(err=>{ Swal.close(); showError(err); })
      .getXpplSnapshot({dateString:d}, userSession.token);
  }
  function refreshTable() {
    const d = getDateVN();
    if (!d) {
      Swal.fire('Thiếu ngày đăng ký', 'Vui lòng chọn ngày đăng ký trước khi tải dữ liệu.', 'info');
      return;
    }
    const selected = $('#xppl-contracts').val() || [];
    google.script.run
      .withSuccessHandler(res=>{
        renderRows(res.rows||[]);
        if (typeof res.pending === 'number')  $('#xppl-pending').text(res.pending);
        if (typeof res.approved === 'number') $('#xppl-approved').text(res.approved);
        if (typeof res.sent === 'number')     $('#xppl-sent').text(res.sent);
        const per = computeContractSummary(res.rows || []);
        Object.keys(per).forEach(contractNo => {
          const stats = per[contractNo];
          contractSummary[contractNo] = stats;
          recordContractLabel(contractNo, contractRawValues[contractNo]);
          if (stats.total > 0 && stats.approved === stats.total) {
            fullyApprovedContracts.add(contractNo);
          } else {
            fullyApprovedContracts.delete(contractNo);
          }
        });
        // đảm bảo các hợp đồng mới xuất hiện trong bảng cũng có trong danh sách chọn
        const currentOptions = new Set(Array.from($('#xppl-contracts option')).map(opt => opt.dataset.contractKey || normalizeContractValue(opt.value)));
        const missingContracts = Object.keys(per).filter(key => key && !currentOptions.has(key));
        if (missingContracts.length) {
          const additions = missingContracts.map(key => contractRawValues[key] || key);
          const currentValues = Array.from($('#xppl-contracts option')).map(opt => opt.value);
          fillContracts([...currentValues, ...additions], Array.from(fullyApprovedContracts));
        }
        updateContractOptionLabels();        
      })
      .withFailureHandler(showError)
      .getRegistrationsForApproval({dateString:d, contracts:selected}, userSession.token);
  }

  // events snapshot/table
  $('#xppl-date').off('change').on('change', refreshSnapshot);

  // ⚠️ Sửa để KHÔNG xoá handler loadExportOptionsForDate ở trên:
  $('#xppl-refresh').off('click.xppl-table').on('click.xppl-table', function(e){
    e.preventDefault(); refreshTable();
  });

  $('#btn-select-all-contracts').off('click').on('click', function(e){ e.preventDefault(); $('#xppl-contracts option').prop('selected', true); $('#xppl-contracts').trigger('change'); updateSelectAllStyles(); });
  $('#btn-clear-contracts').off('click').on('click', function(e){ e.preventDefault(); $('#xppl-contracts').val([]).trigger('change'); updateSelectAllStyles(); });
  $('#xppl-contracts').off('change').on('change', updateSelectAllStyles);

  $('#xppl-apply').off('click').on('click', function(e){
    e.preventDefault();
    const d = getDateVN();
    const selected = $('#xppl-contracts').val() || [];
    if (!selected.length) { Swal.fire('Thiếu lựa chọn','Vui lòng chọn ít nhất 1 hợp đồng.','info'); return; }
    const newStatus = $('input[name="xppl-status"]:checked').val();
    showLoading('Đang cập nhật…');
    google.script.run
      .withSuccessHandler(msg=>{ Swal.fire('Thành công', msg || 'Đã cập nhật.', 'success'); refreshSnapshot(); })
      .withFailureHandler(err=>{ Swal.close(); showError(err); })
      .updateRegistrationStatusBulk({dateString:d, contracts:selected}, newStatus, userSession.token);
  });

  // inline edit
  $('#xppl-table').off('click','.xppl-edit').on('click','.xppl-edit', function(){
    const row = xpplDT.row($(this).closest('tr')).data(); if(!row) return;
    Swal.fire({
      title:'Cập nhật trạng thái',
      html:`<div class="text-start">
        <div class="mb-2"><b>Contract No:</b> ${row['Contract No']}</div>
        <div class="mb-2"><b>Truck Plate:</b> ${row['Truck Plate']}</div>
        <label class="form-label">Registration Status</label>
        <select id="sw-xppl-status" class="form-select">
          <option value="Approved" ${row['Registration Status']==='Approved'?'selected':''}>Approved</option>
          <option value="Pending approval" ${row['Registration Status']==='Pending approval'?'selected':''}>Pending approval</option>
        </select>
      </div>`
      ,
      showCancelButton:true, confirmButtonText:'Lưu', cancelButtonText:'Huỷ'
    }).then(res=>{
      if(!res.isConfirmed) return;
      const newStatus = $('#sw-xppl-status').val();
      const d = getDateVN();
      google.script.run
        .withSuccessHandler(msg=>{ Swal.fire('Thành công', msg || 'Đã cập nhật.', 'success'); refreshSnapshot(); })
        .withFailureHandler(showError)
        .updateRegistrationStatusBulk({dateString:d, contracts:[row['Contract No']], idsSelected:[row['ID']]}, newStatus, userSession.token);
    });
  });

  // load lần đầu bảng + counters
  refreshSnapshot();
}

// ====================== WEIGHING RESULT PAGE ======================
const WR_DELETE_BATCH_SIZE = 25;

function chunkWrIds(ids, size) {
  const chunkSize = Number(size) || 0;
  if (!Array.isArray(ids) || !ids.length || chunkSize <= 0) {
    return Array.isArray(ids) && ids.length ? [ids.slice()] : [];
  }
  const chunks = [];
  for (let i = 0; i < ids.length; i += chunkSize) {
    chunks.push(ids.slice(i, i + chunkSize));
  }
  return chunks;
}

function initWeighResultPage() {
  const role = getUserRole();
  const isAdmin = role === 'admin';
  const isAdminXppl = role === 'admin-xppl';

  $('#wr-unknown-btn').toggleClass('d-none', !isAdmin);
  $('#wr-delete').toggleClass('d-none', !isAdmin);
  $('#wr-unknown-delete').toggleClass('d-none', !isAdmin);
  $('#wr-match-company').toggleClass('d-none', !isAdmin);
  $('#wr-delete, #wr-unknown-delete').prop('disabled', true).addClass('disabled');  
  const hasActions = $('#wr-actions').find('button:not(.d-none)').length > 0;
  $('#wr-actions').toggleClass('d-none', !hasActions);

  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  $('#wr-date-from').val(formatDateInput(yesterday));
  $('#wr-date-to').val(formatDateInput(yesterday));
  $('#wr-adv-toggle')
    .attr('aria-expanded', 'false')
    .attr('data-translate', 'wr_adv_toggle_show')
    .text((translations[currentLang] && translations[currentLang].wr_adv_toggle_show) || 'Bộ lọc nâng cao');
  $('#wr-contracts, #wr-customers').prop('disabled', true).empty();

  google.script.run
    .withSuccessHandler(list => {
      window.__wrCompanyList = list || [];
    })
    .withFailureHandler(showError)
    .getContractorOptions();

  buildWeighResultTables(isAdmin);

  if (isAdmin) {
    $('#wr-unknown-btn').off('click').on('click', function(){
      const modalEl = document.getElementById('wr-unknown-modal');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
      if ($.fn.DataTable.isDataTable('#wr-unknown-table')) {
        wrUnknownTable.columns.adjust();
      }
    });
  }  

  $('#wr-adv-toggle').off('click').on('click', function(e){
    e.preventDefault();
    const $adv = $('#wr-advanced');
    const isHidden = $adv.toggleClass('d-none').hasClass('d-none');
    const t = translations[currentLang] || translations.vi || {};
    const key = isHidden ? 'wr_adv_toggle_show' : 'wr_adv_toggle_hide';
    $(this)
      .attr('data-translate', key)
      .text(t[key] || (isHidden ? 'Bộ lọc nâng cao' : 'Ẩn bộ lọc nâng cao'));
    $(this).attr('aria-expanded', String(!isHidden));
  });

  $('#wr-match-company').off('click').on('click', function(e){
    e.preventDefault();
    const t = translations[currentLang] || translations.vi || {};
    showLoading(t.wr_matching_loading || 'Đang đối chiếu...');
    const filter = getWrFilters();
    google.script.run
      .withSuccessHandler(msg => {
        Swal.close();
        const t2 = translations[currentLang] || translations.vi || {};
        Swal.fire(t2.success_title || 'Thành công', msg, 'success');
        reloadWrTables();
      })
      .withFailureHandler(showError)
      .matchTransportationCompanies(filter, userSession.token);
  });

  $('#wr-search').off('keyup').on('keyup', function(){
    const val = this.value;
    if ($.fn.DataTable.isDataTable('#wr-result-table')) wrResultTable.search(val).draw();
    if (isAdmin && $.fn.DataTable.isDataTable('#wr-unknown-table')) wrUnknownTable.search(val).draw();
  });

  $('#wr-date-from, #wr-date-to, #wr-contracts, #wr-customers').off('change').on('change', reloadWrTables);

  $('#wr-reload').off('click').on('click', function(e){ e.preventDefault(); wrResultTable.ajax.reload(); });
  if (isAdmin) $('#wr-unknown-reload').off('click').on('click', function(e){ e.preventDefault(); wrUnknownTable.ajax.reload(); });

  if (isAdmin) {
    $('#wr-delete').off('click').on('click', function(e){ e.preventDefault(); deleteWrRows(wrResultTable); });
    $('#wr-unknown-delete').off('click').on('click', function(e){ e.preventDefault(); deleteWrRows(wrUnknownTable); });
  }

  $('#wr-export').off('click').on('click', function(e){ e.preventDefault(); exportWrTable(wrResultTable, 'WeighResults'); });
  if (isAdmin) $('#wr-unknown-export').off('click').on('click', function(e){ e.preventDefault(); exportWrTable(wrUnknownTable, 'UnknownVehicles'); });
}

function formatTimeForDisplay(value) {
  if (value == null || value === '') return '';

  if (value instanceof Date && !isNaN(value)) {
    return value.toTimeString().slice(0, 8);
  }

  if (typeof value === 'number' && Number.isFinite(value)) {
    const fraction = ((value % 1) + 1) % 1;
    const totalSeconds = Math.round(fraction * 86400);
    const seconds = ((totalSeconds % 86400) + 86400) % 86400;
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return [hours, minutes, secs].map(v => String(v).padStart(2, '0')).join(':');
  }

  const str = String(value).trim();
  if (!str) return '';

  const isoMatch = str.match(/T(\d{2}:\d{2}:\d{2})/);
  if (isoMatch) return isoMatch[1];

  const ampmMatch = str.match(/(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)$/i);
  if (ampmMatch) {
    let hours = parseInt(ampmMatch[1], 10);
    const minutes = parseInt(ampmMatch[2] ?? '0', 10);
    const seconds = parseInt(ampmMatch[3] ?? '0', 10);
    const meridiem = ampmMatch[4].toUpperCase();
    hours = hours % 12 + (meridiem === 'PM' ? 12 : 0);
    return [hours, minutes, seconds].map(v => String(v).padStart(2, '0')).join(':');
  }

  const timeMatch = str.match(/(\d{1,2}):(\d{2}):(\d{2})/);
  if (timeMatch) {
    const hours = parseInt(timeMatch[1], 10);
    const minutes = parseInt(timeMatch[2], 10);
    const seconds = parseInt(timeMatch[3], 10);
    return [hours, minutes, seconds].map(v => String(v).padStart(2, '0')).join(':');
  }

  return str;
}

function formatDateInput(d){ return d.toISOString().slice(0,10); }

function parseMultiValueInput(value) {
  if (value == null) return [];
  const arr = Array.isArray(value)
    ? value
    : String(value).split(/[\r\n;|]+/);
  return arr
    .map(v => String(v == null ? '' : v).trim())
    .filter(Boolean);
}

function uniqueCasePreserveOrder(list) {
  const seen = new Set();
  const out = [];
  (Array.isArray(list) ? list : []).forEach(val => {
    const str = String(val == null ? '' : val).trim();
    if (!str) return;
    const key = str.toLowerCase();
    if (seen.has(key)) return;
    seen.add(key);
    out.push(str);
  });
  return out;
}

function getWrAllowedCustomers() {
  if (!userSession || !isRole('user')) return [];
  const raw = userSession.customerName || userSession.customerNames || '';
  const parsed = parseMultiValueInput(raw);
  return uniqueCasePreserveOrder(parsed);
}

function sanitizeWrCustomerSelection(values) {
  const allowed = getWrAllowedCustomers();
  const selected = uniqueCasePreserveOrder(parseMultiValueInput(values));
  if (!allowed.length) return selected;
  const allowedSet = new Set(allowed.map(name => name.toLowerCase()));
  const filtered = selected.filter(name => allowedSet.has(name.toLowerCase()));
  return filtered.length ? filtered : allowed.slice();
}

function arraysEqualIgnoreCase(a, b) {
  if (!Array.isArray(a) || !Array.isArray(b)) return false;
  if (a.length !== b.length) return false;
  for (let i = 0; i < a.length; i++) {
    if ((a[i] || '').toLowerCase() !== (b[i] || '').toLowerCase()) return false;
  }
  return true;
}

function syncWrCustomerSelection(selected) {
  if (!Array.isArray(selected)) return;
  const $sel = $('#wr-customers');
  if (!$sel.length) return;
  const current = parseMultiValueInput($sel.val());
  if (!arraysEqualIgnoreCase(current, selected)) {
    $sel.val(selected);
  }
}

function getWrFilters(){
  const filter = {
    dateFrom: $('#wr-date-from').val(),
    dateTo: $('#wr-date-to').val(),
    contracts: uniqueCasePreserveOrder($('#wr-contracts').val() || []),
    customers: uniqueCasePreserveOrder($('#wr-customers').val() || [])
  };

  if (isRole('user')) {
    const sanitized = sanitizeWrCustomerSelection(filter.customers);
    if (sanitized.length) {
      filter.customers = sanitized;
      syncWrCustomerSelection(sanitized);
    } else {
      const allowed = getWrAllowedCustomers();
      if (allowed.length) {
        filter.customers = allowed.slice();
        syncWrCustomerSelection(allowed);
      } else {
        filter.customers = [];
        syncWrCustomerSelection([]);
      }
    }
  }

  return filter;  
}

function updateWrSummary(counts, overview){
  const formatNumber = value => {
    if (value == null) return '0';
    const cleaned = typeof value === 'string' ? value.replace(/,/g, '') : value;
    const num = typeof cleaned === 'number' ? cleaned : Number(cleaned);
    return Number.isFinite(num) ? num.toLocaleString('en-US') : '0';
  };

  $('#wr-sum-unassign').text(formatNumber(counts?.unassigned));
  $('#wr-sum-unknown').text(formatNumber(counts?.unknown));
  $('#wr-sum-assigned').text(formatNumber(counts?.assigned));

  $('#wr-summary-trucks').text(formatNumber(overview?.trucks));
  $('#wr-summary-weight').text(formatNumber(overview?.weight));
}

function updateWrAdvancedFilters(options){
  if (!options || typeof options !== 'object') return;
  const t = translations[currentLang] || translations.vi || {};  

  function refreshSelect(selector, values) {
    const $sel = $(selector);
    if (!$sel.length) return;

    const currentSet = new Set(parseMultiValueInput($sel.val()).map(v => v.toLowerCase()));
    $sel.empty();

    const list = Array.isArray(values)
      ? uniqueCasePreserveOrder(values)
      : [];

    if (!list.length) {
      const label = t.no_data_title || 'Không có dữ liệu';
      $sel.append(`<option value="" disabled>${esc(label)}</option>`);
      $sel.val([]);
      $sel.prop('disabled', true);
      return;
    }

    list.forEach(val => {
      const isSelected = currentSet.has(val.toLowerCase());
      const opt = new Option(val, val, false, isSelected);
      $sel.append(opt);
    });

    const selected = list.filter(val => currentSet.has(val.toLowerCase()));
    $sel.val(selected);
    $sel.prop('disabled', false);

    if (selector === '#wr-customers' && isRole('user')) {
      const sanitized = sanitizeWrCustomerSelection($sel.val());
      if (sanitized.length) {
        const normalizedList = list.map(val => val.toLowerCase());
        const sanitizedExisting = sanitized.filter(name => normalizedList.includes(name.toLowerCase()));
        const finalSelection = sanitizedExisting.length ? sanitizedExisting : sanitized;
        $sel.val(finalSelection);
      } else {
        const allowed = getWrAllowedCustomers();
        if (allowed.length) {
          const normalizedList = list.map(val => val.toLowerCase());
          const allowedExisting = allowed.filter(name => normalizedList.includes(name.toLowerCase()));
          const finalSelection = allowedExisting.length ? allowedExisting : allowed;
          $sel.val(finalSelection);
        } else {
          $sel.val([]);
        }
      }
    }
  }

  refreshSelect('#wr-contracts', options.contracts);
  refreshSelect('#wr-customers', options.customers);
}

function reloadWrTables(){
  if (wrReloadTimer) clearTimeout(wrReloadTimer);
  wrReloadTimer = setTimeout(() => {
    if ($.fn.DataTable.isDataTable('#wr-result-table')) wrResultTable.ajax.reload();
    if ($.fn.DataTable.isDataTable('#wr-unknown-table')) wrUnknownTable.ajax.reload();
    wrReloadTimer = null;
  }, 200);
}

function deleteWrRows(table){
  const ids = [];
  table.rows('.selected').every(function(){ const d=this.data(); if(d && d.ID) ids.push(d.ID); });
  const t = translations[currentLang] || translations.vi || {};
  if (!ids.length) { Swal.fire(t.wr_no_row_selected_title || 'Chưa chọn dòng', t.wr_no_row_selected_message || 'Hãy tick các dòng cần xoá.', 'info'); return; }
  Swal.fire({icon:'warning', title: t.wr_delete_confirm_title || 'Xoá các mục đã chọn?', showCancelButton:true})
    .then(r => {
      if (!r.isConfirmed) return;
      const t2 = translations[currentLang] || translations.vi || {};
      const baseLoadingTitle = t2.wr_deleting_loading || 'Đang xoá...';
      showLoading(baseLoadingTitle);

      const batches = chunkWrIds(ids, WR_DELETE_BATCH_SIZE);
      const totalBatches = batches.length;
      let lastMessage = '';

      const updateProgressTitle = currentBatch => {
        if (totalBatches <= 1) return;
        const template = t2.wr_deleting_loading_progress;
        const progressTitle = template
          ? template.replace('{current}', currentBatch).replace('{total}', totalBatches)
          : `${baseLoadingTitle} (${currentBatch}/${totalBatches})`;
        Swal.update({ title: progressTitle });
      };

      const processBatch = index => {
        if (index >= totalBatches) {
          Swal.close();
          const t3 = translations[currentLang] || translations.vi || {};
          const successMessage = lastMessage || t3.wr_delete_success_message || t3.wr_delete_success || 'Đã xoá các mục đã chọn.';
          Swal.fire(t3.success_title || 'Thành công', successMessage, 'success');
          reloadWrTables();
          return;
        }

        updateProgressTitle(index + 1);

        google.script.run
          .withSuccessHandler(msg => {
            if (msg) lastMessage = msg;
            processBatch(index + 1);
          })
          .withFailureHandler(err => {
            Swal.close();
            showError(err);
          })
          .deleteWeighResults(batches[index], userSession.token);
      };

      if (!batches.length) {
        Swal.close();
        return;
      }

      processBatch(0);
    });
}

function exportWrTable(table, name){
  if (!table) return;
  const t = translations[currentLang] || translations.vi || {};  
  const settings = table.settings();
  if (!settings || !settings.length) return;

  const init = typeof table.settings().init === 'function' ? table.settings().init() : null;
  let colDefs = [];
  if (init && Array.isArray(init.columns)) {
    colDefs = init.columns;
  } else {
    colDefs = $(table.table().node()).data('wrColumns') || [];
  }
  const visibleIdx = table.columns(':visible').indexes().toArray()
    .filter(i => !$(table.column(i).header()).hasClass('no-export'));
  if (!visibleIdx.length) {
    Swal.fire(t.wr_no_export_columns_title || 'Không có cột để xuất', t.wr_no_export_columns_message || 'Vui lòng hiển thị ít nhất 1 cột trước khi xuất Excel.', 'info');
    return;
  }

  const headers = visibleIdx.map(i => $(table.column(i).header()).text().trim());
  const searchValue = table.search() || '';
  const order = (table.order() || []).map(([column, dir]) => ({ column, dir }));

  const info = (typeof table.page === 'function' && typeof table.page.info === 'function')
    ? table.page.info()
    : null;
  const settingsObj = (settings && settings.length) ? settings[0] : null;
  let totalRecords = null;
  if (settingsObj && typeof settingsObj._iRecordsDisplay === 'number') {
    totalRecords = settingsObj._iRecordsDisplay;
  } else if (info && typeof info.recordsDisplay === 'number') {
    totalRecords = info.recordsDisplay;
  } else {
    const dataApi = table.rows({ search: 'applied' }).data();
    totalRecords = dataApi && typeof dataApi.length === 'number' ? dataApi.length : 0;
  }

  if (!totalRecords) {
    Swal.fire(t.no_data_title || 'Không có dữ liệu', t.wr_no_matching_data_message || 'Không có bản ghi phù hợp với bộ lọc hiện tại.', 'info');
    return;
  }

  const reqLength = Math.max(0, Number(totalRecords));

  const extra = {};
  const tableId = table.table().node().id;
  if (tableId === 'wr-unknown-table') {
    extra.onlyUnknown = true;
  } else if (tableId === 'wr-result-table') {
    extra.excludeUnknown = true;
  }

  showLoading(t.wr_exporting_data || 'Đang xuất dữ liệu...');

  const req = {
    draw: 0,
    start: 0,
    length: reqLength,
    search: { value: searchValue },
    order: order,
    sessionToken: userSession.token,
    filter: getWrFilters(),
    ...extra
  };

  callServerWithRetry('getWeighResultData', [req], {
    attempts: 3,
    initialDelay: 700,
    onSuccess: res => {
      Swal.close();
      const rows = (res && Array.isArray(res.data)) ? res.data : [];
      if (!rows.length) {
        const t2 = translations[currentLang] || translations.vi || {};
        Swal.fire(t2.no_data_title || 'Không có dữ liệu', t2.wr_no_matching_data_message || 'Không có bản ghi phù hợp với bộ lọc hiện tại.', 'info');
        return;
      }

      const data = rows.map(row => visibleIdx.map(i => {
        const def = colDefs[i] || {};
        const key = def.data;
        if (typeof key === 'function') {
          try { return key(row); }
          catch (err) { return ''; }
        }
        return key ? (row[key] ?? '') : '';
      }));

      const sheetData = [headers, ...data];
      const sheet = XLSX.utils.aoa_to_sheet(sheetData);

      const range = XLSX.utils.decode_range(sheet['!ref']);
      const border = {
        top: { style: 'thin', color: { rgb: '000000' } },
        bottom: { style: 'thin', color: { rgb: '000000' } },
        left: { style: 'thin', color: { rgb: '000000' } },
        right: { style: 'thin', color: { rgb: '000000' } }
      };
      for (let R = range.s.r; R <= range.e.r; R++) {
        for (let C = range.s.c; C <= range.e.c; C++) {
          const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
          const cell = sheet[cellRef];
          if (!cell) continue;
          cell.s = cell.s || {};
          cell.s.border = border;
        }
      }

      const colWidths = headers.map((header, idx) => {
        let maxLen = header ? header.length : 0;
        for (let r = 0; r < data.length; r++) {
          const val = data[r][idx];
          const len = (val == null) ? 0 : String(val).length;
          if (len > maxLen) maxLen = len;
        }
        const wch = Math.min(Math.max(maxLen + 2, 10), 60);
        return { wch };
      });
      sheet['!cols'] = colWidths;

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, sheet, name);
      XLSX.writeFile(wb, `${name}_${new Date().toISOString().slice(0,10)}.xlsx`);
    },
    onFailure: err => {
      Swal.close();
      showError(err);
    }
  });
}

function normalizeDtResponse(res, draw){
  if (!res || typeof res !== 'object') {
    return { draw, recordsTotal:0, recordsFiltered:0, data:[] };
  }
  return {
    draw: Number(res.draw ?? draw ?? 1),
    recordsTotal: Number(res.recordsTotal ?? 0),
    recordsFiltered: Number(res.recordsFiltered ?? res.recordsTotal ?? 0),
    data: Array.isArray(res.data) ? res.data : []
  };
}

function buildWeighResultTables(isAdmin) {
  const headers = ['ID','No.','W.ID','Weighing Type','TicketID','Truck No','Date In','Time In','Date Out','Time Out','Weight In','Weight Out','Net Weight','Product Name','CoalSource','ProductionCode','Customer Name','DriverName','Id/Passport','CargoLotNo','CargoName','CargoCompany','PackUnit','PackQtt','OrderNo','ContractNo','InvoiceNo','CoNo','OVS_DMT','Plant','Trailer No','Truck Country','Truck Type','WeighStationCode','Note','CreateUser','Transportation Company','Changed Date','Changed Time','Username'];

  if ($.fn.DataTable.isDataTable('#wr-result-table')) $('#wr-result-table').DataTable().destroy();
  const resWrap = $('#wr-result-table').parent();

  const timeOnlyColumns = new Set(['Time In','Time Out','Changed Time']);

  let cols = [];
  if (isAdmin) {
    const selectAllLabel = (translations[currentLang] && translations[currentLang].select_all_checkbox) || 'Select all';
    cols.push({
      data: null,
      title: `<input type="checkbox" class="form-check-input" id="wr-select-all" aria-label="${selectAllLabel}" title="${selectAllLabel}">`,
      orderable: false,
      className: 'no-export text-center',
      render: () => `<input type="checkbox" class="row-checkbox form-check-input">`
    });
    cols.push({ data:null, title: translations[currentLang].action_column || 'Hành động', orderable:false, className:'no-export text-center', render:() => `<button class="btn btn-warning btn-sm wr-edit"><i class="fas fa-edit"></i></button>`});
  }
  cols = cols.concat(headers.map(h => {
    if (h === 'No.' || h === 'W.ID') {
      return { data: row => row[h], title: h };
    }
    const colDef = { data: h, title: h };
    if (timeOnlyColumns.has(h)) {
      colDef.render = (data, type) => {
        if (type === 'display' || type === 'filter') {
          return formatTimeForDisplay(data);
        }
        return data;
      };
    }
    return colDef;
  }));

  const resTable = `<table id="wr-result-table" class="table table-bordered table-striped" style="width:100%"><thead><tr>${cols.map(c=>`<th>${c.title||''}</th>`).join('')}</tr></thead><tbody></tbody></table>`;
  resWrap.html(resTable);
  $('#wr-result-table').data('wrColumns', cols);  

  wrResultTable = $('#wr-result-table').DataTable({
    processing:true,
    serverSide:true,
    pageLength:50,
    autoWidth:false,
    deferRender:true,
    columnDefs:[{ targets:'_all', className:'text-nowrap' }],
    ajax: function(dtReq, callback){
      const req = {
        draw: dtReq.draw,
        start: dtReq.start,
        length: dtReq.length,
        search: dtReq.search,
        order: dtReq.order,
        sessionToken: userSession.token,
        filter: getWrFilters(),
        excludeUnknown: true
      };
      callServerWithRetry('getWeighResultData', [req], {
        attempts: 3,
        initialDelay: 700,
        onSuccess: res => {
          updateWrSummary(res && res.counts, res && res.summary);
          if (res && res.options) updateWrAdvancedFilters(res.options);
          const dtRes = {
            draw: Number(res && res.draw) || dtReq.draw || 0,
            recordsTotal: Number(res && res.recordsTotal) || 0,
            recordsFiltered: Number(res && res.recordsFiltered) || 0,
            data: (res && res.data) || []
          };
          callback(dtRes);
        },
        onFailure: err => {
          showError(err);
          callback({ draw: dtReq.draw || 0, recordsTotal: 0, recordsFiltered: 0, data: [] });
        }
      });
    },
    columns: cols,
    drawCallback:function(){ this.api().columns.adjust(); }    
  });
  wrResultTable.columns.adjust();

  $('#wr-result-table tbody').off('click','.wr-edit').on('click','.wr-edit', function(){
    if (!isAdmin) return;
    const row = wrResultTable.row($(this).closest('tr')).data();
    if (!row) return;
    showWrEditDialog(row);
  });

  if (isAdmin) {
    const $wrDelete = $('#wr-delete');
    const $wrSelectAll = $('#wr-select-all');

    const updateResultSelectionState = () => {
      if (!wrResultTable) return;
      const nodes = wrResultTable.rows({ page: 'current' }).nodes();
      const $rows = $(nodes);
      const selectedCount = $rows.filter('.selected').length;
      const totalRows = $rows.length;
      const disableDelete = selectedCount === 0;
      if ($wrDelete.length) {
        $wrDelete.prop('disabled', disableDelete).toggleClass('disabled', disableDelete);
      }
      if ($wrSelectAll.length) {
        if (!totalRows) {
          $wrSelectAll.prop({ checked: false, indeterminate: false });
        } else if (selectedCount === totalRows) {
          $wrSelectAll.prop({ checked: true, indeterminate: false });
        } else if (selectedCount === 0) {
          $wrSelectAll.prop({ checked: false, indeterminate: false });
        } else {
          $wrSelectAll.prop({ checked: false, indeterminate: true });
        }
      }
    };

    $('#wr-result-table').off('draw.dt.selection').on('draw.dt.selection', () => updateResultSelectionState());

    if ($wrSelectAll.length) {
      $wrSelectAll.prop({ checked: false, indeterminate: false });
      $wrSelectAll.off('change').on('change', function(){
        const isChecked = $(this).prop('checked');
        const nodes = wrResultTable.rows({ page: 'current' }).nodes();
        const $rows = $(nodes);
        $rows.toggleClass('selected', isChecked);
        $rows.find('.row-checkbox').prop('checked', isChecked);
        updateResultSelectionState();
      });
    }

    $('#wr-result-table tbody').off('change','.row-checkbox').on('change','.row-checkbox', function(){
      $(this).closest('tr').toggleClass('selected', this.checked);
      updateResultSelectionState();
    });

    updateResultSelectionState();
  } else {
    $('#wr-result-table tbody').off('change','.row-checkbox');
  }

  if (isAdmin) {
    if ($.fn.DataTable.isDataTable('#wr-unknown-table')) $('#wr-unknown-table').DataTable().destroy();
    const uWrap = $('#wr-unknown-table').parent();
    const uHeaders = ['ID','Truck No','Date Out','Net Weight','Customer Name','ContractNo','Transportation Company','Changed Date','Changed Time','Username'];
    const unknownSelectAllLabel = (translations[currentLang] && translations[currentLang].select_all_checkbox) || 'Select all';    
    let uCols = [
      { data:null, title:`<input type="checkbox" class="form-check-input" id="wru-select-all" aria-label="${unknownSelectAllLabel}" title="${unknownSelectAllLabel}">`, orderable:false, className:'no-export text-center', render:() => `<input type="checkbox" class="row-checkbox form-check-input">`},
      { data:null, title: translations[currentLang].action_column || 'Hành động', orderable:false, className:'no-export text-center', render:() => `<button class="btn btn-warning btn-sm wru-edit"><i class="fas fa-edit"></i></button>`}
    ];
    uCols = uCols.concat(uHeaders.map(h => {
      const colDef = { data: h, title: h };
      if (timeOnlyColumns.has(h)) {
        colDef.render = (data, type) => {
          if (type === 'display' || type === 'filter') {
            return formatTimeForDisplay(data);
          }
          return data;
        };
      }
      return colDef;
    }));
    const uTable = `<table id="wr-unknown-table" class="table table-bordered table-striped" style="width:100%"><thead><tr>${uCols.map(c=>`<th>${c.title||''}</th>`).join('')}</tr></thead><tbody></tbody></table>`;
    uWrap.html(uTable);
    $('#wr-unknown-table').data('wrColumns', uCols);

    wrUnknownTable = $('#wr-unknown-table').DataTable({
      processing:true,
      serverSide:true,
      pageLength:50,
      autoWidth:false,
      deferRender:true,
      columnDefs:[{ targets:'_all', className:'text-nowrap' }],
  
      ajax: function(dtReq, callback){
        const req = {
          draw: dtReq.draw,
          start: dtReq.start,
          length: dtReq.length,
          search: dtReq.search,
          order: dtReq.order,
          sessionToken: userSession.token,
          filter: getWrFilters(),
          onlyUnknown: true
        };
        callServerWithRetry('getWeighResultData', [req], {
          attempts: 3,
          initialDelay: 700,
          onSuccess: res => {
            updateWrSummary(res && res.counts, res && res.summary);
            if (res && res.options) updateWrAdvancedFilters(res.options);
            const dtRes = {
              draw: Number(res && res.draw) || dtReq.draw || 0,
              recordsTotal: Number(res && res.recordsTotal) || 0,
              recordsFiltered: Number(res && res.recordsFiltered) || 0,
              data: (res && res.data) || []
            };
            callback(dtRes);
          },
          onFailure: err => {
            showError(err);
            callback({ draw: dtReq.draw || 0, recordsTotal: 0, recordsFiltered: 0, data: [] });
          }
        });
      },
      columns: uCols,
      drawCallback:function(){ this.api().columns.adjust(); }
    });
    wrUnknownTable.columns.adjust();

    const $unknownDelete = $('#wr-unknown-delete');
    const $unknownSelectAll = $('#wru-select-all');

    const updateUnknownSelectionState = () => {
      if (!wrUnknownTable) return;
      const nodes = wrUnknownTable.rows({ page: 'current' }).nodes();
      const $rows = $(nodes);
      const selectedCount = $rows.filter('.selected').length;
      const totalRows = $rows.length;
      const disableDelete = selectedCount === 0;
      if ($unknownDelete.length) {
        $unknownDelete.prop('disabled', disableDelete).toggleClass('disabled', disableDelete);
      }
      if ($unknownSelectAll.length) {
        if (!totalRows) {
          $unknownSelectAll.prop({ checked: false, indeterminate: false });
        } else if (selectedCount === totalRows) {
          $unknownSelectAll.prop({ checked: true, indeterminate: false });
        } else if (selectedCount === 0) {
          $unknownSelectAll.prop({ checked: false, indeterminate: false });
        } else {
          $unknownSelectAll.prop({ checked: false, indeterminate: true });
        }
      }
    };

    $('#wr-unknown-table').off('draw.dt.selection').on('draw.dt.selection', () => updateUnknownSelectionState());

    if ($unknownSelectAll.length) {
      $unknownSelectAll.prop({ checked: false, indeterminate: false });
      $unknownSelectAll.off('change').on('change', function(){
        const isChecked = $(this).prop('checked');
        const nodes = wrUnknownTable.rows({ page: 'current' }).nodes();
        const $rows = $(nodes);
        $rows.toggleClass('selected', isChecked);
        $rows.find('.row-checkbox').prop('checked', isChecked);
        updateUnknownSelectionState();
      });
    }

    $('#wr-unknown-table tbody').off('change','.row-checkbox').on('change','.row-checkbox', function(){
      $(this).closest('tr').toggleClass('selected', this.checked);
    });
      updateUnknownSelectionState();    

    $('#wr-unknown-table tbody').off('click','.wru-edit').on('click','.wru-edit', function(){
      const row = wrUnknownTable.row($(this).closest('tr')).data();
      if (!row) return;
      showWrEditDialog(row);
    });

    updateUnknownSelectionState();    
  }
}

function showWrEditDialog(row){
  const opts = ['Unknown', ...(window.__wrCompanyList || [])]
    .map(v => `<option value="${esc(v)}" ${v === (row['Transportation Company']||'') ? 'selected' : ''}>${esc(v)}</option>`)
    .join('');
  const t = translations[currentLang] || translations.vi || {};    
  Swal.fire({
    title: t.wr_update_company_title || 'Cập nhật đơn vị vận chuyển',
    html: `<select id="sw-wr-company" class="form-select">${opts}</select>`,
    focusConfirm:false,
    preConfirm: () => $('#sw-wr-company').val()
  }).then(res => {
    if (!res.isConfirmed) return;
    const t2 = translations[currentLang] || translations.vi || {};
    showLoading(t2.loading_updating || 'Đang cập nhật...');
    google.script.run
      .withSuccessHandler(msg => {
        Swal.close();
        const t3 = translations[currentLang] || translations.vi || {};
        Swal.fire(t3.success_title || 'Thành công', msg, 'success');
        reloadWrTables();
      })
      .withFailureHandler(showError)
      .updateWeighResultCompany({ ID: row.ID, 'Transportation Company': res.value }, userSession.token);
  });
}


$(document).off('click', '#total-list-exportBtn').on('click', '#total-list-exportBtn', exportTotalListExcel);
</script>
